<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SART - Sistema de Soporte y Reporte Tecnológico UNEFA</title>
    <style>
        /* --- VARIABLES --- */
        :root {
            --color-primary: #003366;
            --color-primary-dark: #002244;
            --color-secondary: #D4AF37;
            --color-danger: #ce1126;
            --color-success: #10B981;
            --color-warning: #f59e0b;
            --color-dark: #1f2937;
            --color-bg: #f3f4f6;
            --color-white: #ffffff;
            --color-text: #374151;
            --color-text-light: #9CA3AF;
            --border-color: #e5e7eb;

            --sidebar-width: 260px;
            --header-height: 60px;
            --radius: 8px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background-color: var(--color-bg); color: var(--color-text); height: 100vh; overflow: hidden; }

        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .w-full { width: 100%; }
        
        /* LOGIN STYLES */
        .login-wrapper { position: fixed; inset: 0; background-color: var(--color-primary); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-box { background: var(--color-white); padding: 1.5rem; border-radius: 12px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2); }
        .logos-container { display: flex; justify-content: center; gap: 20px; margin-bottom: 1.5rem; }
        .logo-img { height: 80px; width: auto; object-fit: contain; }
        .form-group { margin-bottom: 1rem; text-align: left; }
        .form-label { display: block; font-size: 0.8rem; font-weight: bold; color: var(--color-primary); margin-bottom: 0.25rem; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius); outline: none; transition: border 0.2s; background-color: white; font-size: 0.95rem; }
        input:focus, select:focus, textarea:focus { border-color: var(--color-secondary); box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2); }
        button { cursor: pointer; border: none; border-radius: var(--radius); font-weight: 600; padding: 0.75rem 1.2rem; transition: background 0.2s; font-size: 1rem; }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover { background-color: var(--color-primary-dark); }
        .btn-secondary { background-color: var(--color-white); border: 1px solid var(--border-color); color: var(--color-text); }
        .btn-secondary:hover { background-color: #f9fafb; }
        .btn-danger { background-color: var(--color-danger); color: white; }
        .btn-danger:hover { background-color: #a30e1e; }
        .error-msg { color: var(--color-danger); font-size: 0.85rem; margin-top: 1rem; min-height: 1.2rem; font-weight: bold; }

        /* APP LAYOUT */
        .app-layout { display: flex; height: 100%; }
        .sidebar { width: var(--sidebar-width); background-color: var(--color-primary); color: var(--color-white); display: flex; flex-direction: column; transition: transform 0.3s; z-index: 50; }
        .sidebar-header { height: var(--header-height); display: flex; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.2); font-weight: bold; letter-spacing: 1px; gap: 10px; font-size: 1.1rem; }
        .sidebar-logo-small { height: 28px; width: auto; }
        
        .sidebar-menu { list-style: none; padding-top: 1rem; flex: 1; }
        .nav-link { padding: 0.8rem 1.5rem; display: flex; align-items: center; gap: 12px; cursor: pointer; color: rgba(255,255,255,0.7); text-decoration: none; transition: 0.2s; font-size: 0.95rem; border-left: 4px solid transparent; }
        .nav-link:hover, .nav-link.active { background-color: rgba(212, 175, 55, 0.15); color: var(--color-secondary); border-left-color: var(--color-secondary); }
        .nav-icon { width: 20px; height: 20px; stroke-width: 2; stroke: currentColor; fill: none; stroke-linecap: round; stroke-linejoin: round; }
        
        .sidebar-footer { padding: 1rem; background-color: rgba(0,0,0,0.2); }
        .logout-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; width: 100%; justify-content: center; display: flex; align-items: center; gap: 8px; }
        .logout-btn:hover { background: rgba(255,255,255,0.2); }

        .main-content { flex: 1; display: flex; flex-direction: column; background-color: var(--color-bg); overflow: hidden; }
        .top-header { height: var(--header-height); background: var(--color-white); display: flex; align-items: center; justify-content: space-between; padding: 0 2rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .header-title { color: var(--color-primary); font-size: 1.25rem; font-weight: bold; }
        .content-area { padding: 2rem; overflow-y: auto; flex: 1; }

        /* DASHBOARD GRID */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-top: 1rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow); border-top: 4px solid transparent; display: flex; flex-direction: column; }
        .stat-card.blue { border-color: var(--color-primary); }
        .stat-card.green { border-color: var(--color-success); }
        .stat-card.gold { border-color: var(--color-secondary); }
        .stat-label { font-size: 0.8rem; text-transform: uppercase; color: var(--color-text-light); font-weight: bold; letter-spacing: 0.5px; }
        .stat-value { font-size: 2.2rem; font-weight: 800; color: var(--color-text); margin-top: 0.5rem; }

        /* TABLAS Y PANELES DE DATOS */
        .filter-panel { background: white; padding: 1rem 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 1.5rem; display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap; }
        .search-box { flex: 1; min-width: 200px; }
        .data-panel { background: white; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border-color); display: flex; flex-direction: column; overflow-y: auto; height: 100%; }
        .table-container { overflow: auto; flex: 1; }
        
        .custom-table { width: 100%; border-collapse: collapse; text-align: left; font-size: 0.9rem; table-layout: fixed; }
        .custom-table thead { background-color: var(--color-primary); color: white; position: sticky; top: 0; z-index: 10; }
        .custom-table th { padding: 1rem; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; white-space: nowrap; }
        .custom-table td { padding: 1rem; border-bottom: 1px solid var(--border-color); color: var(--color-text); vertical-align: middle; }
        .custom-table tbody tr:hover { background-color: #f9fafb; }
        .text-muted { color: #9ca3af; font-style: italic; text-align: center; padding: 2rem; }

        /* Estilo Específico para Tablas: Altura Fija de Fila */
        .custom-table tbody tr { height: 60px; }

        /* UTILIDADES TABLA */
        .cell-truncate { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; display: block; }
        .cell-multiline { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; white-space: normal; }

        .badge { padding: 0.25rem 0.75rem; border-radius: 99px; font-size: 0.75rem; font-weight: 700; display: inline-block; text-align: center; min-width: 80px; }
        .badge.operativo { background-color: #D1FAE5; color: #059669; border: 1px solid #6EE7B7; }
        .badge.pending { background-color: #FEF3C7; color: #D97706; border: 1px solid #FCD34D; }
        .badge.unrepaired { background-color: #fca5a5; color: #991b1b; border: 1px solid #f87171; }

        /* ACCIONES */
        .action-btn { background: none; border: none; cursor: pointer; padding: 5px; border-radius: 4px; transition: background 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .action-btn:hover { background-color: #f3f4f6; }
        .action-btn.edit { color: var(--color-primary); }
        .action-btn.check { color: var(--color-success); }
        .action-btn.view { color: #4B5563; }
        .action-btn.delete { color: var(--color-danger); }
        .actions-cell { display: flex; gap: 8px; justify-content: center; }

        /* PAGINACIÓN */
        .pagination-controls { padding: 1rem; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .page-btn { padding: 0.5rem 1rem; border: 1px solid var(--border-color); background: white; cursor: pointer; border-radius: 4px; font-size: 0.9rem; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-btn:hover:not(:disabled) { background: #f3f4f6; }
        .page-info { font-size: 0.9rem; color: var(--color-text-light); display: flex; align-items: center; gap: 8px; }
        
        .page-input { width: 40px; padding: 0.25rem; text-align: center; border: 1px solid var(--border-color); border-radius: 4px; font-weight: bold; color: var(--color-primary); }

        /* MODAL */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-container { background: white; width: 90%; max-width: 700px; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); transform: translateY(20px); transition: transform 0.2s; display: flex; flex-direction: column; max-height: 85vh; }
        .modal-overlay.open .modal-container { transform: translateY(0); }
        .modal-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 1.1rem; font-weight: 700; color: var(--color-primary); }
        .btn-close-modal { background: transparent; border: none; font-size: 1.5rem; line-height: 1; cursor: pointer; color: var(--color-text-light); }
        .modal-body { padding: 1.5rem; overflow-y: auto; }
        .modal-footer { padding: 1.25rem 1.5rem; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 1rem; background-color: #f9fafb; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; }

        /* FORMULARIOS MODAL */
        .section-title { font-size: 0.9rem; color: var(--color-text-light); font-weight: 700; text-transform: uppercase; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 1rem; margin-top: 1rem; }
        .section-title:first-child { margin-top: 0; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
        
        .char-counter { text-align: right; font-size: 0.8rem; color: var(--color-text-light); margin-top: 0.25rem; font-variant-numeric: tabular-nums; }
        .info-block { background: #f3f4f6; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.9rem; }
        
        /* DETALLES DE VISUALIZACIÓN */
        .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem; margin-bottom: 1.5rem; }
        .detail-item { display: flex; flex-direction: column; }
        .detail-full { grid-column: 1 / -1; }
        .detail-label { font-size: 0.7rem; color: var(--color-text-light); text-transform: uppercase; font-weight: 700; margin-bottom: 0.35rem; letter-spacing: 0.5px; }
        
        .detail-value { 
            font-size: 0.95rem; 
            color: var(--color-dark); 
            font-weight: 500; 
            border-bottom: 1px solid #e5e7eb; 
            padding-bottom: 0.25rem; 
            min-height: 1.4rem;
            white-space: pre-wrap; 
            word-wrap: break-word;
            overflow-wrap: break-word; 
            word-break: break-word;
        }
        
        /* Header Actions */
        .header-actions { display: flex; gap: 10px; align-items: center; }
        .btn-report-filter { background-color: var(--color-secondary); color: white; padding: 0.4rem 0.8rem; font-size: 0.85rem; border-radius: 4px; border:none; cursor: pointer; font-weight: bold; }
        .btn-report-full { background-color: var(--color-danger); color: white; padding: 0.4rem 0.8rem; font-size: 0.85rem; border-radius: 4px; border:none; cursor: pointer; font-weight: bold; }

        /* --- ESTILOS GESTIÓN DE DATOS (NUEVO) --- */
        .dm-layout { display: flex; height: 100%; gap: 1.5rem; }
        .dm-sidebar { width: 220px; background: var(--color-white); border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border-color); display: flex; flex-direction: column; overflow: hidden; height: 100%; overflow-y: auto; }
        .dm-menu-item { padding: 12px 15px; border-bottom: 1px solid var(--color-bg); cursor: pointer; font-size: 0.9rem; color: var(--color-text); transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .dm-menu-item:hover { background-color: #f9fafb; color: var(--color-primary); }
        .dm-menu-item.active { background-color: #eff6ff; color: var(--color-primary); font-weight: 700; border-left: 4px solid var(--color-primary); }
        
        .dm-container { flex: 1; display: flex; flex-direction: column; background: var(--color-white); border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border-color); overflow: hidden; height: 100%; }
        
        .crud-header { padding: 1rem; gap: 1rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: #fafafa; }
        .crud-content { flex: 1; overflow-y: auto; padding: 0; display: flex; flex-direction: column; }

        /* Input Group Toggle */
        .input-group-toggle { display: flex; align-items: center; gap: 5px; }
        .input-group-toggle select, .input-group-toggle input { flex: 1; }
        
        /* VIEWER RESTRICTIONS */
        .hidden-for-viewer { display: none !important; }
    </style>
</head>
<body>

    <!-- === LOGIN VIEW === -->
    <div id="login-view" class="login-wrapper">
        <div class="login-box">
            <div class="logos-container">
                <img src="/static/public/logo-unefa.avif" alt="UNEFA" class="logo-img">
            </div>
            <h2 style="color:var(--color-primary); margin-bottom: 0.5rem; font-weight: 800;">SART</h2>
            <p style="color:var(--color-text-light); margin-bottom: 2rem; font-size: 0.95rem;">Sistema de Soporte Tecnológico</p>
            <form id="login-form">
                <div class="form-group">
                    <label class="form-label">Rol de Usuario</label>
                    <select id="role" required>
                        <option value="admin">Administrador</option>
                        <option value="viewer">Consultor</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Usuario</label>
                    <input type="text" id="username" placeholder="admin / user" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Contraseña</label>
                    <input type="password" id="password" placeholder="••••" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 1rem;">INGRESAR AL SISTEMA</button>
                <div id="login-error" class="error-msg"></div>
            </form>
        </div>
    </div>

    <!-- === APP VIEW === -->
    <div id="app-view" class="app-layout hidden">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="/static/public/logo-unefa.avif" class="sidebar-logo-small">
                <span>SART</span>
            </div>
            <ul class="sidebar-menu">
                <li><a class="nav-link active" onclick="app.navigate('home')"><svg class="nav-icon" viewBox="0 0 24 24"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg><span>Inicio</span></a></li>
                <li><a class="nav-link" onclick="app.navigate('workshop')"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg><span>Taller</span></a></li>
                <li><a class="nav-link" onclick="app.navigate('inventory')"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg><span>Inventario</span></a></li>
                <li><a class="nav-link" onclick="app.navigate('history')"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg><span>Historial</span></a></li>
                <li><a class="nav-link" onclick="app.navigate('data')"><svg class="nav-icon" viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s 9-1.34 9-3V5"/></svg><span>Gestión de Datos</span></a></li>
                <li data-role-restricted="admin"><a class="nav-link" onclick="app.navigate('settings')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users-round-icon lucide-users-round"><path d="M18 21a8 8 0 0 0-16 0"/><circle cx="10" cy="8" r="5"/><path d="M22 20c0-3.37-2-6.5-4-8a5 5 0 0 0-.45-8.3"/></svg><span>Gestión de Usuarios</span></a></li>
            </ul>
            <div class="sidebar-footer">
                <button onclick="app.logout()" class="logout-btn"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>Cerrar Sesión</button>
            </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <main class="main-content">
            <header class="top-header">
                <h2 style="color:var(--color-primary);" id="page-title">Inicio</h2>
                <div style="text-align: right;">
                    <div id="user-display-name" style="font-weight: 700; color: var(--color-primary); font-size: 0.95rem;">Usuario</div>
                    <div id="user-display-role" style="font-size: 0.8rem; color: var(--color-text-light);">Rol</div>
                </div>
            </header>

            <div class="content-area">
                
                <!-- SECCIÓN 1: DASHBOARD (HOME) -->
                <div id="section-home" class="section-view">
                    <h3 style="margin-bottom: 1.5rem; color: var(--color-text); font-weight: 600;">Resumen General</h3>
                    <div class="stats-grid">
                        <div class="stat-card blue">
                            <span class="stat-label">Equipos en Taller</span>
                            <div id="kpi-workshop" class="stat-value">--</div>
                        </div>
                        <div class="stat-card green">
                            <span class="stat-label">Reparados (Total)</span>
                            <div id="kpi-repaired" class="stat-value">--</div>
                        </div>
                        <div class="stat-card gold">
                            <span class="stat-label">Ingresos este Mes</span>
                            <div id="kpi-month" class="stat-value">--</div>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN 2: TALLER -->
                <div id="section-workshop" class="section-view hidden">
                    <div class="filter-panel">
                        <div class="search-box" style="flex-basis: 100%; margin-bottom: 0.5rem;">
                            <label class="form-label">Búsqueda Global (Serial, Código, Marca)</label>
                            <input type="text" id="wk-search" placeholder="Escriba para buscar..." onkeyup="app.debounceLoadWorkshop()">
                        </div>
                        <div style="flex: 1; min-width: 120px;">
                            <label class="form-label">Tipo</label>
                            <select id="wk-filter-type" onchange="app.loadWorkshop(1)"></select>
                        </div>
                        <div style="flex: 1; min-width: 120px;">
                            <label class="form-label">Marca</label>
                            <select id="wk-filter-brand" onchange="app.loadWorkshop(1)"></select>
                        </div>
                        <div style="flex: 1; min-width: 120px;">
                            <label class="form-label">SO</label>
                            <select id="wk-filter-os" onchange="app.loadWorkshop(1)"></select>
                        </div>
                        <div style="flex: 1; min-width: 120px;">
                            <label class="form-label">CPU</label>
                            <select id="wk-filter-cpu" onchange="app.loadWorkshop(1)"></select>
                        </div>
                        <div style="flex: 1; min-width: 120px;">
                            <label class="form-label">RAM</label>
                            <select id="wk-filter-ram" onchange="app.loadWorkshop(1)"></select>
                        </div>
                        <div style="flex: 0 0 auto;" class="admin-only">
                             <button class="btn-primary" onclick="app.openModal('add-ticket')">Nuevo Ingreso</button>
                        </div>
                    </div>
                    <div class="data-panel">
                        <div class="table-container">
                            <table class="custom-table" id="workshop-table">
                                <colgroup>
                                    <col style="width: 50px;">
                                    <col style="width: 110px;">
                                    <col style="width: 120px;">
                                    <col style="width: 20%;">
                                    <col style="width: 20%;">
                                    <col style="width: auto;">
                                    <col style="width: 140px;" class="admin-only">
                                </colgroup>
                                <thead>
                                    <tr>
                                        <th>N°</th>
                                        <th>Ingreso</th>
                                        <th>Tipo</th>
                                        <th>Marca / Modelo</th>
                                        <th>Código / Serial</th>
                                        <th>Falla Reportada</th>
                                        <th style="text-align: center;" class="admin-only">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Rows -->
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination-controls">
                            <button id="wk-btn-prev" class="page-btn" onclick="app.prevPage()">Anterior</button>
                            <div class="page-info">
                                <span>Página</span>
                                <input type="text" id="wk-page-input" class="page-input" value="1" maxlength="1" oninput="app.inputPage(this)">
                                <span id="wk-total-info">de 1</span>
                            </div>
                            <button id="wk-btn-next" class="page-btn" onclick="app.nextPage()">Siguiente</button>
                        </div>
                    </div>
                </div>
                
                <!-- SECCIÓN 3: INVENTARIO -->
                <div id="section-inventory" class="section-view hidden">
                    <div class="filter-panel">
                        <div class="search-box" style="flex-basis: 100%; margin-bottom: 0.5rem;">
                            <label class="form-label">Búsqueda Global (Serial, Código, Marca, Ubicación)</label>
                            <input type="text" id="inv-search" placeholder="Escriba para buscar..." onkeyup="app.debounceLoadInventory()">
                        </div>
                        <div style="flex: 1; min-width: 120px;">
                            <label class="form-label">Tipo</label>
                            <select id="inv-filter-type" onchange="app.loadInventory(1)"></select>
                        </div>
                        <div style="flex: 1; min-width: 120px;">
                            <label class="form-label">Marca</label>
                            <select id="inv-filter-brand" onchange="app.loadInventory(1)"></select>
                        </div>
                        <div style="flex: 1; min-width: 120px;">
                            <label class="form-label">SO</label>
                            <select id="inv-filter-os" onchange="app.loadInventory(1)"></select>
                        </div>
                        <div style="flex: 1; min-width: 120px;">
                            <label class="form-label">Estado</label>
                            <select id="inv-filter-status" onchange="app.loadInventory(1)">
                                <option value="">Todos</option>
                                <option value="operational">Operativo</option>
                                <option value="workshop">En Taller</option>
                            </select>
                        </div>
                        <div style="flex: 0 0 auto;" class="admin-only">
                             <button class="btn-primary" onclick="app.openModal('add-device')">+ Nuevo Equipo</button>
                        </div>
                    </div>
                    <div class="data-panel">
                        <div class="table-container">
                            <table class="custom-table" id="inventory-table">
                                <colgroup>
                                    <col style="width: 50px;">
                                    <col style="width: 120px;">
                                    <col style="width: 15%;">
                                    <col style="width: 20%;">
                                    <col style="width: 100px;">
                                    <col style="width: 125px;">
                                    <col style="width: 100px;">
                                    <col style="width: 140px;" class="admin-only">
                                </colgroup>
                                <thead>
                                    <tr>
                                        <th>N°</th>
                                        <th>Tipo</th>
                                        <th>Marca / Modelo</th>
                                        <th>Ubicación</th>
                                        <th>Código</th>
                                        <th>Serial</th>
                                        <th>Estado</th>
                                        <th style="text-align:center;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Rows -->
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination-controls">
                            <button id="inv-btn-prev" class="page-btn" onclick="app.prevPageLegacy()">Anterior</button>
                            <span id="inv-page-info" class="page-info">Página 1</span>
                            <button id="inv-btn-next" class="page-btn" onclick="app.nextPageLegacy()">Siguiente</button>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN 4: HISTORIAL -->
                <div id="section-history" class="section-view hidden">
                    <div class="filter-panel">
                        <div class="search-box" style="flex-basis: 100%; margin-bottom: 0.5rem;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 0.25rem;">
                                <label class="form-label" style="margin-bottom:0;">Búsqueda Global (Serial, Código, Marca, Falla)</label>
                                <div class="header-actions">
                                    <button class="btn-report-filter" onclick="app.printReport('filtered')">Exportar reporte con filtros</button>
                                    <button class="btn-report-full" onclick="app.printReport('full')">Exportar reporte completo</button>
                                </div>
                            </div>
                            <input type="text" id="hist-search" placeholder="Escriba para buscar..." onkeyup="app.debounceLoadHistory()">
                        </div>
                        <div style="flex: 1; min-width: 120px;">
                            <label class="form-label">Tipo</label>
                            <select id="hist-filter-type" onchange="app.loadHistory(1)"></select>
                        </div>
                        <div style="flex: 1; min-width: 120px;">
                            <label class="form-label">Marca</label>
                            <select id="hist-filter-brand" onchange="app.loadHistory(1)"></select>
                        </div>
                        <div style="flex: 1; min-width: 120px;">
                            <label class="form-label">Estado</label>
                            <select id="hist-filter-status" onchange="app.loadHistory(1)">
                                <option value="">Todos</option>
                                <option value="repaired">Reparado</option>
                                <option value="unrepaired">No Reparado</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 120px;">
                            <label class="form-label">Después de</label>
                            <input type="date" id="hist-date-after" onchange="app.validateDates(); app.loadHistory(1)">
                        </div>
                        <div style="flex: 1; min-width: 120px;">
                            <label class="form-label">Antes de</label>
                            <input type="date" id="hist-date-before" onchange="app.validateDates(); app.loadHistory(1)">
                        </div>
                        <div style="flex: 0 0 auto;">
                             <button class="btn-secondary" onclick="app.clearHistoryFilters()">Limpiar Filtros</button>
                        </div>
                    </div>
                    
                    <div class="data-panel">
                        <div class="table-container">
                            <table class="custom-table" id="history-table">
                                <colgroup>
                                    <col style="width: 50px;">
                                    <col style="width: 110px;">
                                    <col style="width: 80px;">
                                    <col style="width: 13%;">
                                    <col style="width: 13%;">
                                    <col style="width: auto;">
                                    <col style="width: 140px;">
                                    <col style="width: 130px;" class="admin-only">
                                </colgroup>
                                <thead>
                                    <tr>
                                        <th>N°</th>
                                        <th>Salida</th>
                                        <th>Tipo</th>
                                        <th>Marca / Modelo</th>
                                        <th>Código / Serial</th>
                                        <th>Detalles de Salida</th>
                                        <th>Estado</th>
                                        <th style="text-align:center;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Rows -->
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination-controls">
                            <button id="hist-btn-prev" class="page-btn" onclick="app.prevPageHistory()">Anterior</button>
                            <span id="hist-page-info" class="page-info">Página 1</span>
                            <button id="hist-btn-next" class="page-btn" onclick="app.nextPageHistory()">Siguiente</button>
                        </div>
                    </div>
                </div>
                
                 <!-- SECCIÓN 5: GESTIÓN DE DATOS -->
                <div id="section-data" class="section-view hidden" style="height: 100%;">
                    <!-- Se inyecta dinámicamente con DataManagementModule -->
                </div>

                 <!-- SECCIÓN 6: CONFIGURACIÓN (NUEVA) -->
                <div id="section-settings" class="section-view hidden">
                    <div class="filter-panel" style="margin-bottom: 1rem; justify-content:space-between;">
                        <h3 style="margin:0;">Gestión de Usuarios</h3>
                        <!-- No Add button, assumed static user set for simplicity or pre-seeded -->
                    </div>
                    <div class="data-panel" style="height: auto; max-height: 100%;">
                        <div class="table-container">
                            <table class="custom-table" id="users-table">
                                <thead>
                                    <tr>
                                        <th>Nombre Completo</th>
                                        <th>Usuario</th>
                                        <th>Cargo</th>
                                        <th>Rol</th>
                                        <th style="text-align:center;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body">
                                    <!-- User Rows -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- MODAL GENÉRICO -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Título Modal</h3>
                <button class="btn-close-modal" onclick="app.closeModal()">×</button>
            </div>
            <div class="modal-body" id="modal-body-content"></div>
            <div class="modal-footer" id="modal-footer-content"></div>
        </div>
    </div>

    <!-- TEMPLATES -->
    <template id="tmpl-add-ticket">
        <div class="section-title">1. Ubicación del Equipo</div>
        <div class="grid-2">
            <div class="form-group"><label class="form-label">Edificio</label><select id="sel-building" onchange="app.handleBuildingChange(this.value)"><option value="">Seleccione...</option></select></div>
            <div class="form-group"><label class="form-label">Piso</label><select id="sel-floor" onchange="app.handleFloorChange(this.value)" disabled><option value="">Seleccione...</option></select></div>
        </div>
        <div class="grid-2">
            <div class="form-group"><label class="form-label">Área</label><select id="sel-area" onchange="app.handleAreaChange(this.value)" disabled><option value="">Seleccione...</option></select></div>
            <div class="form-group"><label class="form-label">Habitación (Opcional)</label><select id="sel-room" onchange="app.handleRoomChange(this.value)" disabled><option value="">Seleccione...</option></select></div>
        </div>
        <div class="section-title">2. Selección del Dispositivo</div>
        <div class="form-group"><label class="form-label">Dispositivo</label><select id="sel-device" disabled><option value="">Seleccione Ubicación Primero...</option></select></div>
        <div class="section-title">3. Detalles del Ingreso</div>
        <div class="grid-2"><div class="form-group"><label class="form-label">Fecha Ingreso</label><input type="date" id="date-in" required></div><div></div></div>
        <div class="form-group"><label class="form-label">Falla Reportada</label><textarea id="details-in" rows="3" placeholder="Describa la falla o motivo del ingreso..." required style="resize: none;" maxlength="300"></textarea><div class="char-counter">0/300</div></div>
        <div id="form-error" class="error-msg"></div>
    </template>
    
    <template id="tmpl-edit-ticket">
        <div class="section-title">1. Ubicación del Equipo</div>
        <div class="grid-2"><div class="form-group"><label class="form-label">Edificio</label><input type="text" id="edit-building" disabled></div><div class="form-group"><label class="form-label">Piso</label><input type="text" id="edit-floor" disabled></div></div>
        <div class="grid-2"><div class="form-group"><label class="form-label">Área</label><input type="text" id="edit-area" disabled></div><div class="form-group"><label class="form-label">Habitación</label><input type="text" id="edit-room" disabled></div></div>
        <div class="section-title">2. Equipo en Taller</div><div class="info-block" id="edit-device-info"></div>
        <div class="section-title">3. Detalles del Ingreso</div>
        <div class="grid-2"><div class="form-group"><label class="form-label">Fecha Ingreso</label><input type="date" id="edit-date-in" required></div><div></div></div>
        <div class="form-group"><label class="form-label">Falla Reportada</label><textarea id="edit-details-in" rows="3" placeholder="Describa la falla o motivo del ingreso..." required style="resize: none;" maxlength="300"></textarea><div class="char-counter">0/300</div></div>
        <div id="edit-form-error" class="error-msg"></div>
    </template>

    <template id="tmpl-finalize-ticket">
        <div class="info-block" style="background: #eef2ff; border: 1px solid #c7d2fe;">
            <div style="font-weight:bold; color:var(--color-primary); margin-bottom:5px;">Equipo:</div><div id="fin-device-info" style="margin-bottom:10px;"></div>
            <div style="font-weight:bold; color:var(--color-primary); margin-bottom:5px;">Ubicación:</div><div id="fin-location-info" style="margin-bottom:10px;"></div>
            <div style="font-weight:bold; color:var(--color-primary); margin-bottom:5px;">Falla Reportada:</div><div id="fin-problem-info" style="font-style:italic;"></div>
        </div>
        <div class="grid-2"><div class="form-group"><label class="form-label">Estado Final</label><select id="fin-status"><option value="repaired">Reparado</option><option value="unrepaired">No Reparado</option></select></div><div class="form-group"><label class="form-label">Fecha Salida</label><input type="date" id="fin-date-out" required></div></div>
        <div class="form-group"><label class="form-label">Informe de Salida</label><textarea id="fin-details-out" rows="3" placeholder="Describa el procedimiento realizado..." required style="resize: none;" maxlength="300"></textarea><div class="char-counter">0/300</div></div>
        <div id="fin-error" class="error-msg"></div>
    </template>

    <template id="tmpl-delete-confirm">
        <div style="text-align: center; padding: 1rem;">
            <p style="font-size: 1.1rem; color: var(--color-text); margin-bottom: 0.5rem;">¿Está seguro de que desea eliminar este registro?</p>
            <p style="font-size: 0.9rem; color: var(--color-text-light);">Esta acción no se puede deshacer.</p>
        </div>
    </template>

    <template id="tmpl-device-form">
        <div class="section-title">Información General</div>
        <div class="grid-2"><div class="form-group"><label class="form-label">Tipo *</label><select id="dev-type" required><option value="">Seleccione...</option></select></div><div class="form-group"><label class="form-label">Marca</label><select id="dev-brand" onchange="app.filterModels(this.value)"><option value="">Seleccione...</option></select></div></div>
        <div class="grid-2"><div class="form-group"><label class="form-label">Modelo</label><select id="dev-model" disabled><option value="">Seleccione Marca...</option></select></div><div class="form-group"><label class="form-label">Serial</label><input type="text" id="dev-serial" placeholder="S/N"></div></div>
        <div class="form-group"><label class="form-label">Código del Bien</label><input type="text" id="dev-code" placeholder="Ej: 4030"></div>
        <div class="section-title">Ubicación Física</div>
        <div class="grid-2"><div class="form-group"><label class="form-label">Edificio *</label><select id="sel-building" onchange="app.handleBuildingChange(this.value)" required><option value="">Seleccione...</option></select></div><div class="form-group"><label class="form-label">Piso *</label><select id="sel-floor" onchange="app.handleFloorChange(this.value)" disabled required><option value="">Seleccione...</option></select></div></div>
        <div class="grid-2"><div class="form-group"><label class="form-label">Área *</label><select id="sel-area" onchange="app.handleAreaChange(this.value)" disabled required><option value="">Seleccione...</option></select></div><div class="form-group"><label class="form-label">Habitación</label><select id="sel-room" disabled><option value="">Seleccione...</option></select></div></div>
        <div class="section-title">Especificaciones Técnicas</div>
        <div class="grid-2"><div class="form-group"><label class="form-label">SO</label><select id="dev-os"><option value=""></option></select></div><div class="form-group"><label class="form-label">Arquitectura</label><select id="dev-arch"><option value=""></option></select></div></div>
        <div class="grid-2"><div class="form-group"><label class="form-label">CPU</label><select id="dev-cpu"><option value=""></option></select></div><div class="form-group"><label class="form-label">RAM</label><select id="dev-ram"><option value=""></option></select></div></div>
        <div class="form-group"><label class="form-label">Almacenamiento</label><select id="dev-storage"><option value=""></option></select></div>
        <div class="form-group"><label class="form-label">Detalles</label><textarea id="dev-details" rows="2" placeholder="Detalles adicionales..." style="resize: none;" maxlength="200"></textarea></div>
        <div id="dev-form-error" class="error-msg"></div>
    </template>

    <template id="tmpl-view-device">
        <div style="background: #f9fafb; padding: 1.5rem; border-radius: 8px; border: 1px solid #e5e7eb;">
            <div class="section-title" style="margin-top:0;">Información General</div>
            <div class="details-grid">
                <div class="detail-item"><span class="detail-label">Tipo</span><span class="detail-value" id="view-type"></span></div>
                <div class="detail-item"><span class="detail-label">Ubicación</span><span class="detail-value" id="view-location"></span></div>
                <div class="detail-item"><span class="detail-label">Marca</span><span class="detail-value" id="view-brand"></span></div>
                <div class="detail-item"><span class="detail-label">Modelo</span><span class="detail-value" id="view-model"></span></div>
                <div class="detail-item"><span class="detail-label">Código</span><span class="detail-value" id="view-code"></span></div>
                <div class="detail-item"><span class="detail-label">Serial</span><span class="detail-value" id="view-serial"></span></div>
            </div>
            <div class="section-title">Especificaciones Técnicas</div>
            <div class="details-grid">
                <div class="detail-item"><span class="detail-label">SO</span><span class="detail-value" id="view-os"></span></div>
                <div class="detail-item"><span class="detail-label">CPU</span><span class="detail-value" id="view-cpu"></span></div>
                <div class="detail-item"><span class="detail-label">RAM</span><span class="detail-value" id="view-ram"></span></div>
                <div class="detail-item"><span class="detail-label">Storage</span><span class="detail-value" id="view-storage"></span></div>
                <div class="detail-item"><span class="detail-label">Arch</span><span class="detail-value" id="view-arch"></span></div>
            </div>
            <div class="section-title">Observaciones</div>
            <div class="info-block" id="view-details" style="background:white; border:1px solid #e5e7eb; min-height:3rem; font-style:italic; color:#4b5563;"></div>
        </div>
    </template>

    <template id="tmpl-view-ticket">
        <div style="background: #f9fafb; padding: 1.5rem; border-radius: 8px; border: 1px solid #e5e7eb;">
            <div class="section-title" style="margin-top:0;">1. Información del Equipo</div>
            <div class="details-grid">
                <div class="detail-item"><span class="detail-label">Tipo</span><span class="detail-value" id="vt-type"></span></div>
                <div class="detail-item"><span class="detail-label">Marca / Modelo</span><span class="detail-value" id="vt-brand-model"></span></div>
                <div class="detail-item"><span class="detail-label">Código</span><span class="detail-value" id="vt-code"></span></div>
                <div class="detail-item"><span class="detail-label">Serial</span><span class="detail-value" id="vt-serial"></span></div>
                <div class="detail-item detail-full"><span class="detail-label">Ubicación Origen</span><span class="detail-value" id="vt-location" style="font-weight:600;"></span></div>
            </div>
            <div class="section-title">2. Detalles del Servicio</div>
            <div class="details-grid">
                <div class="detail-item"><span class="detail-label">Fecha Entrada</span><span class="detail-value" id="vt-date-in"></span></div>
                <div class="detail-item"><span class="detail-label">Fecha Salida</span><span class="detail-value" id="vt-date-out"></span></div>
                <div class="detail-item"><span class="detail-label">Estado Final</span><span class="detail-value" id="vt-status"></span></div>
            </div>
            <div class="detail-item detail-full" style="margin-bottom:1rem;">
                <span class="detail-label">Motivo de Ingreso</span>
                <div class="detail-value" id="vt-details-in" style="height:auto; min-height:1.4rem;"></div>
            </div>
            <div class="detail-item detail-full">
                <span class="detail-label">Informe de Salida</span>
                <div class="detail-value" id="vt-details-out" style="height:auto; min-height:1.4rem; background:white; padding:5px; border:1px solid #eee;"></div>
            </div>
        </div>
    </template>

    <template id="tmpl-edit-user">
        <div class="form-group"><label class="form-label">Nombre Completo</label><input type="text" id="user-fullname" required></div>
        <div class="form-group"><label class="form-label">Usuario</label><input type="text" id="user-name" required></div>
        <div class="form-group"><label class="form-label">Cargo</label><input type="text" id="user-position" required></div>
        <div class="form-group"><label class="form-label">Rol</label><select id="user-role"><option value="admin">Administrador</option><option value="viewer">Consultor</option></select></div>
        <div class="form-group"><label class="form-label">Nueva Contraseña (Opcional)</label><input type="password" id="user-password" placeholder="Dejar en blanco para no cambiar"></div>
    </template>

    <script>
        // --- DATA MANAGEMENT MODULE CLASSES ---
        class DataManagementModule {
            constructor(container) {
                this.container = container;
                this.activeTable = 'locations'; 
                // Updated Tables List with Infrastructure Split
                this.tables = [
                    { id: 'locations', label: 'Ubicaciones (Links)', endpoint: 'locations', readOnly: true },
                    { id: 'buildings_infra', label: 'Edificios', endpoint: 'buildings_infra' },
                    { id: 'floors', label: 'Pisos', endpoint: 'floors', parentCollection: 'buildings' },
                    { id: 'areas', label: 'Áreas', endpoint: 'areas', parentCollection: 'floors' },
                    { id: 'rooms', label: 'Habitaciones', endpoint: 'rooms', parentCollection: 'areas' },
                    { id: 'brands', label: 'Marcas', endpoint: 'brands' },
                    { id: 'models', label: 'Modelos', endpoint: 'models', parentCollection: 'brands' },
                    { id: 'types', label: 'Tipos de Equipo', endpoint: 'types' },
                    { id: 'os', label: 'Sis. Operativos', endpoint: 'os' },
                    { id: 'rams', label: 'Memorias RAM', endpoint: 'rams' },
                    { id: 'processors', label: 'Procesadores', endpoint: 'processors' },
                    { id: 'storages', label: 'Almacenamientos', endpoint: 'storages' }
                ];
                this.crudInstance = null;
            }

            render() {
                this.container.innerHTML = `
                    <div class="dm-layout">
                        <div class="dm-sidebar" id="dmMenu"></div>
                        <div class="dm-container" id="dmWorkspace"></div>
                    </div>
                `;
                this.renderMenu();
                this.loadTable(this.activeTable);
            }

            renderMenu() {
                const menu = document.getElementById('dmMenu');
                menu.innerHTML = this.tables.map(t => `
                    <div class="dm-menu-item ${this.activeTable === t.id ? 'active' : ''}" onclick="app.dataModule.loadTable('${t.id}')">
                        <span>${t.label}</span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                `).join('');
            }

            loadTable(tableId) {
                this.activeTable = tableId;
                this.renderMenu(); 
                const tableConfig = this.tables.find(t => t.id === tableId);
                const workspace = document.getElementById('dmWorkspace');
                workspace.innerHTML = ''; 
                this.crudInstance = new MasterCRUD(workspace, tableConfig);
                this.crudInstance.init();
            }
        }

        class MasterCRUD {
            constructor(container, config) {
                this.container = container;
                this.config = config;
                this.state = { data: [], total: 0, page: 1, limit: 10, search: '' };
                this.debounceTimer = null;
            }

            init() {
                this.renderFrame();
                this.fetchData();
            }

            renderFrame() {
                // If readOnly is true (Locations), don't show Add button. Also hide for Viewer.
				const isAdmin = app.isAdmin();
                const showAdd = !this.config.readOnly && isAdmin;
                const addBtn = showAdd ? `<button class="btn-primary" onclick="app.dataModule.crudInstance.openModal('add')">+ Añadir</button>` : '';
                
                this.container.innerHTML = `
                    <div class="crud-header">
                        <div class="search-box">
                            <input type="text" placeholder="Buscar ${this.config.label}..." onkeyup="app.dataModule.crudInstance.handleSearch(this.value)">
                        </div>
                        ${addBtn}
                    </div>
                    <div class="crud-content">
                        <div class="table-container">
                            <table class="custom-table" style="border-top:none;">
                                <thead>
									<tr>
										<th>${this.config.label}</th>
										${isAdmin ? '<th style="width:100px; text-align:center;">Acciones</th>' : ''}
									</tr>
								</thead>
                                <tbody id="crudTableBody"></tbody>
                            </table>
                        </div>
                        <div class="pagination-controls" style="border-top:1px solid #eee;">
                            <button class="page-btn" onclick="app.dataModule.crudInstance.changePage(-1)" id="crud-prev">Anterior</button>
                            <span class="page-info" id="crud-page-info">0 - 0</span>
                            <button class="page-btn" onclick="app.dataModule.crudInstance.changePage(1)" id="crud-next">Siguiente</button>
                        </div>
                    </div>
                `;
            }

            async fetchData() {
                try {
                    const q = `?page=${this.state.page}&limit=${this.state.limit}&search=${encodeURIComponent(this.state.search)}`;
                    const url = `/api/data/${this.config.endpoint}${q}`;
                    const res = await app.fetchAPI(url);
                    if(!res) return;

                    const contentType = res.headers.get("content-type");
                    if (!contentType || !contentType.includes("application/json")) {
                        throw new Error(`Error de Protocolo: El servidor devolvió HTML en lugar de JSON. (Ruta no encontrada: ${url})`);
                    }

                    const json = await res.json();
                    this.state.data = json.data || [];
                    this.state.total = json.total || 0;
                    this.renderTable();
                    this.updatePagination();
                } catch (e) { 
                    console.error("SART Error:", e);
                    const tbody = document.getElementById('crudTableBody');
                    tbody.innerHTML = `<tr><td colspan="2" class="text-muted" style="color:var(--color-danger)!important;">
                        <strong>Error de Conexión:</strong><br>
                        El sistema no puede obtener los datos.<br>
                        <small>${e.message}</small>
                    </td></tr>`;
                }
            }

            renderTable() {
                const tbody = document.getElementById('crudTableBody');
                tbody.innerHTML = '';
                if (this.state.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="2" class="text-muted">No se encontraron datos</td></tr>';
                    return;
                }
                
                const isAdmin = app.isAdmin();

                this.state.data.forEach(item => {
                    let displayValue = item.value;
                    // Hierarchy Visuals
                    if (this.config.id === 'models' || this.config.id === 'locations' || 
                        this.config.id === 'floors' || this.config.id === 'areas' || this.config.id === 'rooms') {
                        
                        displayValue = displayValue.replace(/ > /g, ` <span style="color:#bbb; font-size:0.8em;">&#9654;</span> `);
                        // Clean details separator also
                        displayValue = displayValue.replace(/ - /g, ` <span style="color:#bbb; font-size:0.8em;">|</span> `);

                        if(this.config.id === 'models') {
                             const parts = item.value.split(' ');
                             if(parts.length > 1) displayValue = `<b>${parts[0]}</b> ${parts.slice(1).join(' ')}`;
                        }
                    }
                    
                    let actions = '';
                    if (isAdmin) {
                        if (!this.config.readOnly) {
                            actions = `
                                <button class="action-btn edit" onclick="app.dataModule.crudInstance.openModal('edit', ${item.id})"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                                <button class="action-btn delete" onclick="app.dataModule.crudInstance.deleteItem(${item.id})"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                            `;
                        } else if (this.config.id === 'locations') {
                            // Special: Only edit details
                            actions = `
                                <button class="action-btn edit" onclick="app.dataModule.crudInstance.openModal('edit', ${item.id})" title="Editar Detalles"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                                <button class="action-btn delete" onclick="app.dataModule.crudInstance.deleteItem(${item.id})"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                            `;
                        }
                    } else {
                        actions = `<span style="font-size:0.8rem; color: #bbb;">Solo Lectura</span>`;
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td>${displayValue}</td>
                            ${isAdmin ? `<td class="actions-cell">${actions}</td>` : ''}
                        </tr>
                    `;
                });
            }

            updatePagination() {
                const start = (this.state.page - 1) * this.state.limit + 1;
                const end = Math.min(start + this.state.limit - 1, this.state.total);
                document.getElementById('crud-page-info').textContent = this.state.total === 0 ? '0' : `${start} - ${end} de ${this.state.total}`;
                document.getElementById('crud-prev').disabled = this.state.page <= 1;
                document.getElementById('crud-next').disabled = end >= this.state.total;
            }

            changePage(delta) {
                this.state.page += delta;
                this.fetchData();
            }

            handleSearch(val) {
                clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(() => {
                    this.state.search = val.trim();
                    this.state.page = 1;
                    this.fetchData();
                }, 300);
            }

            async deleteItem(id) {
                if(!confirm('¿Estás seguro de eliminar este registro?')) return;
                try {
                    const res = await app.fetchAPI(`/api/data/${this.config.endpoint}?id=${id}`, { method: 'DELETE' });
                    if (res.status === 409) {
                        const json = await res.json();
                        alert("⚠️ " + (json.message || "Conflicto de integridad. El dato está en uso."));
                        return;
                    }
                    if (res.ok) {
                        this.fetchData();
                        app.syncGlobals(); // Sync filters
                    }
                } catch (e) { alert("Error al eliminar"); }
            }

            async openModal(action, id = null) {
                const overlay = document.getElementById('modal-overlay');
                const title = document.getElementById('modal-title');
                const body = document.getElementById('modal-body-content');
                const footer = document.getElementById('modal-footer-content');
                
                title.textContent = (action === 'add' ? 'Añadir ' : 'Editar ') + this.config.label;
                let modalHTML = '';
                
                // --- CASE: EDIT LOCATION DETAILS (LINKS) ---
                if (this.config.id === 'locations' && action === 'edit') {
                    const item = this.state.data.find(i => i.id === id);
                    // Extract details: "Edificio > ... > Sala - Detalle"
                    let details = '';
                    let mainInfo = item ? item.value : '';
                    if(item && item.value.includes(' - ')) {
                        const parts = item.value.split(' - ');
                        details = parts[parts.length-1];
                        mainInfo = parts.slice(0, parts.length-1).join(' - ');
                    }
                    
                    modalHTML = `
                        <div class="info-block">${mainInfo}</div>
                        <div class="form-group"><label class="form-label">Detalles Adicionales</label>
                            <input type="text" id="modal-value" value="${details}" placeholder="Ej: Cubículo 5, Pasillo Central">
                        </div>
                    `;
                }
                // --- CASE: CASCADING ROOMS/AREAS ---
                else if (this.config.id === 'areas' || this.config.id === 'rooms') {
                    if(!app.state.locations) await app.loadGlobalData();
                    const locs = app.state.locations;
                    let itemName = '';
                    let bId = '', fId = '', aId = ''; // IDs for cascading

                    if (action === 'edit' && id) {
                        const item = this.state.data.find(i => i.id === id);
                        if(item) {
                            // Parse name from "Building > Floor > Area"
                            const parts = item.value.split(' > '); 
                            itemName = parts[parts.length-1];
                            
                            // Trace back parents
                            if (this.config.id === 'areas') {
                                fId = item.parent_id;
                                const floorObj = locs.floors.find(f => f.id == fId);
                                if(floorObj) bId = floorObj.parent_id;
                            } else if (this.config.id === 'rooms') {
                                aId = item.parent_id;
                                const areaObj = locs.areas.find(a => a.id == aId);
                                if(areaObj) {
                                    fId = areaObj.parent_id;
                                    const floorObj = locs.floors.find(f => f.id == fId);
                                    if(floorObj) bId = floorObj.parent_id;
                                }
                            }
                        }
                    }

                    // Cascading Selects Structure
                    modalHTML = `
                        <div class="form-group"><label class="form-label">Edificio</label>
                            <select id="modal-building" class="w-full" onchange="app.dataModule.crudInstance.cascadeModalChange('building')">
                                <option value="">Seleccione...</option>
                                ${locs.buildings.map(b => `<option value="${b.id}" ${b.id == bId ? 'selected' : ''}>${b.value}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group"><label class="form-label">Piso</label>
                            <select id="modal-floor" class="w-full" ${!bId ? 'disabled' : ''} onchange="app.dataModule.crudInstance.cascadeModalChange('floor')">
                                <option value="">Seleccione Edificio...</option>
                                ${bId ? locs.floors.filter(f => f.parent_id == bId).map(f => `<option value="${f.id}" ${f.id == fId ? 'selected' : ''}>${f.value}</option>`).join('') : ''}
                            </select>
                        </div>
                    `;

                    if (this.config.id === 'rooms') {
                        modalHTML += `
                        <div class="form-group"><label class="form-label">Área</label>
                            <select id="modal-area" class="w-full" ${!fId ? 'disabled' : ''}>
                                <option value="">Seleccione Piso...</option>
                                ${fId ? locs.areas.filter(a => a.parent_id == fId).map(a => `<option value="${a.id}" ${a.id == aId ? 'selected' : ''}>${a.value}</option>`).join('') : ''}
                            </select>
                        </div>`;
                    }

                    modalHTML += `
                        <div class="form-group"><label class="form-label">Nombre</label>
                            <input type="text" id="modal-value" value="${itemName}" placeholder="Ingrese nombre">
                        </div>
                    `;
                }
                // --- CASE: OTHER HIERARCHICAL (MODELS, FLOORS) ---
                else if (this.config.parentCollection) {
                    const parentKey = this.config.parentCollection; 
                    if(!app.state.locations) await app.loadGlobalData();
                    if(!app.state.specs) await app.loadGlobalData();
                    
                    let parents = [];
                    if(parentKey === 'brands') parents = app.state.specs.brands;
                    else if(parentKey === 'buildings') parents = app.state.locations.buildings;
                    else if(parentKey === 'floors') parents = app.state.locations.floors;

                    let parentId = '', itemName = '';
                    if (action === 'edit' && id) {
                        const item = this.state.data.find(i => i.id === id);
                        if(item) {
                            parentId = item.parent_id; 
                            const parts = item.value.split(' > '); 
                            itemName = parts.length > 1 ? parts[parts.length-1] : item.value;
                            if(this.config.id === 'models') {
                                const mParts = item.value.split(' ');
                                itemName = mParts.length > 1 ? mParts.slice(1).join(' ') : item.value;
                            }
                        }
                    }
                    
                    const parentLabel = { 'brands': 'Marca', 'buildings': 'Edificio', 'floors': 'Piso' }[parentKey] || 'Padre';

                    modalHTML = `
                        <div class="form-group"><label class="form-label">${parentLabel}</label>
                            <select id="modal-parent" class="w-full">
                                <option value="">Seleccione...</option>
                                ${parents.map(p => `<option value="${p.id}" ${p.id == parentId ? 'selected' : ''}>${p.value}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group"><label class="form-label">Nombre</label>
                            <input type="text" id="modal-value" value="${itemName}" placeholder="Ingrese nombre">
                        </div>
                    `;
                }
                // --- CASE: SIMPLE ---
                else {
                    const val = action === 'edit' && id ? this.state.data.find(i => i.id === id)?.value || '' : '';
                    modalHTML = `
                        <div class="form-group"><label class="form-label">Nombre / Valor</label>
                            <input type="text" id="modal-value" value="${val}" placeholder="Ingrese valor">
                        </div>
                    `;
                }

                body.innerHTML = modalHTML;
                footer.innerHTML = `
                    <button class="btn-secondary" onclick="app.closeModal()">Cancelar</button>
                    <button class="btn-primary" onclick="app.dataModule.crudInstance.submitMasterData('${action}', ${id})">Guardar</button>
                `;
                
                overlay.classList.add('open');
            }

            cascadeModalChange(level) {
                const locs = app.state.locations;
                if (level === 'building') {
                    const bId = document.getElementById('modal-building').value;
                    const selF = document.getElementById('modal-floor');
                    selF.innerHTML = '<option value="">Seleccione...</option>';
                    selF.disabled = true;
                    if(document.getElementById('modal-area')) {
                        document.getElementById('modal-area').innerHTML = '<option value="">Seleccione Piso...</option>';
                        document.getElementById('modal-area').disabled = true;
                    }
                    if(bId) {
                        const floors = locs.floors.filter(f => f.parent_id == bId);
                        selF.innerHTML = '<option value="">Seleccione...</option>' + floors.map(f => `<option value="${f.id}">${f.value}</option>`).join('');
                        selF.disabled = false;
                    }
                } else if (level === 'floor' && document.getElementById('modal-area')) {
                    const fId = document.getElementById('modal-floor').value;
                    const selA = document.getElementById('modal-area');
                    selA.innerHTML = '<option value="">Seleccione...</option>';
                    selA.disabled = true;
                    if(fId) {
                        const areas = locs.areas.filter(a => a.parent_id == fId);
                        selA.innerHTML = '<option value="">Seleccione...</option>' + areas.map(a => `<option value="${a.id}">${a.value}</option>`).join('');
                        selA.disabled = false;
                    }
                }
            }

            async submitMasterData(action, id) {
                const table = this.config.id;
                let payload = {};
                
                try {
                    // --- CASE: LOCATION DETAILS ---
                    if (table === 'locations') {
                        payload.details = document.getElementById('modal-value').value;
                        await this.sendRequest(action, id, payload);
                    }
                    // --- CASCADING ROOMS/AREAS ---
                    else if (table === 'areas' || table === 'rooms') {
                        payload.value = document.getElementById('modal-value').value;
                        if(table === 'areas') payload.parent_id = parseInt(document.getElementById('modal-floor').value);
                        if(table === 'rooms') payload.parent_id = parseInt(document.getElementById('modal-area').value);
                        
                        if (!payload.value || !payload.parent_id) { alert("Complete todos los campos jerárquicos"); return; }
                        await this.sendRequest(action, id, payload);
                    }
                    // --- OTHER HIERARCHICAL ---
                    else if (this.config.parentCollection) {
                        payload.value = document.getElementById('modal-value').value;
                        payload.parent_id = parseInt(document.getElementById('modal-parent').value);
                        if (!payload.value || !payload.parent_id) { alert("Complete los campos"); return; }
                        await this.sendRequest(action, id, payload);
                    }
                    // --- SIMPLE ---
                    else {
                        payload.value = document.getElementById('modal-value').value;
                        if (!payload.value) { alert("Campo vacío"); return; }
                        await this.sendRequest(action, id, payload);
                    }
                } catch(e) {
                    console.error(e);
                    alert("Error al procesar: " + e.message);
                }
            }

            async sendRequest(action, id, payload) {
                const method = action === 'add' ? 'POST' : 'PUT';
                const qs = action === 'edit' ? `?id=${id}` : '';
                const res = await app.fetchAPI(`/api/data/${this.config.endpoint}${qs}`, {
                    method: method,
                    body: JSON.stringify(payload)
                });
                
                const json = await res.json();
                
                if (res.ok) {
                    app.closeModal();
                    this.fetchData();
                    // SYNC FILTERS: Reload globals immediately after data change
                    await app.syncGlobals();
                } else {
                    alert("⚠️ " + (json.message || "Operación fallida"));
                }
            }
        }

        const app = {
            state: { 
                user: null, token: null, currentPage: 'home', 
                page: 1, limit: 4, total: 0, 
                specs: null, locations: null, users: [], workshopData: [], inventoryData: [], historyData: [],
                currentTicketId: null, currentDeviceId: null, debounceTimer: null,
                selBuilding: 0, selFloor: 0, selArea: 0, selRoom: 0
            },
            
            dataModule: null, // Module Instance

            init() {
                const storedUser = localStorage.getItem('sart_user');
                const storedToken = localStorage.getItem('sart_token');
                if (storedUser && storedToken) {
                    this.state.user = JSON.parse(storedUser);
                    this.state.token = storedToken;
                    this.showApp();
                } else { this.showLogin(); }
                document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); this.handleLogin(); });
            },

            isAdmin() { return this.state.user && this.state.user.role === 'admin'; },

            navigate(pageId) {
                this.state.currentPage = pageId;
                document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                const activeLink = Array.from(document.querySelectorAll('.nav-link')).find(l => l.getAttribute('onclick').includes(pageId));
                if (activeLink) activeLink.classList.add('active');
                
                document.querySelectorAll('.section-view').forEach(sec => sec.classList.add('hidden'));
                const targetSection = document.getElementById(`section-${pageId}`);
                if (targetSection) targetSection.classList.remove('hidden');

                const titles = { 'home': 'Inicio', 'workshop': 'Gestión de Taller', 'inventory': 'Inventario General', 'history': 'Historial de Servicios', 'data': 'Gestión de Datos', 'settings': 'Configuración' };
                document.getElementById('page-title').textContent = titles[pageId] || 'SART';

                if (pageId === 'inventory') { this.loadInventoryFilters(); this.loadInventory(1); }
                if (pageId === 'workshop') { this.state.page = 1; this.loadWorkshopFilters(); this.loadWorkshop(1); }
                if (pageId === 'history') { this.loadHistoryFilters(); this.loadHistory(1); }
                if (pageId === 'home') this.loadDashboardData();
                if (pageId === 'settings' && this.isAdmin()) this.loadUsers();
                
                // DATA MODULE INITIALIZATION
                if (pageId === 'data') {
                    if (!this.dataModule) this.dataModule = new DataManagementModule(document.getElementById('section-data'));
                    this.dataModule.render();
                }
            },

            async fetchAPI(url, options = {}) {
                options.headers = { ...options.headers, 'Authorization': 'Bearer ' + this.state.token };
                const res = await fetch(url, options);
                if (res.status === 401) { this.logout(); return null; }
                return res;
            },

            async loadGlobalData() {
                try {
                    const [resSpecs, resLocs, resUsers] = await Promise.all([
                        this.fetchAPI('/api/specs'), this.fetchAPI('/api/locations'), this.fetchAPI('/api/users')
                    ]);
                    const jsonSpecs = await resSpecs.json();
                    const jsonLocs = await resLocs.json();
                    const jsonUsers = await resUsers.json();
                    if(jsonSpecs.success) this.state.specs = jsonSpecs.data;
                    if(jsonLocs.success) this.state.locations = jsonLocs.data;
                    if(jsonUsers.data) this.state.users = jsonUsers.data;
                } catch(e) { console.error("Error cargando datos globales", e); }
            },

            async syncGlobals() {
                await this.loadGlobalData();
                // Clear filter cache
                document.querySelectorAll('select[id$="-filter-type"], select[id$="-filter-brand"], select[id$="-filter-os"]').forEach(el => el.innerHTML = '');
            },

            getSignatures() {
                const admin = this.state.users.find(u => u.role === 'admin') || { full_name: "NOMBRE NO DISPONIBLE", position: "CARGO NO DISPONIBLE" };
                const viewer = this.state.users.find(u => u.role === 'viewer') || { full_name: "NOMBRE NO DISPONIBLE", position: "CARGO NO DISPONIBLE" };
                return { leftName: admin.full_name.toUpperCase(), leftJob: admin.position.toUpperCase(), rightName: viewer.full_name.toUpperCase(), rightJob: viewer.position.toUpperCase() };
            },
			
			fmtDate(isoDate) { if(!isoDate) return ''; const [y,m,d] = isoDate.split('-'); return `${d}/${m}/${y}`; },
			
            loadWorkshopFilters() {
                // FORCE RELOAD if empty (after CRUD)
                if(document.getElementById('wk-filter-type').length <= 1) {
                     if(!this.state.specs) return;
                     const fill = (id, items) => {
                        const sel = document.getElementById(id);
                        sel.innerHTML = '<option value="">Todos</option>';
                        if(items) items.forEach(i => sel.innerHTML += `<option value="${i.id}">${i.value}</option>`);
                    };
                    fill('wk-filter-type', this.state.specs.types);
                    fill('wk-filter-brand', this.state.specs.brands);
                    fill('wk-filter-os', this.state.specs.os);
                    fill('wk-filter-cpu', this.state.specs.processors);
                    fill('wk-filter-ram', this.state.specs.rams);
                }
            },

            debounceLoadWorkshop() { clearTimeout(this.state.debounceTimer); this.state.debounceTimer = setTimeout(() => this.loadWorkshop(1), 400); },

            async loadWorkshop(pageArg) {
                if (pageArg) this.state.page = pageArg;
                const search = document.getElementById('wk-search').value;
                const type = document.getElementById('wk-filter-type').value;
                const brand = document.getElementById('wk-filter-brand').value;
                const os = document.getElementById('wk-filter-os').value;
                const cpu = document.getElementById('wk-filter-cpu').value;
                const ram = document.getElementById('wk-filter-ram').value;

                let qs = `status=pending&page=${this.state.page}&limit=${this.state.limit}`;
                if(search) qs += `&search=${encodeURIComponent(search)}`;
                try {
                    const res = await this.fetchAPI('/api/tickets?' + qs);
                    if (!res) return;
                    const result = await res.json();
                    this.state.total = result.total || 0;
                    this.state.workshopData = result.data || [];
                    this.renderWorkshopTable(this.state.workshopData);
                    this.updatePaginationControls();
                } catch (err) { console.error(err); }
            },

            renderWorkshopTable(data) {
                const tbody = document.querySelector('#workshop-table tbody');
                tbody.innerHTML = '';
                const isAdmin = this.isAdmin();
                if (!data || data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="${isAdmin ? 7 : 6}" class="text-muted" style="text-align:center;">No se encontraron equipos.</td></tr>`;
                    for(let i=0; i<3; i++) tbody.innerHTML += this.getEmptyRowHTML(isAdmin ? 7 : 6);
                    return;
                }
                data.forEach((t, index) => {
                    const realIndex = ((this.state.page - 1) * this.state.limit) + (index + 1);
                    const brandModel = `${t.device_brand || '-/-'} ${t.device_model || '-/-'}`.trim();
                    const codeSerial = `${t.device_code || '-/-'} / ${t.device_serial || '-/-'}`.trim();
                    
                    let actions = '';
                    if(isAdmin) {
                        actions = `
                            <button class="action-btn edit" onclick="app.openModal('edit', ${t.id})" title="Editar"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                            <button class="action-btn check" onclick="app.openModal('finalize', ${t.id})" title="Finalizar"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg></button>
                            <button class="action-btn delete" onclick="app.openModal('delete', ${t.id})" title="Eliminar"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                        `;
                    } else {
                        actions = `<span class="text-muted" style="font-size:0.8rem;">Solo Lectura</span>`;
                    }
					
					let tbodyInnerHTML = "";
					
                    tbodyInnerHTML += `
                        <tr>
                            <td>${realIndex}</td><td>${this.fmtDate(t.date_in)}</td><td>${t.device_type}</td>
                            <td><div class="cell-truncate" title="${brandModel}"><strong>${t.device_brand || '-/-'}</strong><br><small class="text-secondary">${t.device_model || '-/-'}</small></div></td>
                            <td><div class="cell-truncate" title="${codeSerial}"><strong>${t.device_code || '-/-'}</strong><br><small class="text-secondary">${t.device_serial || '-/-'}</small></div></td>
                            <td><div class="cell-multiline" title="${t.details_in}">${t.details_in}</div></td>
					`;
					
					if (isAdmin) tbodyInnerHTML += `<td class="admin-only" style="text-align:center;"><div class="actions-cell" style="justify-content:center;">${actions}</div></td>`
					
					tbodyInnerHTML += "</tr>";
					tbody.innerHTML = tbodyInnerHTML;
                });
                const missing = this.state.limit - data.length;
                if(missing > 0) { for(let i=0; i<missing; i++) tbody.innerHTML += this.getEmptyRowHTML(isAdmin ? 7 : 6); }
            },

            getEmptyRowHTML(rows = 7) {
				const isAdmin = this.isAdmin();
				const emptyRows = "<td>&nbsp;</td>".repeat(rows);
				return `<tr style="pointer-events: none;">${emptyRows}</tr>`;
			},

            updatePaginationControls() {
                const totalPages = Math.ceil(this.state.total / this.state.limit) || 1;
                document.getElementById('wk-page-input').value = this.state.page;
                document.getElementById('wk-total-info').textContent = `de ${totalPages}`;
                document.getElementById('wk-btn-prev').disabled = this.state.page <= 1;
                document.getElementById('wk-btn-next').disabled = this.state.page >= totalPages;
            },
            prevPage() { if (this.state.page > 1) this.loadWorkshop(this.state.page - 1); },
            nextPage() { const totalPages = Math.ceil(this.state.total / this.state.limit) || 1; if (this.state.page < totalPages) this.loadWorkshop(this.state.page + 1); },
            inputPage(input) { const val = parseInt(input.value); const totalPages = Math.ceil(this.state.total / this.state.limit) || 1; if (!isNaN(val) && val >= 1 && val <= totalPages) this.loadWorkshop(val); },

            loadInventoryFilters() {
                // FORCE RELOAD if empty
                if(document.getElementById('inv-filter-type').length <= 1) {
                    if(!this.state.specs) return;
                    const fill = (id, items) => {
                        const sel = document.getElementById(id);
                        sel.innerHTML = '<option value="">Todos</option>';
                        if(items) items.forEach(i => sel.innerHTML += `<option value="${i.id}">${i.value}</option>`);
                    };
                    fill('inv-filter-type', this.state.specs.types);
                    fill('inv-filter-brand', this.state.specs.brands);
                    fill('inv-filter-os', this.state.specs.os);
                }
            },

            debounceLoadInventory() { clearTimeout(this.state.debounceTimer); this.state.debounceTimer = setTimeout(() => this.loadInventory(1), 400); },

            async loadInventory(pageArg) {
                this.state.page = pageArg; 
                const search = document.getElementById('inv-search').value;
                const type = document.getElementById('inv-filter-type').value;
                const brand = document.getElementById('inv-filter-brand').value;
                const os = document.getElementById('inv-filter-os').value;
                const status = document.getElementById('inv-filter-status').value;

                let qs = `page=${this.state.page}&limit=${this.state.limit}`;
                if(search) qs += `&search=${encodeURIComponent(search)}`;
                if(type) qs += `&type=${type}`; if(brand) qs += `&brand=${brand}`; if(os) qs += `&os=${os}`; if(status) qs += `&status=${status}`;

                try {
                    const res = await this.fetchAPI('/api/devices?' + qs);
                    if (!res || !res.ok) return;
                    const result = await res.json();
                    this.state.total = result.total;
                    this.state.inventoryData = result.data || [];
                    this.renderInvTable(this.state.inventoryData);
                    this.renderPaginationLegacy();
                } catch (err) { console.error(err); }
            },

            renderInvTable(items) {
                const tbody = document.querySelector('#inventory-table tbody');
                tbody.innerHTML = '';
                if (!items || items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-muted" style="text-align:center;">No hay dispositivos registrados.</td></tr>';
                    for(let i=0; i<3; i++) tbody.innerHTML += this.getEmptyRowHTML(8);
                    return;
                }
                const isAdmin = this.isAdmin();
                items.forEach((d, index) => {
                    const realIndex = ((this.state.page - 1) * this.state.limit) + (index + 1);
                    
                    let actions = `
                        <button class="action-btn view" onclick="app.openModal('view-device', ${d.id})" title="Ver Detalles"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></button>
                    `;
                    if(isAdmin) {
                        actions = `
                            <button class="action-btn edit" onclick="app.openModal('edit-device', ${d.id})" title="Editar"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                            ${actions}
                            <button class="action-btn delete" onclick="app.openModal('delete-device', ${d.id})" title="Eliminar"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                        `;
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td>${realIndex}</td><td>${d.type}</td>
                            <td><strong>${d.brand || '-/-'}</strong><br><span style="font-size:0.8rem; color:#6b7280;">${d.model || '-/-'}</span></td>
                            <td><strong>${d.area || '-/-'}</strong><br><span style="font-size:0.8rem; color:#6b7280;">${d.room || '-/-'}</span></td>
                            <td>${d.code || '-/-'}</td><td>${d.serial || '-/-'}</td>
                            <td><span class="badge ${d.status === 'operational' ? 'operativo' : 'pending'}">${d.status_label || d.status}</span></td>
                            <td style="text-align:center;"><div class="actions-cell">${actions}</div></td>
                        </tr>`;
                });
                const missing = this.state.limit - items.length;
                if(missing > 0) { for(let i=0; i<missing; i++) tbody.innerHTML += this.getEmptyRowHTML(8); }
            },

            renderPaginationLegacy() {
                const totalPages = Math.ceil(this.state.total / this.state.limit);
                document.getElementById('inv-page-info').textContent = `Página ${this.state.page} de ${totalPages || 1}`;
                document.getElementById('inv-btn-prev').disabled = this.state.page === 1;
                document.getElementById('inv-btn-next').disabled = this.state.page >= totalPages || totalPages === 0;
            },
            prevPageLegacy() { if (this.state.page > 1) this.loadInventory(this.state.page - 1); },
            nextPageLegacy() { const totalPages = Math.ceil(this.state.total / this.state.limit); if (this.state.page < totalPages) this.loadInventory(this.state.page + 1); },
            
            loadHistoryFilters() {
                if(document.getElementById('hist-filter-type').length <= 1) {
                    if(!this.state.specs) return;
                    const fill = (id, items) => {
                        const sel = document.getElementById(id);
                        sel.innerHTML = '<option value="">Todos</option>';
                        if(items) items.forEach(i => sel.innerHTML += `<option value="${i.id}">${i.value}</option>`);
                    };
                    fill('hist-filter-type', this.state.specs.types);
                    fill('hist-filter-brand', this.state.specs.brands);
                }
            },
            
            debounceLoadHistory() { clearTimeout(this.state.debounceTimer); this.state.debounceTimer = setTimeout(() => this.loadHistory(1), 400); },
            
            validateDates() {
                const after = document.getElementById('hist-date-after');
                const before = document.getElementById('hist-date-before');
                if(after.value) before.min = after.value;
                if(before.value) after.max = before.value;
            },

            clearHistoryFilters() {
                document.getElementById('hist-search').value = ""; document.getElementById('hist-filter-type').value = ""; document.getElementById('hist-filter-brand').value = ""; document.getElementById('hist-filter-status').value = ""; document.getElementById('hist-date-after').value = ""; document.getElementById('hist-date-before').value = "";
                this.loadHistory(1);
            },

            async loadHistory(pageArg) {
                this.state.page = pageArg;
                const search = document.getElementById('hist-search').value;
                const type = document.getElementById('hist-filter-type').value;
                const brand = document.getElementById('hist-filter-brand').value;
                const status = document.getElementById('hist-filter-status').value;
                const after = document.getElementById('hist-date-after').value;
                const before = document.getElementById('hist-date-before').value;

                let qs = `page=${this.state.page}&limit=${this.state.limit}`;
                if(status) qs += `&status=${status}`; else qs += `&status=history`; 
                if(search) qs += `&search=${encodeURIComponent(search)}`; if(type) qs += `&type=${type}`; if(brand) qs += `&brand=${brand}`; if(after) qs += `&after=${after}`; if(before) qs += `&before=${before}`;

                try {
                    const res = await this.fetchAPI('/api/tickets?' + qs);
                    if (!res) return;
                    const result = await res.json();
                    this.state.total = result.total || 0;
                    this.state.historyData = result.data || [];
                    this.renderHistoryTable(this.state.historyData);
                    this.renderPaginationHistory();
                } catch (err) { console.error(err); }
            },

            renderHistoryTable(data) {
                const tbody = document.querySelector('#history-table tbody');
                tbody.innerHTML = '';
                const isAdmin = this.isAdmin();
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-muted" style="text-align:center;">No se encontraron registros.</td></tr>';
                    for(let i=0; i<3; i++) tbody.innerHTML += this.getEmptyRowHTML(8);
                    return;
                }
                data.forEach((t, index) => {
                    const realIndex = ((this.state.page - 1) * this.state.limit) + (index + 1);
                    const statusClass = t.status === 'repaired' ? 'operativo' : 'unrepaired';
                    const statusLabel = t.status === 'repaired' ? 'Reparado' : 'No Reparado';
                    
                    let actions = `
                        <button class="action-btn view" onclick="app.openModal('view-ticket', ${t.id})" title="Ver Detalles"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></button>
                        <button class="action-btn" title="Exportar PDF" onclick="app.printReport('single', ${t.id})"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></button>
                    `;
                    if(isAdmin) {
                        actions += `<button class="action-btn delete" onclick="app.openModal('delete-ticket', ${t.id})" title="Eliminar"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>`;
                    }

					tbody.innerHTML += `
                        <tr>
                            <td>${realIndex}</td><td>${this.fmtDate(t.date_out) || '-/-'}</td><td>${t.device_type}</td>
							<td><strong>${t.device_brand || '-/-'}</strong><br><small class="text-secondary">${t.device_model || '-/-'}</small></td>
							<td><strong>${t.device_code || '-/-'}</strong><br><small class="text-secondary">${t.device_serial || '-/-'}</small></td>
                            <td><div class="cell-multiline" title="${t.details_out}">${t.details_out || '-/-'}</div></td>
                            <td><span class="badge ${statusClass}">${statusLabel}</span></td>
                            <td style="text-align:center;"><div class="actions-cell" style="justify-content:center;">${actions}</div></td>
                        </tr>`;
                });
                const missing = this.state.limit - data.length;
                if(missing > 0) { for(let i=0; i<missing; i++) tbody.innerHTML += this.getEmptyRowHTML(8); }
            },

            renderPaginationHistory() {
                const totalPages = Math.ceil(this.state.total / this.state.limit);
                document.getElementById('hist-page-info').textContent = `Página ${this.state.page} de ${totalPages || 1}`;
                document.getElementById('hist-btn-prev').disabled = this.state.page === 1;
                document.getElementById('hist-btn-next').disabled = this.state.page >= totalPages || totalPages === 0;
            },
            prevPageHistory() { if (this.state.page > 1) this.loadHistory(this.state.page - 1); },
            nextPageHistory() { const totalPages = Math.ceil(this.state.total / this.state.limit); if (this.state.page < totalPages) this.loadHistory(this.state.page + 1); },

            // --- USERS MANAGEMENT (SETTINGS) ---
            async loadUsers() {
                try {
                    const res = await this.fetchAPI('/api/users');
                    const json = await res.json();
                    const tbody = document.getElementById('users-table-body');
                    tbody.innerHTML = '';
                    if(!json.data) return;
                    
                    json.data.forEach(u => {
                        const roleLabel = u.role === 'admin' ? 'Administrador' : 'Consultor';
                        tbody.innerHTML += `
                            <tr>
                                <td>${u.full_name}</td>
                                <td>${u.username}</td>
                                <td>${u.position || '-'}</td>
                                <td><span class="badge ${u.role === 'admin' ? 'pending' : 'operativo'}">${roleLabel}</span></td>
                                <td style="text-align:center;">
                                    <button class="action-btn edit" onclick="app.openUserModal(${u.id})"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                                </td>
                            </tr>
                        `;
                    });
                } catch(e) { console.error(e); }
            },

            openUserModal(id) {
                const user = this.state.users.find(u => u.id === id);
                if(!user) return;
                
                const overlay = document.getElementById('modal-overlay');
                const title = document.getElementById('modal-title');
                const body = document.getElementById('modal-body-content');
                const footer = document.getElementById('modal-footer-content');
                
                title.textContent = 'Editar Usuario';
                body.innerHTML = document.getElementById('tmpl-edit-user').innerHTML;
                
                document.getElementById('user-fullname').value = user.full_name;
                document.getElementById('user-name').value = user.username;
                document.getElementById('user-position').value = user.position || '';
                document.getElementById('user-role').value = user.role;
                
                // Allow self-edit of everything, but check rules
                footer.innerHTML = `
                    <button class="btn-secondary" onclick="app.closeModal()">Cancelar</button>
                    <button class="btn-primary" onclick="app.submitUserEdit(${id})">Guardar Cambios</button>
                `;
                overlay.classList.add('open');
            },

            async submitUserEdit(id) {
                const payload = {
                    full_name: document.getElementById('user-fullname').value,
                    username: document.getElementById('user-name').value,
                    position: document.getElementById('user-position').value,
                    role: document.getElementById('user-role').value,
                    password: document.getElementById('user-password').value
                };
                
                if(!payload.full_name || !payload.username || !payload.role) { alert("Complete los campos obligatorios"); return; }
                
                try {
                    const res = await this.fetchAPI(`/api/users?id=${id}`, { method: 'PUT', body: JSON.stringify(payload) });
                    if(res.ok) {
                        this.closeModal();
                        this.loadUsers();
                        this.loadGlobalData(); // Refresh current user info if self-edit
                    } else {
                        const json = await res.json();
                        alert("Error: " + (json.message || "No se pudo actualizar"));
                    }
                } catch(e) { alert("Error de conexión"); }
            },

            async openModal(type, id = null) {
                const overlay = document.getElementById('modal-overlay');
                const title = document.getElementById('modal-title');
                const body = document.getElementById('modal-body-content');
                const footer = document.getElementById('modal-footer-content');
                const today = new Date().toISOString().split("T")[0];

                if (type === 'add-ticket') {
                    title.textContent = 'Nuevo Ingreso a Taller';
                    body.innerHTML = document.getElementById('tmpl-add-ticket').innerHTML;
                    footer.innerHTML = `<button class="btn-secondary" onclick="app.closeModal()">Cancelar</button><button class="btn-primary" onclick="app.submitTicket()">Guardar Ingreso</button>`;
                    this.initCharCounter('details-in');
                    document.getElementById('date-in').value = today;
                    this.populateSelect('sel-building', this.state.locations.buildings);
                } else if (type === 'edit') {
                    const data = this.state.workshopData.find(t => t.id === id);
                    if (!data) return;
                    this.state.currentTicketId = id;
                    title.textContent = 'Editar Ingreso';
                    body.innerHTML = document.getElementById('tmpl-edit-ticket').innerHTML;
                    document.getElementById('edit-building').value = data.building || '-/-';
                    document.getElementById('edit-floor').value = data.floor || '-/-';
                    document.getElementById('edit-area').value = data.area || '-/-';
                    document.getElementById('edit-room').value = data.room || '-/-';
                    const devInfo = [data.device_brand, data.device_model, data.device_os, data.device_cpu, data.device_arch, data.device_serial].filter(Boolean).join(" - ");
                    document.getElementById('edit-device-info').innerHTML = `<strong>${data.device_type}</strong><br>${devInfo}`;
                    document.getElementById('edit-date-in').value = data.date_in;
                    document.getElementById('edit-details-in').value = data.details_in;
                    this.initCharCounter('edit-details-in');
                    footer.innerHTML = `<button class="btn-secondary" onclick="app.closeModal()">Cancelar</button><button class="btn-primary" onclick="app.submitEdit()">Guardar Cambios</button>`;
                } else if (type === 'finalize') {
                    const data = this.state.workshopData.find(t => t.id === id);
                    if (!data) return;
                    this.state.currentTicketId = id;
                    title.textContent = 'Finalizar Ticket';
                    body.innerHTML = document.getElementById('tmpl-finalize-ticket').innerHTML;
                    const deviceInfoStr = [data.device_brand, data.device_model, data.device_os, data.device_cpu, data.device_arch, data.device_serial].filter(Boolean).join(" - ");
                    document.getElementById('fin-device-info').innerHTML = `${data.device_type} - ` + deviceInfoStr;
                    const loc = [data.building, data.floor, data.area, data.room].filter(Boolean).join(" > ");
                    document.getElementById('fin-location-info').textContent = loc;
                    document.getElementById('fin-problem-info').textContent = data.details_in;
                    const dateOut = document.getElementById('fin-date-out'); dateOut.value = today; dateOut.min = data.date_in;
                    this.initCharCounter('fin-details-out');
                    footer.innerHTML = `<button class="btn-secondary" onclick="app.closeModal()">Cancelar</button><button class="btn-primary" onclick="app.submitFinalize()">Finalizar Ticket</button>`;
                } else if (type === 'delete') {
                    this.state.currentTicketId = id;
                    title.textContent = 'Eliminar Registro';
                    body.innerHTML = document.getElementById('tmpl-delete-confirm').innerHTML;
                    footer.innerHTML = `<button class="btn-secondary" onclick="app.closeModal()">Cancelar</button><button class="btn-danger" onclick="app.confirmDelete()">Sí, Eliminar</button>`;
                } else if (type === 'delete-ticket') {
                    this.state.currentTicketId = id;
                    title.textContent = 'Eliminar Historial';
                    body.innerHTML = document.getElementById('tmpl-delete-confirm').innerHTML;
                    footer.innerHTML = `<button class="btn-secondary" onclick="app.closeModal()">Cancelar</button><button class="btn-danger" onclick="app.confirmDeleteTicketFromHistory()">Sí, Eliminar</button>`;
                } else if (type === 'view-ticket') {
                    const data = this.state.historyData.find(t => t.id === id);
                    if(!data) return;
                    title.textContent = 'Detalles del Servicio';
                    body.innerHTML = document.getElementById('tmpl-view-ticket').innerHTML;
                    footer.innerHTML = `<button class="btn-secondary" onclick="app.closeModal()">Cerrar</button>`;
                    const setTxt = (id, val) => document.getElementById(id).textContent = val || '-/-';
                    setTxt('vt-type', data.device_type);
                    setTxt('vt-brand-model', `${data.device_brand || '-/-'} ${data.device_model || '-/-'}`);
                    setTxt('vt-code', data.device_code);
                    setTxt('vt-serial', data.device_serial);
                    setTxt('vt-location', [data.building, data.floor, data.area, data.room].filter(Boolean).join(" > "));
                    setTxt('vt-date-in', this.fmtDate(data.date_in));
                    setTxt('vt-date-out', this.fmtDate(data.date_out));
                    setTxt('vt-status', data.status === 'repaired' ? 'Reparado' : 'No Reparado');
                    setTxt('vt-details-in', data.details_in);
                    setTxt('vt-details-out', data.details_out);
                } else if (type === 'add-device' || type === 'edit-device') {
                    const isEdit = type === 'edit-device';
                    this.state.currentDeviceId = isEdit ? id : null;
                    title.textContent = isEdit ? 'Editar Equipo' : 'Registrar Nuevo Equipo';
                    body.innerHTML = document.getElementById('tmpl-device-form').innerHTML;
                    footer.innerHTML = `<button class="btn-secondary" onclick="app.closeModal()">Cancelar</button><button class="btn-primary" onclick="app.${isEdit ? 'submitEditDevice()' : 'submitDevice()'}">Guardar</button>`;
                    this.populateSelect('dev-type', this.state.specs.types);
                    this.populateSelect('dev-brand', this.state.specs.brands);
                    this.populateSelect('dev-os', this.state.specs.os);
                    this.populateSelect('dev-arch', this.state.specs.architectures);
                    this.populateSelect('dev-cpu', this.state.specs.processors);
                    this.populateSelect('dev-ram', this.state.specs.rams);
                    this.populateSelect('dev-storage', this.state.specs.storages);
                    this.populateSelect('sel-building', this.state.locations.buildings);

                    if (isEdit) {
                        const data = this.state.inventoryData.find(d => d.id === id);
                        if(data) {
                            document.getElementById('dev-code').value = data.code || '-/-';
                            document.getElementById('dev-serial').value = data.serial || '-/-';
                            document.getElementById('dev-details').value = data.details || '-/-';
                            this.setSelectByText('dev-type', data.type);
                            this.setSelectByText('dev-brand', data.brand);
                            this.filterModels(document.getElementById('dev-brand').value);
                            this.setSelectByText('dev-model', data.model);
                            this.setSelectByText('dev-os', data.os);
                            this.setSelectByText('dev-arch', data.arch);
                            this.setSelectByText('dev-cpu', data.cpu);
                            this.setSelectByText('dev-ram', data.ram);
                            this.setSelectByText('dev-storage', data.storage);
                            
                            // --- AUTO-FILL FIX START (Using IDs) ---
                            if (data.id_building) {
                                document.getElementById('sel-building').value = data.id_building;
                                app.handleBuildingChange(data.id_building);
                            }
                            if (data.id_floor) {
                                document.getElementById('sel-floor').value = data.id_floor;
                                app.handleFloorChange(data.id_floor);
                            }
                            if (data.id_area) {
                                document.getElementById('sel-area').value = data.id_area;
                                app.handleAreaChange(data.id_area);
                            }
                            if (data.id_room) {
                                document.getElementById('sel-room').value = data.id_room;
                            }
                            // --- AUTO-FILL FIX END ---
                        }
                    }
                } else if (type === 'view-device') {
                    const data = this.state.inventoryData.find(d => d.id === id);
                    if (!data) return;
                    title.textContent = 'Detalles del Equipo';
                    body.innerHTML = document.getElementById('tmpl-view-device').innerHTML;
                    footer.innerHTML = `<button class="btn-secondary" onclick="app.closeModal()">Cerrar</button>`;
                    const setTxt = (id, val) => document.getElementById(id).textContent = val || '-/-';
                    setTxt('view-type', data.type);
                    setTxt('view-brand', data.brand);
                    setTxt('view-model', data.model);
                    setTxt('view-code', data.code);
                    setTxt('view-serial', data.serial);
                    const loc = [data.building, data.floor, data.area, data.room].filter(Boolean).join(" > ");
                    setTxt('view-location', loc);
                    setTxt('view-os', data.os);
                    setTxt('view-cpu', data.cpu);
                    setTxt('view-ram', data.ram);
                    setTxt('view-storage', data.storage);
                    setTxt('view-arch', data.arch);
                    setTxt('view-details', data.details);
                } else if (type === 'delete-device') {
                    this.state.currentDeviceId = id;
                    title.textContent = 'Eliminar Equipo';
                    body.innerHTML = document.getElementById('tmpl-delete-confirm').innerHTML;
                    footer.innerHTML = `<button class="btn-secondary" onclick="app.closeModal()">Cancelar</button><button class="btn-danger" onclick="app.confirmDeleteDevice()">Sí, Eliminar</button>`;
                }
                overlay.classList.add('open');
            },

            setSelectByText(id, text) {
                const sel = document.getElementById(id);
                if (!text || !sel) return;
                for (let i = 0; i < sel.options.length; i++) { if (sel.options[i].text === text) { sel.selectedIndex = i; break; } }
            },
            
            filterModels(brandId) {
                const sel = document.getElementById('dev-model');
                sel.innerHTML = '<option value="">Seleccione...</option>';
                sel.disabled = true;
                if(!brandId) return;
                const models = this.state.specs.models.filter(m => m.parent_id == brandId);
                if(models.length > 0) { models.forEach(m => sel.innerHTML += `<option value="${m.id}">${m.value}</option>`); sel.disabled = false; } else { sel.innerHTML = '<option value="">Sin modelos registrados</option>'; }
            },
            
            async submitDevice() {
                const getVal = (id) => document.getElementById(id).value;
                const payload = {
                    code: getVal('dev-code'), serial: getVal('dev-serial'), id_type: parseInt(getVal('dev-type')),
                    id_brand: parseInt(getVal('dev-brand')) || null, id_model: parseInt(getVal('dev-model')) || null, id_os: parseInt(getVal('dev-os')) || null, id_ram: parseInt(getVal('dev-ram')) || null, id_storage: parseInt(getVal('dev-storage')) || null, id_processor: parseInt(getVal('dev-cpu')) || null, arch: getVal('dev-arch') || null, details: getVal('dev-details')
                };
                if(!payload.id_type) { document.getElementById('dev-form-error').textContent = 'El Tipo es obligatorio.'; return; }
                const areaId = getVal('sel-area'); const roomId = getVal('sel-room');
                if(!areaId) { document.getElementById('dev-form-error').textContent = 'La ubicación (Área) es obligatoria.'; return; }
                payload.id_area = parseInt(areaId); payload.id_room = parseInt(roomId) || null;
                try {
                    const res = await this.fetchAPI('/api/devices', { method: 'POST', body: JSON.stringify(payload) });
                    if(res && res.ok) { this.closeModal(); this.loadInventory(1); } else { document.getElementById('dev-form-error').textContent = 'Error al registrar el equipo.'; }
                } catch(e) { console.error(e); }
            },
            
            async submitEditDevice() {
                const id = this.state.currentDeviceId;
                const getVal = (id) => document.getElementById(id).value;
                const payload = {
                    code: getVal('dev-code'), serial: getVal('dev-serial'), id_type: parseInt(getVal('dev-type')), id_brand: parseInt(getVal('dev-brand')) || null, id_model: parseInt(getVal('dev-model')) || null, id_os: parseInt(getVal('dev-os')) || null, id_ram: parseInt(getVal('dev-ram')) || null, id_storage: parseInt(getVal('dev-storage')) || null, id_processor: parseInt(getVal('dev-cpu')) || null, arch: getVal('dev-arch') || null, details: getVal('dev-details')
                };
                if(!payload.id_type) { document.getElementById('dev-form-error').textContent = 'El Tipo es obligatorio.'; return; }
                const areaId = getVal('sel-area'); const roomId = getVal('sel-room');
                if(!areaId) { document.getElementById('dev-form-error').textContent = 'La ubicación (Área) es obligatoria.'; return; }
                payload.id_area = parseInt(areaId); payload.id_room = parseInt(roomId) || null;
                try {
                    const res = await this.fetchAPI(`/api/devices?id=${id}`, { method: 'PUT', body: JSON.stringify(payload) });
                    if(res && res.ok) { this.closeModal(); this.loadInventory(this.state.page || 1); } else { document.getElementById('dev-form-error').textContent = 'Error al actualizar.'; }
                } catch(e) { console.error(e); }
            },
            
            async confirmDeleteDevice() {
                const id = this.state.currentDeviceId;
                const res = await this.fetchAPI(`/api/devices?id=${id}`, { method: 'DELETE' });
                if(res && res.ok) { this.closeModal(); this.loadInventory(1); } else if(res && res.status === 409) { alert("No se puede eliminar este equipo porque tiene historial en Taller."); this.closeModal(); } else { alert("Error al eliminar el equipo."); }
            },
            
            async confirmDeleteTicketFromHistory() {
                const id = this.state.currentTicketId;
                const res = await this.fetchAPI(`/api/tickets?id=${id}`, { method: 'DELETE' });
                if(res && res.ok) { this.closeModal(); this.loadHistory(1); } else { alert("Error al eliminar el historial."); }
            },

            populateSelect(id, items) {
                const sel = document.getElementById(id);
                sel.innerHTML = '<option value="">Seleccione...</option>';
                if(items) items.forEach(i => sel.innerHTML += `<option value="${i.id}">${i.value}</option>`);
                sel.disabled = false;
            },
            handleBuildingChange(val) { this.state.selBuilding = val; this.resetSelects(['sel-floor', 'sel-area', 'sel-room', 'sel-device']); if(!val) return; const floors = this.state.locations.floors.filter(f => f.parent_id == val); this.populateSelect('sel-floor', floors); },
            handleFloorChange(val) { this.state.selFloor = val; this.resetSelects(['sel-area', 'sel-room', 'sel-device']); if(!val) return; const areas = this.state.locations.areas.filter(a => a.parent_id == val); this.populateSelect('sel-area', areas); },
            handleAreaChange(val) { this.state.selArea = val; this.resetSelects(['sel-room', 'sel-device']); if(!val) return; const rooms = this.state.locations.rooms.filter(r => r.parent_id == val); this.populateSelect('sel-room', rooms); if(document.getElementById('sel-device')) this.loadDevicesForTicket(val, null); },
            handleRoomChange(val) { this.state.selRoom = val; if(document.getElementById('sel-device')) this.loadDevicesForTicket(this.state.selArea, val); },
            resetSelects(ids) { ids.forEach(id => { const sel = document.getElementById(id); if(sel) { sel.innerHTML = '<option value="">Seleccione...</option>'; sel.disabled = true; } }); },

            async loadDevicesForTicket(areaId, roomId) {
                const sel = document.getElementById('sel-device');
                sel.disabled = true;
                sel.innerHTML = '<option>Cargando...</option>';
                let qs = `limit=50&id_area=${areaId}`;
                if(roomId) qs += `&id_room=${roomId}`;
                qs += `&status=operational`;
                try {
                    const res = await this.fetchAPI(`/api/devices?${qs}`);
                    const json = await res.json();
                    if(json.data && json.data.length > 0) {
                        sel.innerHTML = '<option value="">Seleccione Dispositivo... (Tipo - Código - Marca - Modelo)</option>';
                        json.data.forEach(d => {
							let label = `${d.type} - ${d.code || '-/-'} - ${d.brand || '-/-'} ${d.model || '-/-'}`;
							label += " - " + [d.os, d.cpu, d.arch].filter(Boolean).join(" - ");
							sel.innerHTML += `<option value="${d.id}">${label}</option>`; 
						});
                        sel.disabled = false;
                    } else { sel.innerHTML = '<option value="">No hay equipos operativos aquí</option>'; }
                } catch(e) { console.error(e); }
            },

            async submitTicket() {
                const devId = document.getElementById('sel-device').value; const date = document.getElementById('date-in').value; const det = document.getElementById('details-in').value;
                if(!devId || !date || !det.trim()) { document.getElementById('form-error').textContent = 'Complete los campos obligatorios'; return; }
                const res = await this.fetchAPI('/api/tickets', { method: 'POST', body: JSON.stringify({ id_device: parseInt(devId), date_in: date, details_in: det }) });
                if(res && res.ok) { this.closeModal(); this.navigate('workshop'); } else { document.getElementById('form-error').textContent = 'Error al guardar'; }
            },
            
            async submitEdit() {
                const id = this.state.currentTicketId; const date = document.getElementById('edit-date-in').value; const det = document.getElementById('edit-details-in').value;
                const res = await this.fetchAPI(`/api/tickets?id=${id}`, { method: 'PUT', body: JSON.stringify({ date_in: date, details_in: det }) });
                if(res && res.ok) { this.closeModal(); this.loadWorkshop(); }
            },
            
            async submitFinalize() {
                const id = this.state.currentTicketId; const status = document.getElementById('fin-status').value; const dateOut = document.getElementById('fin-date-out').value; const detailsOut = document.getElementById('fin-details-out').value;
                if(!dateOut || !detailsOut.trim()) { document.getElementById('fin-error').textContent = 'Complete fecha y detalles de salida'; return; }
                const res = await this.fetchAPI(`/api/tickets?id=${id}`, { method: 'PUT', body: JSON.stringify({ status: status, date_out: dateOut, details_out: detailsOut }) });
                if(res && res.ok) { this.closeModal(); this.loadWorkshop(); this.loadDashboardData(); }
            },
            
            async confirmDelete() {
                const id = this.state.currentTicketId;
                const res = await this.fetchAPI(`/api/tickets?id=${id}`, { method: 'DELETE' });
                if(res && res.ok) { this.closeModal(); this.loadWorkshop(); }
            },

            initCharCounter(id) { const el = document.getElementById(id); if(!el) return; const ctr = el.nextElementSibling; el.oninput = () => ctr.textContent = `${el.value.length}/300`; },
            closeModal() { document.getElementById('modal-overlay').classList.remove('open'); },
            
            async handleLogin() {
                const u = document.getElementById('username').value; const p = document.getElementById('password').value; const r = document.getElementById('role').value;
                try {
                    const res = await fetch('/api/login', { method: 'POST', body: JSON.stringify({ username: u, password: p, role: r }) });
                    const json = await res.json();
                    if(json.token) {
                        this.state.user = { username: json.username, full_name: json.full_name, role: json.role }; this.state.token = json.token;
                        localStorage.setItem('sart_user', JSON.stringify(this.state.user)); localStorage.setItem('sart_token', this.state.token); this.showApp();
                    } else { document.getElementById('login-error').textContent = 'Credenciales inválidas'; }
                } catch(e) { document.getElementById('login-error').textContent = 'Error de conexión'; }
            },
            
            showLogin() { document.getElementById('login-view').classList.remove('hidden'); document.getElementById('app-view').classList.add('hidden'); },
            showApp() {
                document.getElementById('login-view').classList.add('hidden'); document.getElementById('app-view').classList.remove('hidden');
                if (this.state.user) {
                    document.getElementById('user-display-name').textContent = this.state.user.full_name;
                    document.getElementById('user-display-role').textContent = this.state.user.role === 'admin' ? 'ADMINISTRADOR' : 'CONSULTOR';
                    
                    const isAdmin = this.state.user.role === 'admin';
                    
                    // Show/Hide Role Restricted Elements
                    document.querySelectorAll('[data-role-restricted="admin"]').forEach(el => {
                        if (!isAdmin) el.classList.add('hidden');
                        else el.classList.remove('hidden');
                    });
                    
                    // Specific class for admin-only buttons (like Add/Delete) inside dynamic tables
                    // We handle dynamic content inside render methods, but static UI can use this too
                    document.querySelectorAll('.admin-only').forEach(el => {
                        if (!isAdmin) el.classList.add('hidden');
                        else el.classList.remove('hidden');
                    });
                }
                this.loadGlobalData().then(() => this.navigate('home'));
            },
            logout() { localStorage.clear(); this.state.user = null; this.state.token = null; window.location.reload(); },
            
            async loadDashboardData() {
                try {
                    const res = await this.fetchAPI('/api/stats'); const json = await res.json();
                    if(json) { document.getElementById('kpi-workshop').textContent = json.in_workshop; document.getElementById('kpi-repaired').textContent = json.repaired; document.getElementById('kpi-month').textContent = json.total_month; }
                } catch (err) { console.error(err); }
            },
            
            async printReport(mode, singleId) {
                let data = [];
                if (mode === 'single') { const found = this.state.historyData.find(t => t.id === singleId); data = found ? [found] : []; } else {
                    const search = document.getElementById('hist-search').value; const type = document.getElementById('hist-filter-type').value; const brand = document.getElementById('hist-filter-brand').value; const status = document.getElementById('hist-filter-status').value; const after = document.getElementById('hist-date-after').value; const before = document.getElementById('hist-date-before').value;
                    let qs = `page=1&limit=10000`;
                    if(mode === 'filtered') { if(status) qs += `&status=${status}`; else qs += `&status=history`; if(search) qs += `&search=${encodeURIComponent(search)}`; if(type) qs += `&type=${type}`; if(brand) qs += `&brand=${brand}`; if(after) qs += `&after=${after}`; if(before) qs += `&before=${before}`; } else { qs += `&status=history`; }
                    try { const res = await this.fetchAPI('/api/tickets?' + qs); const json = await res.json(); data = json.data || []; } catch(e) { alert("Error generando reporte"); return; }
                }
                if (!data || data.length === 0) { alert("No hay datos para generar el reporte."); return; }
                const { leftName, leftJob, rightName, rightJob } = this.getSignatures();
                const URL_LOGO_IZQUIERDO = '/static/public/logo-fuerzas-armadas.avif'; const URL_LOGO_DERECHO = '/static/public/logo-unefa.avif';
                
                if (mode === 'single' && data.length === 1) {
                    const t = data[0]; const fullDate = new Date().toLocaleDateString('es-VE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    const reportContent = `
                        <div class="page">
                            <div class="header-container"><div class="logo-box"><img src="${URL_LOGO_IZQUIERDO}" alt="Logo Izq"></div><div class="header-text">MINISTERIO DEL PODER POPULAR PARA LA DEFENSA<br>UNIVERSIDAD NACIONAL EXPERIMENTAL POLITÉCNICA DE LA FUERZA ARMADA<br>NÚCLEO MIRANDA - SEDE LOS TEQUES<br>COORDINACIÓN DE TECNOLOGÍA Y SOPORTE<br>TECNOLOGÍA, INFORMACIÓN Y COMUNICACIÓN<br>SOPORTE TÉCNICO</div><div class="logo-box"><img src="${URL_LOGO_DERECHO}" alt="Logo Der"></div></div>
                            <div class="section-title">COMPROBANTE DE SERVICIO TÉCNICO</div><div style="text-align:right; font-size:9pt; margin-bottom:15px;">Fecha de Impresión: ${fullDate}</div>
                            <div class="section-header">1. Datos del Equipo</div>
                            <table class="info-table"><tr><td class="label">Tipo:</td><td>${t.device_type}</td><td class="label">Marca:</td><td>${t.device_brand || '-/-'}</td></tr><tr><td class="label">Modelo:</td><td>${t.device_model || '-/-'}</td><td class="label">Código Bien:</td><td>${t.device_code || '-/-'}</td></tr><tr><td class="label">Serial:</td><td>${t.device_serial || '-/-'}</td><td class="label">Procesador:</td><td>${t.device_cpu || '-/-'}</td></tr><tr><td class="label">RAM:</td><td>${t.device_ram || '-/-'}</td><td class="label">Almacenamiento:</td><td>${t.device_storage || '-/-'}</td></tr></table>
                            <div class="section-header" style="margin-top:10px;">2. Ubicación de Origen</div><table class="info-table"><tr><td class="label">Edificio:</td><td>${t.building || '-/-'}</td><td class="label">Piso:</td><td>${t.floor || '-/-'}</td></tr><tr><td class="label">Área:</td><td>${t.area || '-/-'}</td><td class="label">Habitación:</td><td>${t.room || '-/-'}</td></tr></table>
                            <div class="section-header" style="margin-top:10px;">3. Detalles del Servicio</div><table class="info-table"><tr><td class="label">Fecha Ingreso:</td><td>${this.fmtDate(t.date_in)}</td><td class="label">Fecha Salida:</td><td>${t.date_out ? this.fmtDate(t.date_out) : 'PENDIENTE'}</td></tr><tr><td class="label">Estado Final:</td><td colspan="3">${t.status === 'repaired' ? 'REPARADO' : (t.status === 'unrepaired' ? 'NO REPARADO' : 'EN TALLER')}</td></tr></table>
                            <div class="section-header" style="margin-top:10px;">4. Motivo de Ingreso / Falla Reportada</div><div class="text-block">${t.details_in || 'Sin detalles registrados.'}</div>
                            <div class="section-header" style="margin-top:10px;">5. Informe Técnico de Salida / Solución</div><div class="text-block" style="min-height:80px;">${t.details_out || 'Sin informe de salida.'}</div>
							<div class="signatures"><div class="sign-box"><div style="margin-top:5px; margin-bottom:2px; font-weight:normal;">${leftName}</div>${leftJob}<br><span style="font-weight:normal;font-size:8pt;">FIRMA Y SELLO</span></div><div class="sign-box"><div style="margin-top:5px; margin-bottom:2px; font-weight:normal;">${rightName}</div>${rightJob}<br><span style="font-weight:normal;font-size:8pt;">FIRMA Y SELLO</span></div></div>
                            <div class="footer-info"><span>Sistema S.A.R.T. - Comprobante Digital</span><span>Ticket #${t.id}</span></div>
                        </div>`;
                    const iframe = document.createElement('iframe'); iframe.style.position = 'absolute'; iframe.style.width = '0px'; iframe.style.height = '0px'; iframe.style.border = 'none'; document.body.appendChild(iframe);
                    const doc = iframe.contentWindow.document; doc.open();
                    doc.write(`<!DOCTYPE html><html><head><title>Comprobante SART</title><style>@page { size: letter; margin: 0; } body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #ccc; } .page { width: 215.9mm; height: 279.4mm; background: white; margin: 0 auto; padding: 15mm; position: relative; page-break-after: always; box-sizing: border-box; } .header-container { display: flex; justify-content: space-between; align-items: center; height: 100px; margin-bottom: 20px; padding-bottom: 10px; } .logo-box { width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; } .logo-box img { width: 100%; height: 100%; object-fit: contain; } .header-text { flex: 1; text-align: center; font-weight: bold; font-size: 8pt; line-height: 1.2; } .section-title { font-weight: bold; margin-bottom: 15px; font-size: 12pt; text-align: center; text-decoration: underline; text-transform: uppercase; } .section-header { background: #eee; padding: 5px; font-weight: bold; font-size: 9pt; border: 1px solid #000; border-bottom: none; margin-top: 5px; } .info-table { width: 100%; border-collapse: collapse; font-size: 9pt; margin-bottom: 10px; } .info-table td { border: 1px solid black; padding: 4px 8px; } .info-table .label { background: #f9f9f9; font-weight: bold; width: 15%; } .text-block { border: 1px solid black; padding: 8px; font-size: 9pt; min-height: 40px; margin-bottom: 10px; text-align: justify; } .signatures { margin-top: 50px; display: flex; justify-content: space-around; } .sign-box { width: 40%; text-align: center; border-top: 1px solid black; font-weight: bold; font-size: 9pt; } .footer-info { position: absolute; bottom: 15mm; left: 15mm; right: 15mm; display: flex; justify-content: space-between; font-size: 8pt; border-top: 1px solid #ccc; padding-top: 5px; color: #666; } </style></head><body>${reportContent}</body></html>`);
                    doc.close(); iframe.contentWindow.focus(); setTimeout(() => { iframe.contentWindow.print(); document.body.removeChild(iframe); }, 500);
                    return;
                }
                
                let reportContent = ''; const ROWS_PER_PAGE = 12; const totalPages = Math.ceil(data.length / ROWS_PER_PAGE);
                for (let i = 0; i < totalPages; i++) {
                    const pageData = data.slice(i * ROWS_PER_PAGE, (i + 1) * ROWS_PER_PAGE);
                    const headerHTML = `<div class="header-container"><div class="logo-box"><img src="${URL_LOGO_IZQUIERDO}" alt="Logo Izq"></div><div class="header-text">MINISTERIO DEL PODER POPULAR PARA LA DEFENSA<br>UNIVERSIDAD NACIONAL EXPERIMENTAL POLITÉCNICA DE LA FUERZA ARMADA<br>NÚCLEO MIRANDA - SEDE LOS TEQUES<br>COORDINACIÓN DE TECNOLOGÍA Y SOPORTE<br>TECNOLOGÍA, INFORMACIÓN Y COMUNICACIÓN<br>SOPORTE TÉCNICO</div><div class="logo-box"><img src="${URL_LOGO_DERECHO}" alt="Logo Der"></div></div><div class="section-title">REPORTE DE GESTIÓN DE SOPORTE TÉCNICO</div>`;
                    let rowsHTML = '';
                    pageData.forEach((t, idx) => { 
                        const num = (i * ROWS_PER_PAGE) + idx + 1; const location = `<strong>${t.area}</strong><br>${t.room || ''}`; const codeSerial = [t.device_code, t.device_serial].filter(Boolean).join(" - "); const equipo = `<b>${t.device_type}</b><br>${t.device_brand || '-/-'} ${t.device_model || '-/-'}<br><small>${codeSerial}</small>`; const statusLabel = t.status === 'repaired' ? 'REPARADO' : (t.status === 'unrepaired' ? 'NO REPARADO' : 'PENDIENTE');
                        rowsHTML += `<tr><td class="col-center">${num}</td><td class="col-center">${this.fmtDate(t.date_in)}</td><td class="col-center">${t.date_out ? this.fmtDate(t.date_out) : '-'}</td><td class="col-center">${equipo}</td><td class="col-center">${location}</td><td class="col-left" style="font-size:8pt;">${t.details_out || t.details_in || '-'}</td><td class="col-center" style="font-size:8pt;">${statusLabel}</td></tr>`; 
                    });
                    let signaturesHTML = ''; if (i === totalPages - 1) { signaturesHTML = `<div class="signatures"><div class="sign-box"><div style="margin-top:5px; margin-bottom:2px; font-weight:normal;">${leftName}</div>${leftJob}<br><span style="font-weight:normal;font-size:8pt;">FIRMA Y SELLO</span></div><div class="sign-box"><div style="margin-top:5px; margin-bottom:2px; font-weight:normal;">${rightName}</div>${rightJob}<br><span style="font-weight:normal;font-size:8pt;">FIRMA Y SELLO</span></div></div>`; }
                    reportContent += `<div class="page">${headerHTML}<table><thead><tr><th style="width:5%">N°</th><th style="width:10%">INGRESO</th><th style="width:10%">SALIDA</th><th style="width:20%">EQUIPO</th><th style="width:15%">UBICACIÓN</th><th style="width:30%">DETALLE / SOLUCIÓN</th><th style="width:10%">ESTADO</th></tr></thead><tbody>${rowsHTML}</tbody></table>${signaturesHTML}<div class="footer-info"><span>Sistema S.A.R.T.</span><span>Página ${i + 1} de ${totalPages}</span></div></div>`;
                }
                const iframe = document.createElement('iframe'); iframe.style.position = 'absolute'; iframe.style.width = '0px'; iframe.style.height = '0px'; iframe.style.border = 'none'; document.body.appendChild(iframe);
                const doc = iframe.contentWindow.document; doc.open(); 
                doc.write(`<!DOCTYPE html><html><head><title>Reporte SART</title><style>@page { size: letter; margin: 0; } body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #ccc; } .page { width: 215.9mm; height: 279.4mm; background: white; margin: 0 auto; padding: 15mm; position: relative; page-break-after: always; overflow: hidden; } .header-container { display: flex; justify-content: space-between; align-items: center; height: 110px; margin-bottom: 20px; padding-bottom: 10px; overflow: hidden; } .logo-box { width: 90px; height: 90px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; } .logo-box img { width: 100%; height: 100%; object-fit: contain; } .header-text { flex: 1; text-align: center; font-weight: bold; font-size: 8pt; line-height: 1.2; padding: 0 10px; } .section-title { font-weight: bold; margin-bottom: 10px; font-size: 11pt; text-align: center; text-decoration: underline; } table { width: 100%; border-collapse: collapse; font-size: 9pt; } th, td { border: 1px solid black; padding: 4px; vertical-align: middle; } th { background: #f0f0f0; text-align: center; font-weight: bold; } .col-center { text-align: center; } .col-left { text-align: left; } .signatures { margin-top: 50px; display: flex; justify-content: space-around; } .sign-box { width: 40%; text-align: center; border-top: 1px solid black; padding-top: 5px; font-weight: bold; font-size: 9pt; } .footer-info { position: absolute; bottom: 15mm; left: 15mm; right: 15mm; display: flex; justify-content: space-between; font-size: 8pt; border-top: 1px solid #ccc; padding-top: 5px; } </style></head><body>${reportContent}</body></html>`); 
                doc.close(); iframe.contentWindow.focus(); setTimeout(() => { iframe.contentWindow.print(); document.body.removeChild(iframe); }, 500);
            }
        };
        document.addEventListener('DOMContentLoaded', () => { app.init(); });
    </script>
</body>
</html>