<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SART - Sistema de Soporte y Reporte Tecnológico UNEFA</title>
    <style>
        /* --- VARIABLES --- */
        :root {
            --color-primary: #003366;
            --color-primary-dark: #002244;
            --color-secondary: #D4AF37;
            --color-danger: #ce1126;
            --color-success: #10B981;
            --color-warning: #f59e0b;
            --color-dark: #1f2937;
            --color-bg: #f3f4f6;
            --color-white: #ffffff;
            --color-text: #374151;
            --color-text-light: #9CA3AF;
            --border-color: #e5e7eb;

            --sidebar-width: 260px;
            --header-height: 60px;
            --radius: 8px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background-color: var(--color-bg); color: var(--color-text); height: 100vh; overflow: hidden; }

        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .w-full { width: 100%; }
        
        /* LOGIN STYLES */
        .login-wrapper { position: fixed; inset: 0; background-color: var(--color-primary); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-box { background: var(--color-white); padding: 2.5rem; border-radius: 12px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2); }
        .logos-container { display: flex; justify-content: center; gap: 20px; margin-bottom: 1.5rem; }
        .logo-img { height: 80px; width: auto; object-fit: contain; }
        .form-group { margin-bottom: 1rem; text-align: left; }
        .form-label { display: block; font-size: 0.8rem; font-weight: bold; color: var(--color-primary); margin-bottom: 0.25rem; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius); outline: none; transition: border 0.2s; background-color: white; font-size: 0.95rem; }
        input:focus, select:focus, textarea:focus { border-color: var(--color-secondary); box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2); }
        button { cursor: pointer; border: none; border-radius: var(--radius); font-weight: 600; padding: 0.75rem 1.2rem; transition: background 0.2s; font-size: 1rem; }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover { background-color: var(--color-primary-dark); }
        .btn-secondary { background-color: var(--color-white); border: 1px solid var(--border-color); color: var(--color-text); }
        .btn-secondary:hover { background-color: #f9fafb; }
        .btn-danger { background-color: var(--color-danger); color: white; }
        .btn-danger:hover { background-color: #a30e1e; }
        .error-msg { color: var(--color-danger); font-size: 0.85rem; margin-top: 1rem; min-height: 1.2rem; font-weight: bold; }

        /* APP LAYOUT */
        .app-layout { display: flex; height: 100%; }
        .sidebar { width: var(--sidebar-width); background-color: var(--color-primary); color: var(--color-white); display: flex; flex-direction: column; transition: transform 0.3s; z-index: 50; }
        .sidebar-header { height: var(--header-height); display: flex; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.2); font-weight: bold; letter-spacing: 1px; gap: 10px; font-size: 1.1rem; }
        .sidebar-logo-small { height: 28px; width: auto; }
        
        .sidebar-menu { list-style: none; padding-top: 1rem; flex: 1; }
        .nav-link { padding: 0.8rem 1.5rem; display: flex; align-items: center; gap: 12px; cursor: pointer; color: rgba(255,255,255,0.7); text-decoration: none; transition: 0.2s; font-size: 0.95rem; border-left: 4px solid transparent; }
        .nav-link:hover, .nav-link.active { background-color: rgba(212, 175, 55, 0.15); color: var(--color-secondary); border-left-color: var(--color-secondary); }
        .nav-icon { width: 20px; height: 20px; stroke-width: 2; stroke: currentColor; fill: none; stroke-linecap: round; stroke-linejoin: round; }
        
        .sidebar-footer { padding: 1rem; background-color: rgba(0,0,0,0.2); }
        .logout-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; width: 100%; justify-content: center; display: flex; align-items: center; gap: 8px; }
        .logout-btn:hover { background: rgba(255,255,255,0.2); }

        .main-content { flex: 1; display: flex; flex-direction: column; background-color: var(--color-bg); overflow: hidden; }
        .top-header { height: var(--header-height); background: var(--color-white); display: flex; align-items: center; justify-content: space-between; padding: 0 2rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .header-title { color: var(--color-primary); font-size: 1.25rem; font-weight: bold; }
        .content-area { padding: 2rem; overflow-y: auto; flex: 1; }

        /* DASHBOARD GRID */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-top: 1rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow); border-top: 4px solid transparent; display: flex; flex-direction: column; }
        .stat-card.blue { border-color: var(--color-primary); }
        .stat-card.green { border-color: var(--color-success); }
        .stat-card.gold { border-color: var(--color-secondary); }
        .stat-label { font-size: 0.8rem; text-transform: uppercase; color: var(--color-text-light); font-weight: bold; letter-spacing: 0.5px; }
        .stat-value { font-size: 2.2rem; font-weight: 800; color: var(--color-text); margin-top: 0.5rem; }

        /* TABLAS Y PANELES DE DATOS */
        .filter-panel { background: white; padding: 1rem 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 1.5rem; display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap; }
        .search-box { flex: 1; min-width: 200px; }
        .data-panel { background: white; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border-color); display: flex; flex-direction: column; overflow-y: auto; }
        .table-container { overflow: auto; }
        
        .custom-table { width: 100%; border-collapse: collapse; text-align: left; font-size: 0.9rem; table-layout: fixed; }
        .custom-table thead { background-color: var(--color-primary); color: white; position: sticky; top: 0; z-index: 10; }
        .custom-table th { padding: 1rem; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; white-space: nowrap; }
        .custom-table td { padding: 1rem; border-bottom: 1px solid var(--border-color); color: var(--color-text); vertical-align: middle; }
        .custom-table tbody tr:hover { background-color: #f9fafb; }
        .text-muted { color: #9ca3af; font-style: italic; text-align: center; padding: 2rem; }

        /* Estilo Específico para Tabla Taller: Altura Fija de Fila */
        #workshop-table tbody tr { height: 95px; }

        /* UTILIDADES TABLA */
        .cell-truncate { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; display: block; }
        .cell-multiline { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; white-space: normal; }

        .badge { padding: 0.25rem 0.75rem; border-radius: 99px; font-size: 0.75rem; font-weight: 700; display: inline-block; text-align: center; min-width: 80px; }
        .badge.operativo { background-color: #D1FAE5; color: #059669; border: 1px solid #6EE7B7; }
        .badge.pending { background-color: #FEF3C7; color: #D97706; border: 1px solid #FCD34D; }

        /* ACCIONES TALLER */
        .action-btn { background: none; border: none; cursor: pointer; padding: 5px; border-radius: 4px; transition: background 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .action-btn:hover { background-color: #f3f4f6; }
        .action-btn.edit { color: var(--color-primary); }
        .action-btn.check { color: var(--color-success); }
        .action-btn.delete { color: var(--color-danger); }
        .actions-cell { display: flex; gap: 8px; }

        /* PAGINACIÓN */
        .pagination-controls { padding: 1rem; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .page-btn { padding: 0.5rem 1rem; border: 1px solid var(--border-color); background: white; cursor: pointer; border-radius: 4px; font-size: 0.9rem; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-btn:hover:not(:disabled) { background: #f3f4f6; }
        .page-info { font-size: 0.9rem; color: var(--color-text-light); display: flex; align-items: center; gap: 8px; }
        
        .page-input { width: 40px; padding: 0.25rem; text-align: center; border: 1px solid var(--border-color); border-radius: 4px; font-weight: bold; color: var(--color-primary); }

        /* MODAL */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-container { background: white; width: 90%; max-width: 700px; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); transform: translateY(20px); transition: transform 0.2s; display: flex; flex-direction: column; max-height: 85vh; }
        .modal-overlay.open .modal-container { transform: translateY(0); }
        .modal-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 1.1rem; font-weight: 700; color: var(--color-primary); }
        .btn-close-modal { background: transparent; border: none; font-size: 1.5rem; line-height: 1; cursor: pointer; color: var(--color-text-light); }
        .modal-body { padding: 1.5rem; overflow-y: auto; }
        .modal-footer { padding: 1.25rem 1.5rem; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 1rem; background-color: #f9fafb; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; }

        /* FORMULARIOS MODAL */
        .section-title { font-size: 0.9rem; color: var(--color-text-light); font-weight: 700; text-transform: uppercase; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 1rem; margin-top: 1rem; }
        .section-title:first-child { margin-top: 0; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        
        .char-counter { text-align: right; font-size: 0.8rem; color: var(--color-text-light); margin-top: 0.25rem; font-variant-numeric: tabular-nums; }
        .info-block { background: #f3f4f6; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.9rem; }
    </style>
</head>
<body>

    <!-- === LOGIN VIEW === -->
    <div id="login-view" class="login-wrapper">
        <div class="login-box">
            <div class="logos-container">
                <img src="/static/public/logo-unefa.avif" alt="UNEFA" class="logo-img">
            </div>
            <h2 style="color:var(--color-primary); margin-bottom: 0.5rem; font-weight: 800;">SART</h2>
            <p style="color:var(--color-text-light); margin-bottom: 2rem; font-size: 0.95rem;">Sistema de Soporte Tecnológico</p>
            <form id="login-form">
                <div class="form-group">
                    <label class="form-label">Rol de Usuario</label>
                    <select id="role" required>
                        <option value="admin">Administrador</option>
                        <option value="viewer">Consultor</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Usuario</label>
                    <input type="text" id="username" placeholder="admin / user" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Contraseña</label>
                    <input type="password" id="password" placeholder="••••" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 1rem;">INGRESAR AL SISTEMA</button>
                <div id="login-error" class="error-msg"></div>
            </form>
        </div>
    </div>

    <!-- === APP VIEW === -->
    <div id="app-view" class="app-layout hidden">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="/static/public/logo-unefa.avif" class="sidebar-logo-small">
                <span>SART UNEFA</span>
            </div>
            <ul class="sidebar-menu">
                <li><a class="nav-link active" onclick="app.navigate('home')"><svg class="nav-icon" viewBox="0 0 24 24"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg><span>Inicio</span></a></li>
                <li><a class="nav-link" onclick="app.navigate('workshop')"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg><span>Taller</span></a></li>
                <li><a class="nav-link" onclick="app.navigate('inventory')"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg><span>Inventario</span></a></li>
                <li><a class="nav-link" onclick="app.navigate('reports')"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg><span>Reportes</span></a></li>
                <li><a class="nav-link" onclick="app.navigate('data')"><svg class="nav-icon" viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s 9-1.34 9-3V5"/></svg><span>Gestión de Datos</span></a></li>
                <li data-role-restricted="admin"><a class="nav-link" onclick="app.navigate('settings')"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg><span>Configuración</span></a></li>
            </ul>
            <div class="sidebar-footer">
                <button onclick="app.logout()" class="logout-btn"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>Cerrar Sesión</button>
            </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <main class="main-content">
            <header class="top-header">
                <h2 style="color:var(--color-primary);" id="page-title">Inicio</h2>
                <div style="text-align: right;">
                    <div id="user-display-name" style="font-weight: 700; color: var(--color-primary); font-size: 0.95rem;">Usuario</div>
                    <div id="user-display-role" style="font-size: 0.8rem; color: var(--color-text-light);">Rol</div>
                </div>
            </header>

            <div class="content-area">
                
                <!-- SECCIÓN 1: DASHBOARD (HOME) -->
                <div id="section-home" class="section-view">
                    <h3 style="margin-bottom: 1.5rem; color: var(--color-text); font-weight: 600;">Resumen General</h3>
                    <div class="stats-grid">
                        <div class="stat-card blue">
                            <span class="stat-label">Equipos en Taller</span>
                            <div id="kpi-workshop" class="stat-value">--</div>
                        </div>
                        <div class="stat-card green">
                            <span class="stat-label">Reparados (Total)</span>
                            <div id="kpi-repaired" class="stat-value">--</div>
                        </div>
                        <div class="stat-card gold">
                            <span class="stat-label">Ingresos este Mes</span>
                            <div id="kpi-month" class="stat-value">--</div>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN 2: TALLER (FILTROS COMPLETOS) -->
                <div id="section-workshop" class="section-view hidden">
                    <div class="filter-panel">
                        <!-- FILA 1: Búsqueda Global -->
                        <div class="search-box" style="flex-basis: 100%; margin-bottom: 0.5rem;">
                            <label class="form-label">Búsqueda Global (Serial, Código, Marca)</label>
                            <input type="text" id="wk-search" placeholder="Escriba para buscar..." onkeyup="app.debounceLoadWorkshop()">
                        </div>

                        <!-- FILA 2: Filtros Específicos -->
                        <div style="flex: 1; min-width: 120px;">
                            <label class="form-label">Tipo</label>
                            <select id="wk-filter-type" onchange="app.loadWorkshop(1)"></select>
                        </div>
                        <div style="flex: 1; min-width: 120px;">
                            <label class="form-label">Marca</label>
                            <select id="wk-filter-brand" onchange="app.loadWorkshop(1)"></select>
                        </div>
                        <div style="flex: 1; min-width: 120px;">
                            <label class="form-label">SO</label>
                            <select id="wk-filter-os" onchange="app.loadWorkshop(1)"></select>
                        </div>
                        <div style="flex: 1; min-width: 120px;">
                            <label class="form-label">CPU</label>
                            <select id="wk-filter-cpu" onchange="app.loadWorkshop(1)"></select>
                        </div>
                        <div style="flex: 1; min-width: 120px;">
                            <label class="form-label">RAM</label>
                            <select id="wk-filter-ram" onchange="app.loadWorkshop(1)"></select>
                        </div>

                        <!-- Botón Acción -->
                        <div style="flex: 0 0 auto;">
                             <button class="btn-primary" onclick="app.openModal('add-ticket')">Nuevo Ingreso</button>
                        </div>
                    </div>
                    <div class="data-panel">
                        <div class="table-container">
                            <table class="custom-table" id="workshop-table">
                                <colgroup>
                                    <col style="width: 50px;">
                                    <col style="width: 110px;">
                                    <col style="width: 80px;">
                                    <col style="width: 20%;">
                                    <col style="width: 20%;">
                                    <col style="width: auto;">
                                    <col style="width: 140px;">
                                </colgroup>
                                <thead>
                                    <tr>
                                        <th>N°</th>
                                        <th>Fecha</th>
                                        <th>Tipo</th>
                                        <th>Marca / Modelo</th>
                                        <th>Código / Serial</th>
                                        <th>Falla Reportada</th>
                                        <th style="text-align: center;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Filas vacías iniciales para altura fija -->
                                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                                    <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                                </tbody>
                            </table>
                        </div>
                         <!-- PAGINACIÓN TALLER -->
                        <div class="pagination-controls">
                            <button id="wk-btn-prev" class="page-btn" onclick="app.prevPage()">Anterior</button>
                            <div class="page-info">
                                <span>Página</span>
                                <input type="text" id="wk-page-input" class="page-input" value="1" maxlength="1" oninput="app.inputPage(this)">
                                <span id="wk-total-info">de 1</span>
                            </div>
                            <button id="wk-btn-next" class="page-btn" onclick="app.nextPage()">Siguiente</button>
                        </div>
                    </div>
                </div>
                
                <!-- SECCIÓN 3: INVENTARIO -->
                <div id="section-inventory" class="section-view hidden">
                    <div class="filter-panel">
                        <div class="search-box">
                            <label class="form-label">Búsqueda</label>
                            <input type="text" placeholder="Buscar equipo..." id="inv-search" disabled>
                        </div>
                        <div style="display:flex; gap:10px; align-items:flex-end;">
                            <button class="btn-secondary" onclick="app.loadInventory(1)">Actualizar</button>
                        </div>
                    </div>
                    <div class="data-panel">
                        <div class="table-container">
                            <table class="custom-table" id="inventory-table">
                                <thead>
                                    <tr>
                                        <th style="width:50px;">ID</th>
                                        <th>Código</th>
                                        <th>Tipo</th>
                                        <th>Marca / Modelo</th>
                                        <th>Ubicación</th>
                                        <th>Serial</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="7" class="text-muted">Cargando inventario...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination-controls">
                            <button id="btn-prev" class="page-btn" onclick="app.prevPageLegacy()">Anterior</button>
                            <span id="page-info" class="page-info">Página 1</span>
                            <button id="btn-next" class="page-btn" onclick="app.nextPageLegacy()">Siguiente</button>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN 4: REPORTES -->
                <div id="section-reports" class="section-view hidden">
                    <h3>Generación de Reportes</h3>
                    <p class="text-secondary" style="margin-bottom: 2rem;">Seleccione el tipo de reporte que desea imprimir.</p>
                    <div class="filter-panel" style="justify-content: flex-start;">
                         <button class="btn-primary" onclick="app.printReport('view')">Imprimir Vista Actual</button>
                    </div>
                </div>
                
                 <!-- SECCIÓN 5: DATOS -->
                <div id="section-data" class="section-view hidden">
                    <h3>Gestión de Datos Maestros</h3>
                    <p class="text-secondary">Próximamente...</p>
                </div>

                 <!-- SECCIÓN 6: CONFIGURACIÓN -->
                <div id="section-settings" class="section-view hidden">
                    <h3>Configuración del Sistema</h3>
                    <p class="text-secondary">Próximamente...</p>
                </div>

            </div>
        </main>
    </div>

    <!-- MODAL GENÉRICO -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Título Modal</h3>
                <button class="btn-close-modal" onclick="app.closeModal()">×</button>
            </div>
            <div class="modal-body" id="modal-body-content">
                <!-- Se llena con JS -->
            </div>
            <div class="modal-footer" id="modal-footer-content">
                <!-- Se llena con JS -->
            </div>
        </div>
    </div>

    <!-- TEMPLATES DE MODAL -->
    <template id="tmpl-add-ticket">
        <div class="section-title">1. Ubicación del Equipo</div>
        <div class="grid-2">
            <div class="form-group">
                <label class="form-label">Edificio</label>
                <select id="sel-building" onchange="app.loadFloors(this.value)"><option value="">Seleccione...</option></select>
            </div>
            <div class="form-group">
                <label class="form-label">Piso</label>
                <select id="sel-floor" onchange="app.loadAreas(this.value)" disabled><option value="">Seleccione...</option></select>
            </div>
        </div>
        <div class="grid-2">
            <div class="form-group">
                <label class="form-label">Área</label>
                <select id="sel-area" onchange="app.loadAreaContent(this.value)" disabled><option value="">Seleccione...</option></select>
            </div>
            <div class="form-group">
                <label class="form-label">Habitación (Opcional)</label>
                <select id="sel-room" onchange="app.filterByRoom(this.value)" disabled><option value="">Seleccione...</option></select>
            </div>
        </div>

        <div class="section-title">2. Selección del Dispositivo</div>
        <div class="form-group">
            <label class="form-label">Dispositivo</label>
            <select id="sel-device" disabled><option value="">Seleccione Ubicación Primero...</option></select>
        </div>

        <div class="section-title">3. Detalles del Ingreso</div>
        <div class="grid-2">
            <div class="form-group">
                <label class="form-label">Fecha Ingreso</label>
                <input type="date" id="date-in" required>
            </div>
            <div></div> 
        </div>
        <div class="form-group">
            <label class="form-label">Falla Reportada</label>
            <textarea id="details-in" rows="3" placeholder="Describa la falla o motivo del ingreso..." required style="resize: none;" maxlength="300"></textarea>
            <div class="char-counter">0/300</div>
        </div>
        <div id="form-error" class="error-msg"></div>
    </template>

    <!-- TEMPLATE EDITAR (Con campos de Ubicación bloqueados para guía) -->
    <template id="tmpl-edit-ticket">
        <div class="section-title">1. Ubicación del Equipo</div>
        <div class="grid-2">
            <div class="form-group">
                <label class="form-label">Edificio</label>
                <input type="text" id="edit-building" disabled>
            </div>
            <div class="form-group">
                <label class="form-label">Piso</label>
                <input type="text" id="edit-floor" disabled>
            </div>
        </div>
        <div class="grid-2">
            <div class="form-group">
                <label class="form-label">Área</label>
                <input type="text" id="edit-area" disabled>
            </div>
            <div class="form-group">
                <label class="form-label">Habitación</label>
                <input type="text" id="edit-room" disabled>
            </div>
        </div>

        <div class="section-title">2. Equipo en Taller</div>
        <div class="info-block" id="edit-device-info">
            <!-- Info del dispositivo -->
        </div>

        <div class="section-title">3. Detalles del Ingreso</div>
        <div class="grid-2">
            <div class="form-group">
                <label class="form-label">Fecha Ingreso</label>
                <input type="date" id="edit-date-in" required>
            </div>
            <div></div> 
        </div>
        <div class="form-group">
            <label class="form-label">Falla Reportada</label>
            <textarea id="edit-details-in" rows="3" required style="resize: none;" maxlength="300"></textarea>
            <div class="char-counter">0/300</div>
        </div>
        <div id="edit-form-error" class="error-msg"></div>
    </template>

    <!-- TEMPLATE FINALIZAR -->
    <template id="tmpl-finalize-ticket">
        <div class="info-block" style="background: #eef2ff; border: 1px solid #c7d2fe;">
            <div style="font-weight:bold; color:var(--color-primary); margin-bottom:5px;">Equipo:</div>
            <div id="fin-device-info" style="margin-bottom:10px;"></div>
            
            <div style="font-weight:bold; color:var(--color-primary); margin-bottom:5px;">Ubicación:</div>
            <div id="fin-location-info" style="margin-bottom:10px;"></div>

            <div style="font-weight:bold; color:var(--color-primary); margin-bottom:5px;">Falla Reportada:</div>
            <div id="fin-problem-info" style="font-style:italic;"></div>
        </div>

        <div class="grid-2">
            <div class="form-group">
                <label class="form-label">Estado Final</label>
                <select id="fin-status">
                    <option value="repaired">Reparado</option>
                    <option value="unrepaired">No Reparado</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Fecha Salida</label>
                <input type="date" id="fin-date-out" required>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Informe de Salida / Solución</label>
            <textarea id="fin-details-out" rows="3" placeholder="Describa el procedimiento realizado..." required style="resize: none;" maxlength="300"></textarea>
            <div class="char-counter">0/300</div>
        </div>
        <div id="fin-error" class="error-msg"></div>
    </template>

    <!-- TEMPLATE ELIMINAR -->
    <template id="tmpl-delete-confirm">
        <div style="text-align: center; padding: 1rem;">
            <p style="font-size: 1.1rem; color: var(--color-text); margin-bottom: 0.5rem;">¿Está seguro de que desea eliminar este ticket?</p>
            <p style="font-size: 0.9rem; color: var(--color-text-light);">Esta acción no se puede deshacer.</p>
        </div>
    </template>

    <script>
        const app = {
            state: { 
                user: null, 
                token: null, 
                currentPage: 'home', 
                
                // Variables genéricas de paginación (para la vista activa)
                page: 1, 
                limit: 4, 
                total: 0, 

                // Variables heredadas para inventario (Legacy, no tocar)
                invPage: 1, invLimit: 4, invTotal: 0,

                // Cache de datos de Taller
                workshopData: [],

                currentAreaId: 0, 
                debounceTimer: null,
                currentTicketId: null // Para acciones de modal
            },

            init() {
                const storedUser = localStorage.getItem('sart_user');
                const storedToken = localStorage.getItem('sart_token');
                if (storedUser && storedToken) {
                    this.state.user = JSON.parse(storedUser);
                    this.state.token = storedToken;
                    this.showApp();
                } else {
                    this.showLogin();
                }
                document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); this.handleLogin(); });
            },

            // --- NAVEGACIÓN ---
            navigate(pageId) {
                this.state.currentPage = pageId;
                document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                const activeLink = Array.from(document.querySelectorAll('.nav-link')).find(l => l.getAttribute('onclick').includes(pageId));
                if (activeLink) activeLink.classList.add('active');
                
                document.querySelectorAll('.section-view').forEach(sec => sec.classList.add('hidden'));
                const targetSection = document.getElementById(`section-${pageId}`);
                if (targetSection) targetSection.classList.remove('hidden');

                const titles = { 'home': 'Inicio', 'workshop': 'Gestión de Taller', 'inventory': 'Inventario General', 'reports': 'Reportes', 'data': 'Gestión de Datos', 'settings': 'Configuración' };
                document.getElementById('page-title').textContent = titles[pageId] || 'SART';

                // Reset page on nav
                if (pageId === 'inventory') this.loadInventory(1);
                if (pageId === 'workshop') {
                    this.state.page = 1; // Reset a página 1 al entrar
                    this.loadWorkshopFilters();
                    this.loadWorkshop(1);
                }
                if (pageId === 'home') this.loadDashboardData();
            },

            // --- API HELPERS ---
            async fetchAPI(url, options = {}) {
                options.headers = { ...options.headers, 'Authorization': 'Bearer ' + this.state.token };
                const res = await fetch(url, options);
                if (res.status === 401) { this.logout(); return null; }
                return res;
            },

            // --- TALLER (FILTROS Y TABLA) ---
            async loadWorkshopFilters() {
                if(document.getElementById('wk-filter-type').length > 0) return;

                const endpoints = [
                    { id: 'wk-filter-type', url: '/api/types', field: 'type' },
                    { id: 'wk-filter-brand', url: '/api/brands', field: 'brand' },
                    { id: 'wk-filter-os', url: '/api/os', field: 'os' },
                    { id: 'wk-filter-cpu', url: '/api/processors', field: 'processor' },
                    { id: 'wk-filter-ram', url: '/api/rams', field: 'ram' },
                ];

                for (let ep of endpoints) {
                    const res = await this.fetchAPI(ep.url);
                    const json = await res.json();
                    if(json.success && json.data) {
                        const sel = document.getElementById(ep.id);
                        sel.innerHTML = '<option value="">Todos</option>';
                        json.data.forEach(item => {
                            const text = item[ep.field] || item.type || item.brand || item.os || item.processor || item.ram; 
                            sel.innerHTML += `<option value="${item.id}">${text}</option>`;
                        });
                    }
                }
            },

            debounceLoadWorkshop() {
                clearTimeout(this.state.debounceTimer);
                this.state.debounceTimer = setTimeout(() => this.loadWorkshop(1), 400);
            },

            async loadWorkshop(pageArg) {
                // Actualizar estado
                if (pageArg) this.state.page = pageArg;
                const currentPage = this.state.page;
                
                // Recopilar filtros
                const search = document.getElementById('wk-search').value;
                const type = document.getElementById('wk-filter-type').value;
                const brand = document.getElementById('wk-filter-brand').value;
                const os = document.getElementById('wk-filter-os').value;
                const cpu = document.getElementById('wk-filter-cpu').value;
                const ram = document.getElementById('wk-filter-ram').value;

                let qs = `status=pending&page=${currentPage}&limit=${this.state.limit}&search=${encodeURIComponent(search)}`;
                if(type) qs += `&type=${type}`;
                if(brand) qs += `&brand=${brand}`;
                if(os) qs += `&os=${os}`;
                if(cpu) qs += `&cpu=${cpu}`;
                if(ram) qs += `&ram=${ram}`;

                try {
                    const res = await this.fetchAPI('/api/workshop?' + qs);
                    if (!res) return;
                    const result = await res.json();
                    
                    this.state.total = result.total || 0;
                    this.state.workshopData = result.data || []; // Guardar en estado
                    this.renderWorkshopTable(this.state.workshopData);
                    this.updatePaginationControls();

                } catch (err) { console.error(err); }
            },

            renderWorkshopTable(data) {
                const tbody = document.querySelector('#workshop-table tbody');
                // IMPORTANTE: REGENERAR SIEMPRE 4 FILAS
                tbody.innerHTML = '';

                // Si no hay datos en absoluto
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-muted" style="text-align:center;">No se encontraron equipos.</td></tr>';
                    // Rellenar 3 filas vacías más para mantener altura
                    for(let i=0; i<3; i++) tbody.innerHTML += this.getEmptyRowHTML();
                    return;
                }

                // Generar filas de datos
                data.forEach((t, index) => {
                    const realIndex = ((this.state.page - 1) * this.state.limit) + (index + 1);
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${realIndex}</td>
                            <td>${t.date_in}</td>
                            <td>${t.device_type}</td>
                            <td>
                                <div class="cell-truncate" title="${t.device_brand} ${t.device_model}">
                                    <strong>${t.device_brand}</strong><br>
                                    <small class="text-secondary">${t.device_model}</small>
                                </div>
                            </td>
                            <td>
                                <div class="cell-truncate" title="${t.device_code} ${t.device_serial}">
                                    <strong>${t.device_code}</strong><br>
                                    <small class="text-secondary">${t.device_serial}</small>
                                </div>
                            </td>
                            <td>
                                <div class="cell-multiline" title="${t.details_in}">
                                    ${t.details_in}
                                </div>
                            </td>
                            <td style="text-align:center;">
                                <div class="actions-cell" style="justify-content:center;">
                                    <button class="action-btn edit" onclick="app.openModal('edit', ${t.id})" title="Editar"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                                    <button class="action-btn check" onclick="app.openModal('finalize', ${t.id})" title="Finalizar"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg></button>
                                    <button class="action-btn delete" onclick="app.openModal('delete', ${t.id})" title="Eliminar"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                                </div>
                            </td>
                        </tr>`;
                });

                // Rellenar filas faltantes si hay menos de 4
                const missing = this.state.limit - data.length;
                if(missing > 0) {
                    for(let i=0; i<missing; i++) tbody.innerHTML += this.getEmptyRowHTML();
                }
            },

            getEmptyRowHTML() {
                // Fila vacía con altura controlada por CSS
                return `
                <tr style="pointer-events: none;">
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                </tr>`;
            },

            updatePaginationControls() {
                const totalPages = Math.ceil(this.state.total / this.state.limit) || 1;
                document.getElementById('wk-page-input').value = this.state.page;
                document.getElementById('wk-total-info').textContent = `de ${totalPages}`;
                
                document.getElementById('wk-btn-prev').disabled = this.state.page <= 1;
                document.getElementById('wk-btn-next').disabled = this.state.page >= totalPages;
            },

            prevPage() {
                if (this.state.page > 1) this.loadWorkshop(this.state.page - 1);
            },

            nextPage() {
                const totalPages = Math.ceil(this.state.total / this.state.limit) || 1;
                if (this.state.page < totalPages) this.loadWorkshop(this.state.page + 1);
            },

            inputPage(input) {
                const val = parseInt(input.value);
                const totalPages = Math.ceil(this.state.total / this.state.limit) || 1;
                
                if (!isNaN(val) && val >= 1 && val <= totalPages) {
                    this.loadWorkshop(val);
                }
            },

             // --- INVENTARIO (LEGACY - MANTENIDO COMO ESTABA) ---
            async loadInventory(page) {
                this.state.invPage = page;
                try {
                    const res = await this.fetchAPI(`/api/inventory?page=${page}&limit=${this.state.invLimit}`);
                    if (!res || !res.ok) return;
                    const data = await res.json();
                    this.state.invTotal = data.total;
                    this.renderInvTable(data.data);
                    this.renderPaginationLegacy();
                } catch (err) { console.error(err); }
            },
            renderInvTable(items) {
                const tbody = document.querySelector('#inventory-table tbody');
                tbody.innerHTML = '';
                if (!items || items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-muted">No hay dispositivos registrados.</td></tr>';
                    return;
                }
                items.forEach(d => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${d.id}</td>
                            <td>${d.code || '-'}</td>
                            <td>${d.type}</td>
                            <td><strong>${d.brand}</strong><br><span style="font-size:0.8rem; color:#6b7280;">${d.model}</span></td>
                            <td>${d.location}</td>
                            <td>${d.serial}</td>
                            <td><span class="badge ${d.status === 'Operativo' ? 'operativo' : 'pending'}">${d.status}</span></td>
                        </tr>`;
                });
            },
            renderPaginationLegacy() {
                const { invPage, invLimit, invTotal } = this.state;
                const totalPages = Math.ceil(invTotal / invLimit);
                document.getElementById('page-info').textContent = `Página ${invPage} de ${totalPages || 1}`;
                document.getElementById('btn-prev').disabled = invPage === 1;
                document.getElementById('btn-next').disabled = invPage >= totalPages || totalPages === 0;
            },
            prevPageLegacy() { if (this.state.invPage > 1) this.loadInventory(this.state.invPage - 1); },
            nextPageLegacy() { 
                const totalPages = Math.ceil(this.state.invTotal / this.state.invLimit);
                if (this.state.invPage < totalPages) this.loadInventory(this.state.invPage + 1); 
            },

            // --- MODAL NUEVO INGRESO ---
            async openModal(type, id = null) {
                const overlay = document.getElementById('modal-overlay');
                const title = document.getElementById('modal-title');
                const body = document.getElementById('modal-body-content');
                const footer = document.getElementById('modal-footer-content');
                const today = new Date().toISOString().split("T")[0];

                if (type === 'add-ticket') {
                    title.textContent = 'Nuevo Ingreso a Taller';
                    body.innerHTML = document.getElementById('tmpl-add-ticket').innerHTML;
                    footer.innerHTML = `
                        <button class="btn-secondary" onclick="app.closeModal()">Cancelar</button>
                        <button class="btn-primary" onclick="app.submitTicket()">Guardar Ingreso</button>
                    `;
                    
                    this.initCharCounter('details-in');
                    const dateInput = document.getElementById('date-in');
                    if(dateInput) { dateInput.value = today; dateInput.max = today; }
                    
                    await this.loadBuildings();
                
                } else if (type === 'edit') {
                    const data = this.state.workshopData.find(t => t.id === id);
                    if (!data) return;

                    this.state.currentTicketId = id;
                    title.textContent = 'Editar Ingreso';
                    body.innerHTML = document.getElementById('tmpl-edit-ticket').innerHTML;
                    
                    // Populate Read-Only Location
                    document.getElementById('edit-building').value = data.building || '';
                    document.getElementById('edit-floor').value = data.floor || '';
                    document.getElementById('edit-area').value = data.area || '';
                    document.getElementById('edit-room').value = data.room || '';

                    // Autofill
					const deviceInfoStr = [data.device_brand, data.device_model, data.device_os, data.device_cpu, data.device_arch, data.device_serial].filter(Boolean).join(" - ");
                    document.getElementById('edit-device-info').innerHTML = `${data.device_type} - ` + deviceInfoStr;
					
                    document.getElementById('edit-date-in').value = data.date_in;
                    document.getElementById('edit-details-in').value = data.details_in;
                    
                    const dateInput = document.getElementById('edit-date-in');
                    if(dateInput) { dateInput.max = today; }
                    
                    this.initCharCounter('edit-details-in');

                    footer.innerHTML = `
                        <button class="btn-secondary" onclick="app.closeModal()">Cancelar</button>
                        <button class="btn-primary" onclick="app.submitEdit()">Guardar Cambios</button>
                    `;

                } else if (type === 'finalize') {
                    const data = this.state.workshopData.find(t => t.id === id);
                    if (!data) return;

                    this.state.currentTicketId = id;
                    title.textContent = 'Finalizar Ticket';
                    body.innerHTML = document.getElementById('tmpl-finalize-ticket').innerHTML;
                    
                    // Info
					const deviceInfoStr = [data.device_brand, data.device_model, data.device_os, data.device_cpu, data.device_arch, data.device_serial].filter(Boolean).join(" - ");
                    document.getElementById('fin-device-info').innerHTML = `${data.device_type} - ` + deviceInfoStr;
                    
                    const locationStr = [data.building, data.floor, data.area, data.room].filter(Boolean).join(" - ");
                    document.getElementById('fin-location-info').textContent = locationStr || "Sin ubicación registrada";
                    
                    document.getElementById('fin-problem-info').textContent = data.details_in;
                    
                    const dateOutInput = document.getElementById('fin-date-out');
                    dateOutInput.value = today;
                    // Min Date Logic
                    dateOutInput.min = data.date_in;
                    
                    this.initCharCounter('fin-details-out');

                    footer.innerHTML = `
                        <button class="btn-secondary" onclick="app.closeModal()">Cancelar</button>
                        <button class="btn-primary" onclick="app.submitFinalize()">Finalizar Ticket</button>
                    `;

                } else if (type === 'delete') {
                    this.state.currentTicketId = id;
                    title.textContent = 'Eliminar Registro';
                    body.innerHTML = document.getElementById('tmpl-delete-confirm').innerHTML;
                    footer.innerHTML = `
                        <button class="btn-secondary" onclick="app.closeModal()">Cancelar</button>
                        <button class="btn-danger" onclick="app.confirmDelete()">Sí, Eliminar</button>
                    `;
                }

                overlay.classList.add('open');
            },

            initCharCounter(id) {
                const txt = document.getElementById(id);
                if (!txt) return;
                const counter = txt.nextElementSibling;
                // Init value
                counter.textContent = `${txt.value.length}/300`;
                txt.addEventListener('input', function() {
                     counter.textContent = `${this.value.length}/300`;
                });
            },

            closeModal() { document.getElementById('modal-overlay').classList.remove('open'); },

            async loadBuildings() {
                const res = await this.fetchAPI('/api/buildings');
                const data = await res.json();
                this.fillSelect('sel-building', data.data);
            },
            async loadFloors(buildingId) {
                this.resetSelects(['sel-floor', 'sel-area', 'sel-room', 'sel-device']);
                if (!buildingId) return;
                const res = await this.fetchAPI(`/api/floors?id_building=${buildingId}`);
                const data = await res.json();
                this.fillSelect('sel-floor', data.data, false);
            },
            async loadAreas(floorId) {
                this.resetSelects(['sel-area', 'sel-room', 'sel-device']);
                if (!floorId) return;
                const res = await this.fetchAPI(`/api/areas?id_floor=${floorId}`);
                const data = await res.json();
                this.fillSelect('sel-area', data.data, false);
            },
            async loadAreaContent(areaId) {
                this.resetSelects(['sel-room', 'sel-device']);
                if (!areaId) return;
                this.state.currentAreaId = areaId;
                const res = await this.fetchAPI(`/api/rooms?id_area=${areaId}`);
                const data = await res.json();
                this.fillSelect('sel-room', data.data, false);
                this.loadDevices(areaId, null);
            },
            filterByRoom(roomId) {
                if (this.state.currentAreaId) this.loadDevices(this.state.currentAreaId, roomId);
            },
            async loadDevices(areaId, roomId) {
                const sel = document.getElementById('sel-device');
                sel.disabled = true;
                sel.innerHTML = '<option>Cargando equipos...</option>';
                let query = `/api/devices?id_area=${areaId}`;
                if (roomId) query += `&id_room=${roomId}`;
                const res = await this.fetchAPI(query);
                const json = await res.json();
                if(json.data && json.data.length > 0) {
                    sel.innerHTML = '<option value="">Seleccione Dispositivo (Tipo - Código - Marca - Modelo - Serial)...</option>';
                    json.data.forEach(item => sel.innerHTML += `<option value="${item.id}">${item.display}</option>`);
                    sel.disabled = false;
                } else {
                    sel.innerHTML = '<option>No hay dispositivos aquí</option>';
                }
            },
            fillSelect(id, items, disabled = true) {
                const sel = document.getElementById(id);
                sel.innerHTML = '<option value="">Seleccione...</option>';
                if(items) items.forEach(i => sel.innerHTML += `<option value="${i.id}">${i.building || i.floor || i.area || i.room}</option>`); 
                sel.disabled = items ? false : true;
            },
            resetSelects(ids) {
                ids.forEach(id => {
                    const sel = document.getElementById(id);
                    sel.innerHTML = '<option value="">Seleccione...</option>';
                    sel.disabled = true;
                });
            },
            
            // --- SUBMITS ---
            async submitTicket() {
                const deviceId = document.getElementById('sel-device').value;
                const dateIn = document.getElementById('date-in').value;
                const detailsIn = document.getElementById('details-in').value.trim();
                const errorDiv = document.getElementById('form-error');
                
                if (!deviceId || !dateIn || !detailsIn) {
                    errorDiv.textContent = 'Complete todos los campos obligatorios.';
                    return;
                }
                
                try {
                    const res = await this.fetchAPI('/api/workshop', {
                        method: 'POST',
                        body: JSON.stringify({ 
                            id_device: parseInt(deviceId), 
                            date_in: dateIn, 
                            details_in: detailsIn 
                        })
                    });
                    const json = await res.json();
                    if (res.ok) {
                        this.closeModal();
                        this.loadWorkshop(1);
                        this.loadDashboardData();
                    } else {
                        errorDiv.textContent = json.message || 'Error al guardar';
                        errorDiv.style.color = 'var(--color-danger)';
                    }
                } catch (e) { errorDiv.textContent = 'Error de conexión'; }
            },

            async submitEdit() {
                const id = this.state.currentTicketId;
                const dateIn = document.getElementById('edit-date-in').value;
                const detailsIn = document.getElementById('edit-details-in').value.trim();
                
                if (!dateIn || !detailsIn) {
                    document.getElementById('edit-form-error').textContent = 'Complete todos los campos obligatorios.';
                    return;
                }

                try {
                    const res = await this.fetchAPI(`/api/workshop/action?id=${id}`, {
                        method: 'PUT',
                        body: JSON.stringify({ date_in: dateIn, details_in: detailsIn })
                    });
                    if (res && res.ok) {
                        this.closeModal();
                        this.loadWorkshop(this.state.page);
                    }
                } catch(e) { alert("Error al editar"); }
            },

            async submitFinalize() {
                const id = this.state.currentTicketId;
                const status = document.getElementById('fin-status').value;
                const dateOut = document.getElementById('fin-date-out').value;
                const detailsOut = document.getElementById('fin-details-out').value.trim();

                if (!dateOut || !detailsOut) {
                    document.getElementById('fin-error').textContent = 'Complete todos los campos.';
                    return;
                }

                try {
                    const res = await this.fetchAPI(`/api/workshop/action?id=${id}&action=change_status`, {
                        method: 'PUT',
                        body: JSON.stringify({ status: status, date_out: dateOut, details_out: detailsOut })
                    });
                    if (res && res.ok) {
                        this.closeModal();
                        this.loadWorkshop(this.state.page);
                        this.loadDashboardData();
                    }
                } catch(e) { alert("Error al finalizar"); }
            },

            async confirmDelete() {
                const id = this.state.currentTicketId;
                try {
                    const res = await this.fetchAPI(`/api/workshop/action?id=${id}`, { method: 'DELETE' });
                    if (res && res.ok) {
                        this.closeModal();
                        this.loadWorkshop(this.state.page);
                        this.loadDashboardData();
                    }
                } catch(e) { alert("Error al eliminar"); }
            },

            // --- AUTH ---
            async handleLogin() {
                const usernameInput = document.getElementById('username').value;
                const passwordInput = document.getElementById('password').value;
                const roleInput = document.getElementById('role').value;
                const errorDiv = document.getElementById('login-error');
                errorDiv.textContent = 'Verificando...';
                if (usernameInput && passwordInput) {
                    const mockUser = { username: usernameInput, full_name: 'Usuario Sistema', role: roleInput };
                    const mockToken = 'mock-token-123';
                    this.state.user = mockUser;
                    this.state.token = mockToken;
                    localStorage.setItem('sart_user', JSON.stringify(mockUser));
                    localStorage.setItem('sart_token', mockToken);
                    errorDiv.textContent = '';
                    this.showApp();
                } else {
                    errorDiv.textContent = 'Datos incompletos';
                }
            },
            showLogin() { document.getElementById('login-view').classList.remove('hidden'); document.getElementById('app-view').classList.add('hidden'); },
            showApp() {
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                if (this.state.user) {
                    document.getElementById('user-display-name').textContent = this.state.user.full_name;
                    document.getElementById('user-display-role').textContent = this.state.user.role === 'admin' ? 'ADMINISTRADOR' : 'CONSULTOR';
                    const restrictedItems = document.querySelectorAll('[data-role-restricted="admin"]');
                    restrictedItems.forEach(item => {
                        if (this.state.user.role !== 'admin') item.classList.add('hidden');
                        else item.classList.remove('hidden');
                    });
                }
                this.loadDashboardData();
            },
            logout() { 
                localStorage.clear(); 
                this.state.user = null; 
                this.state.token = null; 
                window.location.reload();
            },
            async loadDashboardData() {
                try {
                     const elWorkshop = document.getElementById('kpi-workshop');
                    if (elWorkshop) elWorkshop.textContent = "3"; 
                    const elRepaired = document.getElementById('kpi-repaired');
                    if (elRepaired) elRepaired.textContent = "12"; 
                    const elMonth = document.getElementById('kpi-month');
                    if (elMonth) elMonth.textContent = "5"; 
                } catch (err) { console.error(err); }
            },
            printReport(mode) { alert("Generando reporte PDF... (Pronto)"); }
        };

        document.addEventListener('DOMContentLoaded', () => { app.init(); });
    </script>
</body>
</html>