<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SART - Sistema de Soporte y Reporte Tecnológico UNEFA</title>
    <style>
        /* --- VARIABLES --- */
        :root {
            --color-primary: #003366;
            --color-primary-dark: #002244;
            --color-secondary: #D4AF37;
            --color-danger: #ce1126;
            --color-success: #10B981;
            --color-warning: #f59e0b;
            --color-dark: #1f2937;
            --color-bg: #f3f4f6;
            --color-white: #ffffff;
            --color-text: #374151;
            --color-text-light: #9CA3AF;
            --border-color: #e5e7eb;

            --sidebar-width: 260px;
            --header-height: 60px;
            --radius: 6px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background-color: var(--color-bg); color: var(--color-text); height: 100vh; overflow: hidden; }

        .hidden { display: none !important; }
        .text-primary { color: var(--color-primary); }
        .text-secondary { color: var(--color-text-light); }
        .text-danger { color: var(--color-danger); }
        .text-sm { font-size: 0.85rem; }
        .font-bold { font-weight: bold; }
        .uppercase { text-transform: uppercase; }
        .block { display: block; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .mt-2 { margin-top: 1rem; }
        .w-full { width: 100%; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-1 { gap: 0.5rem; }
        .gap-2 { gap: 1rem; }
        .p-2 { padding: 0.5rem; }
        .border { border: 1px solid var(--border-color); }
        .rounded { border-radius: var(--radius); }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .overflow-y-auto { overflow-y: auto; }

        .filter-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 0.8rem; align-items: end;
            background-color: #f8fafc; padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border-color); margin-bottom: 1rem;
        }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        button { cursor: pointer; border: none; border-radius: var(--radius); font-weight: 600; padding: 0.6rem 1.2rem; transition: background 0.2s; font-size: 0.9rem; }
        .btn-primary { background-color: var(--color-primary); color: white; } .btn-primary:hover { background-color: var(--color-primary-dark); }
        .btn-secondary { background-color: #e5e7eb; color: var(--color-text); } .btn-secondary:hover { background-color: #d1d5db; }
        .btn-success { background-color: var(--color-success); color: white; } .btn-warning { background-color: var(--color-warning); color: white; }
        .btn-danger { background-color: var(--color-danger); color: white; }

        .btn-logout {
            width: 100%; padding: 0.75rem 1rem; border: 1px solid rgba(255,255,255,0.2); background-color: transparent; color: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s;
        }
        .btn-logout:hover { background-color: rgba(0,0,0,0.2); color: var(--color-white); border-color: rgba(255,255,255,0.4); }

        .header-actions { display: flex; gap: 0.5rem; align-items: center; }
        .btn-report-red { background-color: var(--color-danger); color: white; padding: 0.4rem 0.8rem; font-size: 0.85rem; display: flex; align-items: center; gap: 6px; border-radius: 4px; }
        .btn-report-red:hover { background-color: #b91c1c; }
        .btn-report-dark { background-color: var(--color-dark); color: white; padding: 0.4rem 0.8rem; font-size: 0.85rem; display: flex; align-items: center; gap: 6px; border-radius: 4px; }
        .btn-report-dark:hover { background-color: #000; }
        .btn-clean { background: var(--color-white); border: 1px solid var(--border-color); color: var(--color-text); padding: 0.4rem 0.8rem; display: flex; align-items: center; justify-content: center; gap: 5px; font-size: 0.85rem; }
        .btn-clean:hover { background-color: #f3f4f6; color: var(--color-danger); border-color: var(--color-danger); }

        .btn-sm { padding: 0.3rem 0.6rem; }
        .btn-icon { background: transparent; color: inherit; padding: 0.5rem; display: flex; align-items: center; justify-content: center; }
        .btn-icon:hover { background-color: rgba(0,0,0,0.05); border-radius: 50%; }
        .btn-delete { color: var(--color-danger); background: none; font-size: 1.2rem; line-height: 1; padding: 0 0.5rem; }
        .action-group { display: flex; gap: 0.25rem; justify-content: center; }

        input, select, textarea { width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--radius); outline: none; font-size: 0.85rem; background: var(--color-white); }
        input:focus, select:focus, textarea:focus { border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(0, 51, 102, 0.1); }
        textarea { resize: vertical; min-height: 80px; max-height: 200px; }
        .char-counter { font-size: 0.7rem; color: var(--color-text-light); text-align: right; margin-top: 2px; }
        .filter-label { font-size: 0.7rem; font-weight: bold; color: var(--color-text-light); margin-bottom: 0.3rem; display: block; text-transform: uppercase; }

        .card { background: var(--color-white); border-radius: var(--radius); box-shadow: var(--shadow); padding: 1.5rem; margin-bottom: 1.5rem; height: 100%; display: flex; flex-direction: column; }
        .card-header { border-bottom: 1px solid var(--border-color); padding-bottom: 0.8rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .card-header-title { color: var(--color-primary); font-weight: bold; font-size: 1.1rem; }
        .card-body-scroll { flex: 1; overflow-y: auto; }

        .login-wrapper { position: fixed; inset: 0; background-color: var(--color-primary); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-box { background: var(--color-white); padding: 2.5rem; border-radius: 12px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2); }
        .login-logo { width: 80px; height: 80px; background: var(--color-white); border: 4px solid var(--color-secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; color: var(--color-primary); }
        .login-title { color: var(--color-primary); font-size: 1.5rem; margin-bottom: 0.5rem; font-weight: bold; }
        .login-subtitle { color: var(--color-text-light); font-size: 0.9rem; margin-bottom: 1.5rem; }
        .form-label { display: block; font-size: 0.8rem; font-weight: bold; color: var(--color-primary); margin-bottom: 0.25rem; text-transform: uppercase; text-align: left; }
        .login-error-msg { color: var(--color-danger); font-size: 0.85rem; margin-top: 1rem; }

        .app-layout { display: flex; height: 100%; }
        .sidebar { width: var(--sidebar-width); background-color: var(--color-primary); color: var(--color-white); display: flex; flex-direction: column; transition: transform 0.3s; z-index: 50; }
        .sidebar-header { height: var(--header-height); display: flex; align-items: center; justify-content: space-between; padding: 0 1.5rem; background-color: rgba(0,0,0,0.2); font-weight: bold; letter-spacing: 1px; }
        .sidebar-menu { list-style: none; padding-top: 1rem; flex: 1; }
        .nav-link { padding: 0.8rem 1.5rem; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: background 0.2s; font-size: 0.9rem; color: rgba(255,255,255,0.7); text-decoration: none; }
        .nav-link:hover, .nav-link.active { background-color: rgba(212, 175, 55, 0.15); color: var(--color-secondary); border-left: 4px solid var(--color-secondary); }
        .sidebar-footer { padding: 1rem; background-color: rgba(0,0,0,0.2); }

        .main-content { flex: 1; display: flex; flex-direction: column; background-color: var(--color-bg); overflow: hidden; position: relative; }
        .top-header { height: var(--header-height); background: var(--color-white); display: flex; align-items: center; justify-content: space-between; padding: 0 1.5rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .header-title { color: var(--color-primary); font-size: 1.25rem; font-weight: bold; }
        .header-user { text-align: right; }
        .header-role { display: block; color: var(--color-primary); font-size: 0.9rem; font-weight: bold; }
        .header-date { font-size: 0.75rem; color: var(--color-text-light); }
        .content-area { flex: 1; overflow-y: auto; padding: 1.5rem; }

        .table-responsive { width: 100%; overflow-x: auto; border: 1px solid var(--border-color); border-radius: var(--radius); }
        .table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .table thead { background-color: #f9fafb; color: var(--color-text-light); text-transform: uppercase; font-size: 0.75rem; }
        .table th, .table td { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); text-align: left; }
        .table-empty { padding: 2rem; text-align: center; color: var(--color-text-light); }
        
        .badge { padding: 0.25rem 0.5rem; border-radius: 99px; font-size: 0.75rem; font-weight: bold; }
        .badge.pending { background-color: #FEF3C7; color: #D97706; }
        .badge.repaired { background-color: #D1FAE5; color: #059669; }
        .badge.norepaired { background-color: #FEE2E2; color: #DC2626; }

        /* BADGES DISPOSITIVOS */
        .dev-badge { padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .dev-pc { background: #e0f2fe; color: #0369a1; }
        .dev-laptop { background: #f0fdf4; color: #15803d; }
        .dev-printer { background: #fef3c7; color: #b45309; }
        .dev-network { background: #f3e8ff; color: #7e22ce; }
        .dev-other { background: #f3f4f6; color: #4b5563; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .stat-card { border-top: 4px solid transparent; height: auto; }
        .stat-card.gold { border-color: var(--color-secondary); }
        .stat-card.green { border-color: var(--color-success); }
        .stat-card.blue { border-color: var(--color-primary); }
        .stat-label { font-size: 0.75rem; text-transform: uppercase; color: var(--color-text-light); display: block; }
        .stat-value { font-size: 2rem; font-weight: bold; color: var(--color-text); margin-top: 0.5rem; }

        .pagination-container { display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; }
        .page-info { font-size: 0.9rem; color: var(--color-text-light); }
        .page-btn { padding: 0.4rem 0.8rem; border: 1px solid var(--border-color); background: white; border-radius: var(--radius); cursor: pointer; }
        .page-btn:hover:not(:disabled) { background-color: #f3f4f6; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .modal-container { background: var(--color-white); width: 100%; max-width: 600px; border-radius: var(--radius); overflow: hidden; animation: fadeIn 0.2s; display: flex; flex-direction: column; max-height: 90vh; }
        .modal-header { background: var(--color-primary); color: var(--color-white); padding: 1rem; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-body { padding: 1.5rem; overflow-y: auto; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
        .ticket-info-box { background: #f0f7ff; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem; }
    
        .card.period { grid-column: span 1; padding: 1rem; background-image: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark)); color: var(--color-white); border-top: none !important; }
        @media (min-width: 1024px) { .card.period { grid-column: span 2; } }
        .card.period .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .card.period .header h2 { font-size: 1.1rem; font-weight: bold; color: white; }
        .card.period .content { display: grid; grid-template-columns: auto 1fr; gap: 1rem; align-items: center; }
        .card.period .content h2[data-render="current-period"] { font-size: 1.8rem; font-weight: 800; line-height: 1; }
        .card.period .progress-and-dates { display: flex; flex-direction: column; justify-content: center; gap: 0.2rem; width: 100%; }
        .card.period .dates { display: flex; justify-content: space-between; font-size: 0.8rem; opacity: 0.9; }
        .card.period .progress-bar-wrapper { position: relative; border-radius: 9999px; overflow: hidden; width: 100%; height: 1.2rem; background: rgba(255,255,255,0.2); }
        .card.period .progress-bar { height: 100%; border-radius: 9999px; background: var(--color-secondary); width: 0%; transition: width 1s ease-in-out; }
        .card.period .progress-bar-wrapper p { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.75rem; color: var(--color-white); text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        
        .sidebar-toggle-btn { display: none; } 
        .sidebar-close-btn { display: none; }
        @media (max-width: 768px) {
            .sidebar { position: absolute; height: 100%; transform: translateX(-100%); }
            .sidebar.is-open { transform: translateX(0); }
            .sidebar-toggle-btn { display: block; margin-right: 1rem; }
            .sidebar-close-btn { display: block; }
            .grid-2, .grid-3 { grid-template-columns: 1fr; } 
            .header-user { display: none; }
            .action-group { flex-direction: column; }
            .filter-grid { grid-template-columns: 1fr; }
            .header-actions { flex-wrap: wrap; justify-content: flex-end; }
        }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <section id="view-login" class="login-wrapper">
        <div class="login-box">
            <div class="login-logo">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3L1 9l11 6 9-4.91V17h2V9L12 3zM5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82z"/></svg>
            </div>
            <h2 class="login-title">SART</h2>
            <p class="login-subtitle">UNEFA Núcleo Miranda</p>
            
            <form data-js="login-form">
                <div class="mb-2">
                    <label class="form-label">Usuario</label>
                    <input type="text" name="username" placeholder="admin / user" required>
                </div>
                <div class="mb-2">
                    <label class="form-label">Contraseña</label>
                    <input type="password" name="password" placeholder="••••••" required>
                </div>
                <div class="mb-2">
                    <label class="form-label">Rol</label>
                    <select name="role">
                        <option value="admin">Administrador</option>
                        <option value="user">Consultor</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary w-full mt-2">INGRESAR</button>
                <p data-js="login-error" class="login-error-msg hidden">Credenciales inválidas</p>
            </form>
        </div>
    </section>

    <!-- APP -->
    <div id="view-app" class="app-layout hidden">
        <aside class="sidebar" data-js="sidebar">
            <div class="sidebar-header">
                <span>SART</span>
                <button class="btn-icon sidebar-close-btn" data-action="toggle-sidebar">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>
            <nav class="sidebar-menu">
                <a href="#" class="nav-link active" data-target="home">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>
                    Inicio
                </a>
                <a href="#" class="nav-link" data-target="workshop">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
                    Taller
                </a>
                <a href="#" class="nav-link" data-target="history">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                    Historial
                </a>
                <a href="#" class="nav-link admin-only" data-target="data">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path><path d="M21 5c0 1.66-4 3-9 3s-9-1.34-9-3"></path></svg>
                    Inventario
                </a>
                <a href="#" class="nav-link admin-only" data-target="settings">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.18-.08a2 2 0 0 0-2 2v.44a2 2 0 0 0 2 2h.18a2 2 0 0 1 1.73 1l.25.43a2 2 0 0 1 0 2l-.08.18a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.18.08a2 2 0 0 0 2-2v-.44a2 2 0 0 0-2-2h-.18a2 2 0 0 1-1.73-1l-.25-.43a2 2 0 0 1 0-2l.08-.18a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    Configuración
                </a>
            </nav>
            <div class="sidebar-footer">
                <button data-action="logout" class="btn-logout">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    Cerrar Sesión
                </button>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-header">
                <div class="flex items-center">
                    <button class="btn-icon sidebar-toggle-btn" data-action="toggle-sidebar">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    </button>
                    <h2 class="header-title" data-js="page-title">Inicio</h2>
                </div>
                <div class="header-user">
                    <span class="header-role" data-js="user-role" style="text-transform: uppercase;">--</span>
                    <span class="header-date" data-js="current-date">--/--/----</span>
                </div>
            </header>

            <div class="content-area">
                <div id="section-home" class="view-section fade-in">
                    <div class="stats-grid">
                        <div class="card stat-card gold">
                            <span class="stat-label">En Taller</span>
                            <div class="stat-value" data-js="stat-pending">0</div>
                        </div>
                        <div class="card stat-card green">
                            <span class="stat-label">Reparados (Mes)</span>
                            <div class="stat-value" data-js="stat-repaired">0</div>
                        </div>
                        <div class="card stat-card blue">
                            <span class="stat-label">Total Histórico</span>
                            <div class="stat-value" data-js="stat-total">0</div>
                        </div>
                        <article class="card period">
                            <div class="header">
                                <h2> Período Académico </h2>
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 14v2.2l1.6 1"/><path d="M16 2v4"/><path d="M21 7.5V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h3.5"/><path d="M3 10h5"/><path d="M8 2v4"/><circle cx="16" cy="16" r="6"/></svg>
                            </div>
                            <div class="content">
                                <h2 data-render="current-period">--</h2>
                                <div class="progress-and-dates">
                                    <div class="dates">
                                        <p data-render="period-ini">--</p>
                                        <p data-render="period-end">--</p>
                                    </div>
                                    <div class="progress-bar-wrapper">
                                        <div data-component="progress-bar" data-name="period-progress-bar" class="progress-bar"></div>
                                        <p data-render="progress-percent" data-target="period-progress-bar"></p>
                                    </div>
                                </div>
                            </div>
                        </article>
                    </div>
                </div>

                <div id="section-workshop" class="view-section hidden fade-in">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-header-title">Gestión de Taller</h3>
                            <button class="btn-success admin-only" data-action="open-create-modal" style="display:flex; align-items:center; gap:5px;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                Añadir
                            </button>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <input type="text" placeholder="Buscar..." class="w-full" style="max-width: 300px;" data-js="search-workshop">
                        </div>
                        <div class="table-responsive">
                            <table class="table">
                                <thead><tr><th>Código</th><th>Equipo</th><th>Falla Reportada</th><th>Fecha Ingreso</th><th class="admin-only text-center">Acciones</th></tr></thead>
                                <tbody data-js="tbody-workshop"></tbody>
                            </table>
                        </div>
                        <div data-js="empty-workshop" class="table-empty hidden">No hay equipos pendientes en el taller.</div>
                    </div>
                </div>

            <div id="section-history" class="view-section hidden fade-in">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-header-title">Historial y Reportes</h3>
                        <div class="header-actions">
                            <button class="btn-clean" data-action="clean-filters" title="Limpiar Filtros">Limpiar filtros</button>
                            <button class="btn-report-red" onclick="app.printReport('view')">Generar reporte con filtros</button>
                            <button class="btn-report-dark" onclick="app.printReport('all')">Generar reporte completo</button>
                        </div>
                    </div>
                    <div class="filter-grid">
                        <div><label class="filter-label">Búsqueda General</label><input type="text" id="filter-text" placeholder="Buscar en todos los campos..."></div>
                        <div><label class="filter-label">Tipo de Equipo</label><select id="filter-type"></select></div>
                        <div><label class="filter-label">Marca</label><select id="filter-brand"></select></div>
                        <div><label class="filter-label">Estado</label><select id="filter-status"><option value="">Todos</option><option value="Reparado">Reparado</option><option value="No Reparado">No Reparado</option><option value="Pendiente">Pendiente</option></select></div>
                        <div><label class="filter-label">Edificio</label><select id="filter-building"></select></div>
                        <div><label class="filter-label">Piso</label><select id="filter-floor-h"></select></div>
                        <div><label class="filter-label">Área</label><select id="filter-area-h"></select></div>
                        <div><label class="filter-label">Después de (dd/mm/aaaa)</label><input type="date" id="filter-date-start" placeholder="dd/mm/aaaa"></div>
                        <div><label class="filter-label">Antes de (dd/mm/aaaa)</label><input type="date" id="filter-date-end" placeholder="dd/mm/aaaa"></div>
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead><tr><th>Estado</th><th>Código</th><th>Tipo</th><th>Ubicación</th><th>Entrada</th><th>Salida</th><th>Detalles</th></tr></thead>
                            <tbody data-js="tbody-history"></tbody>
                        </table>
                    </div>
                </div>
            </div>

                <div id="section-data" class="view-section hidden fade-in">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-header-title">Inventario</h3>
                            <div style="display:flex; gap:10px;">
                                <button class="btn-secondary" data-action="open-loc-modal">+ Ubicación</button>
                                <button class="btn-success" data-action="open-dev-modal">+ Dispositivo</button>
                            </div>
                        </div>
                        <div class="filter-grid">
                            <div><label class="filter-label">Búsqueda General</label><input type="text" id="dev-filter-q" placeholder="Buscar..."></div>
                            <div><label class="filter-label">Tipo de Equipo</label><select id="dev-filter-type"><option value="">Todos</option></select></div>
                            <div><label class="filter-label">Edificio</label><select id="dev-filter-building"><option value="">Todos</option></select></div>
                            <div><label class="filter-label">Piso</label><select id="dev-filter-floor"><option value="">Todos</option></select></div>
                            <div><label class="filter-label">Área</label><select id="dev-filter-area"><option value="">Todas</option></select></div>
                            <div><label class="filter-label">Marca</label><select id="dev-filter-brand"><option value="">Todas</option></select></div>
                            <div><label class="filter-label">S.O.</label><select id="dev-filter-os"><option value="">Todos</option></select></div>
                        </div>
                        <div class="table-responsive mb-2">
                            <table class="table">
                                <thead><tr><th>Código</th><th>Tipo</th><th>Marca / Modelo</th><th>Serial</th><th>Ubicación</th><th>S.O.</th></tr></thead>
                                <tbody data-js="tbody-devices"></tbody>
                            </table>
                        </div>
                        <div class="pagination-container">
                            <span class="page-info" id="dev-pagination-info"></span>
                            <div class="flex gap-1">
                                <button class="page-btn" id="dev-prev-btn" disabled>&laquo;</button>
                                <button class="page-btn" id="dev-next-btn" disabled>&raquo;</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="section-settings" class="view-section hidden fade-in">
                    <div class="card">
                        <div class="card-header"><h3 class="card-header-title">Configuración</h3></div>
                        <div class="grid-2 mb-3">
                            <form class="p-2 border rounded" data-js="form-settings-admin">
                                <h4 class="mb-2 font-bold text-primary">Perfil Administrador</h4>
                                <div class="mb-2"><label class="filter-label">Nombre Completo</label><input type="text" name="fullName" required></div>
                                <div class="mb-2"><label class="filter-label">Cargo</label><input type="text" name="jobTitle" required></div>
                                <div class="mb-2"><label class="filter-label">Usuario</label><input type="text" name="username" required></div>
                                <div class="mb-2"><label class="filter-label">Nueva Contraseña</label><input type="password" name="password"></div>
                                <button type="submit" class="btn-primary w-full">Guardar Cambios Admin</button>
                            </form>
                            <form class="p-2 border rounded" data-js="form-settings-user">
                                <h4 class="mb-2 font-bold text-secondary">Perfil Coordinador</h4>
                                <div class="mb-2"><label class="filter-label">Nombre Completo</label><input type="text" name="fullName" required></div>
                                <div class="mb-2"><label class="filter-label">Cargo</label><input type="text" name="jobTitle" required></div>
                                <div class="mb-2"><label class="filter-label">Usuario</label><input type="text" name="username" required></div>
                                <div class="mb-2"><label class="filter-label">Nueva Contraseña</label><input type="password" name="password"></div>
                                <button type="submit" class="btn-primary w-full">Guardar Cambios Coord.</button>
                            </form>
                        </div>
                        <div class="p-2 border rounded">
                            <h4 class="mb-2 font-bold text-primary">Período Académico Activo</h4>
                            <p class="mb-2 text-sm text-secondary">Edite solo las fechas del período activo actual.</p>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead><tr><th>Período</th><th>Inicio</th><th>Fin</th><th>Acción</th></tr></thead>
                                    <tbody data-js="tbody-periods"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL NUEVO EQUIPO REDISEÑADO CON BÚSQUEDA -->
    <div id="modal-ticket" class="modal-overlay hidden">
        <div class="modal-container">
            <div class="modal-header">
                <strong class="font-bold" data-js="modal-ticket-title">Añadir al Taller</strong>
                <button data-action="close-modal-ticket" class="btn-icon text-white"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </div>
            <div class="modal-body">
                <form data-js="form-ticket">
                    <div class="p-2 border rounded mb-2" style="background:#f9fafb;">
                        <span class="filter-label text-primary mb-1">Buscar en Inventario</span>
                        <div class="grid-2 mb-1">
                            <div><label class="filter-label">Edificio</label><select id="ticket-filter-build"><option value="">Todos</option></select></div>
                            <div><label class="filter-label">Piso</label><select id="ticket-filter-floor"><option value="">Todos</option></select></div>
                        </div>
                        <div class="mb-1"><label class="filter-label">Área</label><select id="ticket-filter-area"><option value="">Todas</option></select></div>
                        <div class="mb-1">
                            <label class="filter-label">Seleccionar Dispositivo (Tipo - Ubicación - Marca - Modelo - Serial)</label>
                            <select id="ticket-device-select" class="w-full" style="font-weight:bold;"><option value="">-- Seleccione Filtros Primero --</option></select>
                        </div>
                    </div>
                    <input type="hidden" name="deviceId" id="ticket-selected-id">
                    <input type="hidden" name="code" id="ticket-selected-code"> 
                    <div class="mb-2"><label class="filter-label">Fecha Ingreso</label><input type="date" name="fecha" required></div>
                    <div class="mb-3">
                        <label class="filter-label">Descripción de la Falla</label>
                        <textarea name="falla" rows="3" maxlength="300" required placeholder="Describa el problema..."></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" data-action="close-modal-ticket">Cancelar</button>
                        <button type="submit" class="btn-primary">Guardar Datos</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL FINALIZAR -->
    <div id="modal-finish" class="modal-overlay hidden"><div class="modal-container"><div class="modal-header"><strong class="font-bold">Finalizar Servicio</strong><button data-action="close-modal-finish" class="btn-icon text-white"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div><div class="modal-body"><form data-js="form-finish"><input type="hidden" name="id"><div class="ticket-info-box"><span class="filter-label">Equipo</span><span class="font-bold text-primary block" data-js="modal-code-display">PC-00X</span><span class="text-secondary text-sm" data-js="modal-desc-display">...</span></div><div class="mb-2"><label class="filter-label">Estatus Final</label><select name="status"><option value="Reparado">Reparado</option><option value="No Reparado">No Reparado</option></select></div><div class="mb-2"><label class="filter-label">Fecha de Salida</label><input type="date" name="date_out" required></div><div class="mb-2"><label class="filter-label">Solución / Observaciones</label><textarea name="solution" rows="3" maxlength="300" required></textarea></div><div class="modal-footer"><button type="button" class="btn-secondary" data-action="close-modal-finish">Cancelar</button><button type="submit" class="btn-success">Finalizar</button></div></form></div></div></div>

    <!-- MODAL NUEVA UBICACIÓN -->
            <div id="modal-location" class="modal-overlay hidden">
                <div class="modal-container">
                    <div class="modal-header">
                        <strong>Nueva Ubicación</strong>
                        <button data-action="close-modal-location" class="btn-icon text-white"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                    </div>
                    <div class="modal-body">
                        <form data-js="form-location">
                            <div class="mb-2">
                                <label class="filter-label">Edificio (Especial)</label>
                                <select name="building" id="loc-building" required class="w-full"><option value="">-- Seleccione --</option></select>
                                <small style="color:#f59e0b; display:block; margin-top:4px;">+ <a href="#" onclick="document.getElementById('input-loc-building').style.display='block'; return false;" style="color:#f59e0b; text-decoration:underline;">Agregar edificio</a></small>
                                <input type="text" id="input-loc-building" style="display:none; margin-top:4px;" placeholder="Nuevo edificio" class="w-full">
                            </div>
                            <div class="mb-2">
                                <label class="filter-label">Piso (Especial)</label>
                                <select name="floor" id="loc-floor" required class="w-full"><option value="">-- Seleccione --</option></select>
                                <small style="color:#f59e0b; display:block; margin-top:4px;">+ <a href="#" onclick="document.getElementById('input-loc-floor').style.display='block'; return false;" style="color:#f59e0b; text-decoration:underline;">Agregar piso</a></small>
                                <input type="text" id="input-loc-floor" style="display:none; margin-top:4px;" placeholder="Nuevo piso" class="w-full">
                            </div>
                            <div class="mb-2">
                                <label class="filter-label">Área (Especial)</label>
                                <select name="area" id="loc-area" required class="w-full"><option value="">-- Seleccione --</option></select>
                                <small style="color:#f59e0b; display:block; margin-top:4px;">+ <a href="#" onclick="document.getElementById('input-loc-area').style.display='block'; return false;" style="color:#f59e0b; text-decoration:underline;">Agregar área</a></small>
                                <input type="text" id="input-loc-area" style="display:none; margin-top:4px;" placeholder="Nueva área" class="w-full">
                            </div>
                            <div class="mb-2">
                                <label class="filter-label">Habitación (Especial, Opcional)</label>
                                <select name="room" id="loc-room" class="w-full"><option value="">-- Seleccione --</option></select>
                                <small style="color:#f59e0b; display:block; margin-top:4px;">+ <a href="#" onclick="document.getElementById('input-loc-room').style.display='block'; return false;" style="color:#f59e0b; text-decoration:underline;">Agregar habitación</a></small>
                                <input type="text" id="input-loc-room" style="display:none; margin-top:4px;" placeholder="Nueva habitación" class="w-full">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn-secondary" data-action="close-modal-location">Cancelar</button>
                                <button type="submit" class="btn-primary">Crear Ubicación</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- MODAL NUEVO DISPOSITIVO -->
            <div id="modal-device" class="modal-overlay hidden">
                <div class="modal-container">
                    <div class="modal-header">
                        <strong>Nuevo Dispositivo</strong>
                        <button data-action="close-modal-device" class="btn-icon text-white"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                    </div>
                    <div class="modal-body">
                        <form data-js="form-device">
                            <!-- Ubicación Jerárquica -->
                            <div class="mb-3 p-2 border rounded" style="background:#f9fafb;">
                                <span class="filter-label text-primary mb-1">Seleccionar Ubicación</span>
                                <div class="grid-2 gap-2 mb-2">
                                    <div>
                                        <label class="filter-label">Edificio (Obligatorio)</label>
                                        <select id="new-dev-building" required class="w-full"><option value="">-- Seleccione --</option></select>
                                    </div>
                                    <div>
                                        <label class="filter-label">Piso</label>
                                        <select id="new-dev-floor" class="w-full"><option value="">-- Seleccione --</option></select>
                                    </div>
                                </div>
                                <div class="grid-2 gap-2 mb-2">
                                    <div>
                                        <label class="filter-label">Área</label>
                                        <select id="new-dev-area" class="w-full"><option value="">-- Seleccione --</option></select>
                                    </div>
                                    <div>
                                        <label class="filter-label">Habitación</label>
                                        <input type="text" name="room" id="new-dev-room" class="w-full">
                                    </div>
                                </div>
                            </div>

                            <!-- Campos Principales -->
                            <div class="mb-3 p-2 border rounded" style="background:#f9fafb;">
                                <span class="filter-label text-primary mb-1">Datos del Dispositivo</span>
                                <div class="grid-2 gap-2 mb-2">
                                    <div>
                                        <label class="filter-label">Tipo (Obligatorio)</label>
                                        <select name="type" id="new-dev-type" required class="w-full"><option value="">-- Seleccione --</option></select>
                                        <small style="color:#f59e0b; display:block; margin-top:4px;">+ <a href="#" onclick="document.getElementById('input-new-type').style.display='block'; return false;" style="color:#f59e0b; text-decoration:underline;">Agregar tipo</a></small>
                                        <input type="text" id="input-new-type" style="display:none; margin-top:4px;" placeholder="Nuevo tipo" class="w-full">
                                    </div>
                                    <div>
                                        <label class="filter-label">Código</label>
                                        <input type="text" name="code" class="w-full">
                                    </div>
                                </div>
                                <div class="grid-2 gap-2 mb-2">
                                    <div>
                                        <label class="filter-label">Marca (Especial)</label>
                                        <select name="brand" id="new-dev-brand" class="w-full"><option value="">-- Seleccione --</option></select>
                                        <small style="color:#f59e0b; display:block; margin-top:4px;">+ <a href="#" onclick="document.getElementById('input-new-brand').style.display='block'; return false;" style="color:#f59e0b; text-decoration:underline;">Agregar marca</a></small>
                                        <input type="text" id="input-new-brand" style="display:none; margin-top:4px;" placeholder="Nueva marca" class="w-full">
                                    </div>
                                    <div>
                                        <label class="filter-label">Modelo</label>
                                        <input type="text" name="model" class="w-full">
                                    </div>
                                </div>
                                <div class="grid-2 gap-2 mb-2">
                                    <div>
                                        <label class="filter-label">Serial</label>
                                        <input type="text" name="serial" class="w-full">
                                    </div>
                                    <div>
                                        <label class="filter-label">S.O. (Especial)</label>
                                        <select name="os" id="new-dev-os" class="w-full"><option value="">-- Seleccione --</option></select>
                                        <small style="color:#f59e0b; display:block; margin-top:4px;">+ <a href="#" onclick="document.getElementById('input-new-os').style.display='block'; return false;" style="color:#f59e0b; text-decoration:underline;">Agregar S.O.</a></small>
                                        <input type="text" id="input-new-os" style="display:none; margin-top:4px;" placeholder="Nuevo S.O." class="w-full">
                                    </div>
                                </div>
                            </div>

                            <!-- Campos Avanzados -->
                            <div class="mb-3 p-2 border rounded" style="background:#f9fafb;">
                                <span class="filter-label text-primary mb-1">Especificaciones Técnicas</span>
                                <div class="grid-2 gap-2 mb-2">
                                    <div>
                                        <label class="filter-label">RAM (Especial)</label>
                                        <select name="ram" id="new-dev-ram" class="w-full"><option value="">-- Seleccione --</option></select>
                                        <small style="color:#f59e0b; display:block; margin-top:4px;">+ <a href="#" onclick="document.getElementById('input-new-ram').style.display='block'; return false;" style="color:#f59e0b; text-decoration:underline;">Agregar RAM</a></small>
                                        <input type="text" id="input-new-ram" style="display:none; margin-top:4px;" placeholder="Nueva RAM" class="w-full">
                                    </div>
                                    <div>
                                        <label class="filter-label">Procesador (Especial)</label>
                                        <select name="processor" id="new-dev-processor" class="w-full"><option value="">-- Seleccione --</option></select>
                                        <small style="color:#f59e0b; display:block; margin-top:4px;">+ <a href="#" onclick="document.getElementById('input-new-processor').style.display='block'; return false;" style="color:#f59e0b; text-decoration:underline;">Agregar procesador</a></small>
                                        <input type="text" id="input-new-processor" style="display:none; margin-top:4px;" placeholder="Nuevo procesador" class="w-full">
                                    </div>
                                </div>
                                <div class="grid-2 gap-2 mb-2">
                                    <div>
                                        <label class="filter-label">Arquitectura (Especial)</label>
                                        <select name="architecture" id="new-dev-architecture" class="w-full"><option value="">-- Seleccione --</option></select>
                                        <small style="color:#f59e0b; display:block; margin-top:4px;">+ <a href="#" onclick="document.getElementById('input-new-architecture').style.display='block'; return false;" style="color:#f59e0b; text-decoration:underline;">Agregar arquitectura</a></small>
                                        <input type="text" id="input-new-architecture" style="display:none; margin-top:4px;" placeholder="Nueva arquitectura" class="w-full">
                                    </div>
                                    <div>
                                        <label class="filter-label">Almacenamiento (Especial)</label>
                                        <select name="storage" id="new-dev-storage" class="w-full"><option value="">-- Seleccione --</option></select>
                                        <small style="color:#f59e0b; display:block; margin-top:4px;">+ <a href="#" onclick="document.getElementById('input-new-storage').style.display='block'; return false;" style="color:#f59e0b; text-decoration:underline;">Agregar almacenamiento</a></small>
                                        <input type="text" id="input-new-storage" style="display:none; margin-top:4px;" placeholder="Nuevo almacenamiento" class="w-full">
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <label class="filter-label">Detalles / Notas</label>
                                    <textarea name="details" class="w-full" maxlength="500" placeholder="Notas adicionales del dispositivo"></textarea>
                                </div>
                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn-secondary" data-action="close-modal-device">Cancelar</button>
                                <button type="submit" class="btn-primary">Crear Dispositivo</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => { app.init(); });
        
        const app = {
            state: { user: null, tickets: [], filteredTickets: [], config: { codes: [], types: [], brands: [], os: [], locations: [], buildings: [], floors: [], areas: [] }, deviceFilters: { q: '', type: '', brand: '', os: '', building: '', floor: '', area: '', page: 1, limit: 10 }, deviceTimer: null, currentPeriodCode: '' },
            dom: {},
            async init() { 
                console.log("[v0] Inicializando aplicación...");
                this.cacheDOM(); 
                this.bindEvents(); 
                this.updateTime(); 
                this.initCharCounters();
                
                // Intentar restaurar sesión
                if(!this.checkSession()) {
                    if(this.dom.viewApp) this.dom.viewApp.classList.add('hidden'); 
                    if(this.dom.viewLogin) this.dom.viewLogin.classList.remove('hidden');
                }
            },
            cacheDOM() {
                const els = ['view-login', 'view-app', 'login-form', 'login-error', 'sidebar', 'user-role', 'modal-ticket', 'form-ticket', 'modal-finish', 'form-finish', 'modal-location', 'form-location', 'modal-device', 'form-device', 'tbody-workshop', 'tbody-history', 'tbody-devices', 'tbody-periods', 'dev-filter-q', 'dev-pagination-info', 'ticket-device-select', 'new-dev-location', 'form-settings-admin', 'form-settings-user'];
                els.forEach(id => { const el = document.getElementById(id) || document.querySelector(`[data-js="${id}"]`); if(el) this.dom[id] = el; });
                this.dom.navLinks = document.querySelectorAll('.nav-link');
                this.dom.ticketFilterBuild = document.getElementById('ticket-filter-build');
                this.dom.ticketFilterFloor = document.getElementById('ticket-filter-floor');
                this.dom.ticketFilterArea = document.getElementById('ticket-filter-area');
                this.dom.devFilterType = document.getElementById('dev-filter-type');
                this.dom.devFilterBrand = document.getElementById('dev-filter-brand');
                this.dom.devFilterOS = document.getElementById('dev-filter-os');
                this.dom.devPrevBtn = document.getElementById('dev-prev-btn');
                this.dom.devNextBtn = document.getElementById('dev-next-btn');
                this.dom.filterText = document.getElementById('filter-text');
                this.dom.filterCode = document.getElementById('filter-code');
                this.dom.filterLoc = document.getElementById('filter-loc');
                this.dom.filterType = document.getElementById('filter-type');
                this.dom.filterBrand = document.getElementById('filter-brand');
                this.dom.filterBuilding = document.getElementById('filter-building');
                this.dom.filterFloorH = document.getElementById('filter-floor-h');
                this.dom.filterAreaH = document.getElementById('filter-area-h');
                this.dom.filterStatus = document.getElementById('filter-status');
                this.dom.filterDateStart = document.getElementById('filter-date-start');
                this.dom.filterDateEnd = document.getElementById('filter-date-end');
            },
            cacheDOM() {
                const els = ['view-login', 'view-app', 'login-form', 'login-error', 'sidebar', 'user-role', 'modal-ticket', 'form-ticket', 'modal-finish', 'form-finish', 'modal-location', 'form-location', 'modal-device', 'form-device', 'tbody-workshop', 'tbody-history', 'tbody-devices', 'tbody-periods', 'dev-filter-q', 'dev-pagination-info', 'ticket-device-select', 'new-dev-location', 'form-settings-admin', 'form-settings-user'];
                els.forEach(id => { const el = document.getElementById(id) || document.querySelector(`[data-js="${id}"]`); if(el) this.dom[id] = el; });
                this.dom.navLinks = document.querySelectorAll('.nav-link');
                this.dom.ticketFilterBuild = document.getElementById('ticket-filter-build');
                this.dom.ticketFilterFloor = document.getElementById('ticket-filter-floor');
                this.dom.ticketFilterArea = document.getElementById('ticket-filter-area');
                this.dom.ticketSelectedId = document.getElementById('ticket-selected-id');
                this.dom.ticketSelectedCode = document.getElementById('ticket-selected-code');
                this.dom.devFilterType = document.getElementById('dev-filter-type');
                this.dom.devFilterBrand = document.getElementById('dev-filter-brand');
                this.dom.devFilterOS = document.getElementById('dev-filter-os');
                this.dom.devFilterBuild = document.getElementById('dev-filter-building');
                this.dom.devFilterFloor = document.getElementById('dev-filter-floor');
                this.dom.devFilterArea = document.getElementById('dev-filter-area');
                this.dom.devPrevBtn = document.getElementById('dev-prev-btn');
                this.dom.devNextBtn = document.getElementById('dev-next-btn');
                this.dom.listCodes = document.getElementById('list-codigos');
                this.dom.filterText = document.getElementById('filter-text');
                this.dom.filterCode = document.getElementById('filter-code');
                this.dom.filterLoc = document.getElementById('filter-loc');
                this.dom.filterStatus = document.getElementById('filter-status');
                this.dom.filterDateStart = document.getElementById('filter-date-start');
                this.dom.filterDateEnd = document.getElementById('filter-date-end');
            },
            bindEvents() {
                this.dom['login-form'].addEventListener('submit', e => { e.preventDefault(); this.login(new FormData(e.target)); });
                document.querySelector('[data-action="logout"]').addEventListener('click', () => {
                    console.log("[v0] Cerrando sesión...");
                    sessionStorage.removeItem('sart_user');
                    location.reload();
                });
                this.dom.navLinks.forEach(l => l.addEventListener('click', e => { e.preventDefault(); this.nav(l.getAttribute('data-target')); }));
                document.querySelectorAll('[data-action="toggle-sidebar"]').forEach(btn => btn.addEventListener('click', () => this.dom.sidebar.classList.toggle('is-open')));
                document.querySelectorAll('[data-action="close-modals"]').forEach(b => b.addEventListener('click', () => {
                    console.log("[v0] Cerrando modales");
                    document.querySelectorAll('.modal-overlay').forEach(m => m.classList.add('hidden'));
                }));
                
                // Botones específicos para cerrar modales
                document.querySelectorAll('[data-action="close-modal-ticket"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log("[v0] Cerrando modal ticket");
                        if(this.dom['modal-ticket']) this.dom['modal-ticket'].classList.add('hidden');
                    });
                });
                document.querySelectorAll('[data-action="close-modal-finish"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log("[v0] Cerrando modal finish");
                        if(this.dom['modal-finish']) this.dom['modal-finish'].classList.add('hidden');
                    });
                });
                document.querySelectorAll('[data-action="close-modal-device"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log("[v0] Cerrando modal device");
                        if(this.dom['modal-device']) this.dom['modal-device'].classList.add('hidden');
                    });
                });
                document.querySelectorAll('[data-action="close-modal-location"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log("[v0] Cerrando modal location");
                        if(this.dom['modal-location']) this.dom['modal-location'].classList.add('hidden');
                    });
                });
                
                // Cerrar modales haciendo click en el backdrop
                document.querySelectorAll('.modal-overlay').forEach(overlay => {
                    overlay.addEventListener('click', (e) => {
                        if(e.target === overlay) {
                            console.log("[v0] Cerrando modal por backdrop");
                            overlay.classList.add('hidden');
                        }
                    });
                });

                document.querySelector('[data-action="open-create-modal"]').addEventListener('click', () => { 
                    console.log("[v0] Abriendo modal ticket");
                    if(this.dom['modal-ticket']) this.dom['modal-ticket'].classList.remove('hidden'); 
                    this.fetchModalDevices(); 
                });
                document.querySelector('[data-action="open-loc-modal"]').addEventListener('click', () => {
                    if(this.dom['modal-location']) this.dom['modal-location'].classList.remove('hidden');
                });
                document.querySelector('[data-action="open-dev-modal"]').addEventListener('click', () => { 
                    if(this.dom['modal-device']) this.dom['modal-device'].classList.remove('hidden'); 
                    this.loadLocationsForSelect();
                    this.initSpecialSelects();
                    this.initDeviceHierarchy();
                });
                
                // Event listeners para jerarquía de dispositivo
                const buildingSelect = document.getElementById('new-dev-building');
                if(buildingSelect) {
                    buildingSelect.addEventListener('change', () => {
                        const building = buildingSelect.value;
                        const floorSelect = document.getElementById('new-dev-floor');
                        const areaSelect = document.getElementById('new-dev-area');
                        if(!building) {
                            floorSelect.innerHTML = '<option value="">-- Seleccione --</option>';
                            areaSelect.innerHTML = '<option value="">-- Seleccione --</option>';
                            return;
                        }
                        
                        // Cargar pisos para este edificio
                        const floors = this.state.config.floors || [];
                        floorSelect.innerHTML = '<option value="">-- Seleccione --</option>' + floors.map(f => `<option value="${f}">${f}</option>`).join('');
                    });
                }

                this.dom['form-ticket'].addEventListener('submit', e => { e.preventDefault(); this.saveTicket(new FormData(e.target)); });
                this.dom['form-finish'].addEventListener('submit', e => { e.preventDefault(); this.finishTicket(new FormData(e.target)); });
                this.dom['form-location'].addEventListener('submit', e => { e.preventDefault(); this.saveLocation(new FormData(e.target)); });
                this.dom['form-device'].addEventListener('submit', e => { e.preventDefault(); this.saveDevice(new FormData(e.target)); });
                this.dom['form-settings-admin'].addEventListener('submit', e => { e.preventDefault(); this.updateUser(new FormData(e.target), 'admin'); });
                this.dom['form-settings-user'].addEventListener('submit', e => { e.preventDefault(); this.updateUser(new FormData(e.target), 'user'); });

                // Filters
                const triggerDevices = () => { this.state.deviceFilters.page = 1; this.fetchDevices(); };
                this.dom['dev-filter-q'].addEventListener('keyup', () => { clearTimeout(this.state.deviceTimer); this.state.deviceTimer = setTimeout(triggerDevices, 400); });
                this.dom.devFilterType.addEventListener('change', triggerDevices);
                this.dom.devFilterBrand.addEventListener('change', triggerDevices);
                this.dom.devFilterOS.addEventListener('change', triggerDevices);
                this.dom.devFilterBuild.addEventListener('change', triggerDevices);
                this.dom.devFilterFloor.addEventListener('change', triggerDevices);
                this.dom.devFilterArea.addEventListener('change', triggerDevices);
                this.dom.devPrevBtn.addEventListener('click', () => { 
                    if(this.state.deviceFilters.page > 1) { 
                        console.log("[v0] Página anterior. Página actual:", this.state.deviceFilters.page);
                        this.state.deviceFilters.page--; 
                        this.fetchDevices(); 
                    }
                });
                this.dom.devNextBtn.addEventListener('click', () => { 
                    console.log("[v0] Página siguiente. Página actual:", this.state.deviceFilters.page);
                    this.state.deviceFilters.page++; 
                    this.fetchDevices(); 
                });

                // Ticket Filters
                const loadModalDevices = () => this.fetchModalDevices();
                this.dom.ticketFilterBuild.addEventListener('change', loadModalDevices);
                this.dom.ticketFilterFloor.addEventListener('change', loadModalDevices);
                document.getElementById('ticket-filter-area').addEventListener('change', loadModalDevices);
                document.getElementById('ticket-device-select').addEventListener('change', (e) => {
                    const opt = e.target.options[e.target.selectedIndex];
                    this.dom.ticketSelectedId.value = e.target.value;
                    this.dom.ticketSelectedCode.value = opt.dataset.code || '';
                });

                // History Filters
                document.querySelector('[data-js="search-workshop"]').addEventListener('keyup', (e) => this.renderWorkshop(e.target.value));
                const triggerHistory = () => { this.validateDates(); this.renderHistory(); };
                if(this.dom.filterText) this.dom.filterText.addEventListener('keyup', triggerHistory);
                if(this.dom.filterCode) this.dom.filterCode.addEventListener('change', triggerHistory);
                if(this.dom.filterLoc) this.dom.filterLoc.addEventListener('change', triggerHistory);
                if(this.dom.filterType) this.dom.filterType.addEventListener('change', triggerHistory);
                if(this.dom.filterBrand) this.dom.filterBrand.addEventListener('change', triggerHistory);
                if(this.dom.filterBuilding) this.dom.filterBuilding.addEventListener('change', triggerHistory);
                if(this.dom.filterFloorH) this.dom.filterFloorH.addEventListener('change', triggerHistory);
                if(this.dom.filterAreaH) this.dom.filterAreaH.addEventListener('change', triggerHistory);
                if(this.dom.filterStatus) this.dom.filterStatus.addEventListener('change', triggerHistory);
                if(this.dom.filterDateStart) this.dom.filterDateStart.addEventListener('change', triggerHistory);
                if(this.dom.filterDateEnd) this.dom.filterDateEnd.addEventListener('change', triggerHistory);
                document.querySelector('[data-action="clean-filters"]').addEventListener('click', () => {
                    if(this.dom.filterText) this.dom.filterText.value = '';
                    if(this.dom.filterCode) this.dom.filterCode.value = '';
                    if(this.dom.filterLoc) this.dom.filterLoc.value = '';
                    if(this.dom.filterType) this.dom.filterType.value = '';
                    if(this.dom.filterBrand) this.dom.filterBrand.value = '';
                    if(this.dom.filterBuilding) this.dom.filterBuilding.value = '';
                    if(this.dom.filterFloorH) this.dom.filterFloorH.value = '';
                    if(this.dom.filterAreaH) this.dom.filterAreaH.value = '';
                    if(this.dom.filterStatus) this.dom.filterStatus.value = '';
                    if(this.dom.filterDateStart) this.dom.filterDateStart.value = '';
                    if(this.dom.filterDateEnd) this.dom.filterDateEnd.value = '';
                    this.renderHistory();
                });
            },
            async login(fd) {
                try {
                    console.log("[v0] Iniciando login...");
                    const res = await fetch('/api/login', { method:'POST', body: JSON.stringify(Object.fromEntries(fd)) });
                    if(!res.ok) {
                        console.log("[v0] Login fallido - respuesta no OK");
                        throw new Error();
                    }
                    this.state.user = await res.json();
                    console.log("[v0] Login exitoso para usuario:", this.state.user.full_name);
                    
                    // Guardar sesión en localStorage
                    sessionStorage.setItem('sart_user', JSON.stringify(this.state.user));
                    
                    this.dom['view-login'].classList.add('hidden');
                    this.dom['view-app'].classList.remove('hidden');
                    
                    // Mostrar nombre completo en MAYÚSCULAS
                    this.dom['user-role'].textContent = this.state.user.full_name.toUpperCase();
                    console.log("[v0] Header actualizado con:", this.state.user.full_name.toUpperCase());
                    
                    if(this.state.user.role === 'user') document.querySelectorAll('.admin-only').forEach(e => e.classList.add('hidden'));
                    else document.querySelectorAll('.admin-only').forEach(e => e.classList.remove('hidden'));
                    this.fetchData(); this.nav('home');
                } catch(e) { 
                    console.log("[v0] Error en login:", e);
                    this.dom['login-error'].classList.remove('hidden'); 
                }
            },
            checkSession() {
                console.log("[v0] Verificando sesión...");
                const stored = sessionStorage.getItem('sart_user');
                if(stored) {
                    this.state.user = JSON.parse(stored);
                    console.log("[v0] Sesión restaurada para:", this.state.user.full_name);
                    this.dom['view-login'].classList.add('hidden');
                    this.dom['view-app'].classList.remove('hidden');
                    this.dom['user-role'].textContent = this.state.user.full_name.toUpperCase();
                    if(this.state.user.role === 'user') document.querySelectorAll('.admin-only').forEach(e => e.classList.add('hidden'));
                    else document.querySelectorAll('.admin-only').forEach(e => e.classList.remove('hidden'));
                    this.fetchData();
                    this.nav('home');
                    return true;
                }
                return false;
            },
            nav(target) {
                document.querySelectorAll('.view-section').forEach(s => s.classList.add('hidden'));
                document.getElementById(`section-${target}`).classList.remove('hidden');
                this.dom.navLinks.forEach(l => l.classList.remove('active'));
                document.querySelector(`[data-target="${target}"]`).classList.add('active');
                if(target === 'home') this.renderDash();
            },
            async fetchData() {
                this.fetchConfig();
                this.fetchTickets();
                this.fetchPeriod();
                this.fetchUsers();
                this.fetchDevices();
            },
            async fetchConfig() {
                const res = await fetch('/api/config');
                this.state.config = await res.json();
                const createOpts = (arr) => `<option value="">Todos</option>` + (arr||[]).map(x => `<option value="${x}">${x}</option>`).join('');
                this.dom.devFilterType.innerHTML = createOpts(this.state.config.types);
                this.dom.devFilterBrand.innerHTML = createOpts(this.state.config.brands);
                this.dom.devFilterOS.innerHTML = createOpts(this.state.config.os);
                this.dom.devFilterBuild.innerHTML = createOpts(this.state.config.buildings);
                this.dom.devFilterFloor.innerHTML = createOpts(this.state.config.floors);
                this.dom.devFilterArea.innerHTML = createOpts(this.state.config.areas);
                this.dom.ticketFilterBuild.innerHTML = createOpts(this.state.config.buildings);
                this.dom.ticketFilterFloor.innerHTML = createOpts(this.state.config.floors);
                document.getElementById('ticket-filter-area').innerHTML = createOpts(this.state.config.areas);
                if(this.dom.filterCode) this.dom.filterCode.innerHTML = createOpts(this.state.config.codes);
                if(this.dom.filterLoc) this.dom.filterLoc.innerHTML = createOpts(this.state.config.locations);
                // Filtros del Historial
                if(this.dom.filterType) this.dom.filterType.innerHTML = createOpts(this.state.config.types);
                if(this.dom.filterBrand) this.dom.filterBrand.innerHTML = createOpts(this.state.config.brands);
                if(this.dom.filterBuilding) this.dom.filterBuilding.innerHTML = createOpts(this.state.config.buildings);
                if(this.dom.filterFloorH) this.dom.filterFloorH.innerHTML = createOpts(this.state.config.floors);
                if(this.dom.filterAreaH) this.dom.filterAreaH.innerHTML = createOpts(this.state.config.areas);
                
                // Inicializar selects especiales y localizaciones
                this.loadLocationsForSelect();
                this.initSpecialSelects();
            },
            async fetchTickets() {
                console.log("[v0] Cargando tickets...");
                const res = await fetch('/api/tickets');
                const tickets = await res.json();
                this.state.tickets = tickets;
                console.log("[v0] Tickets cargados:", tickets.length);
                this.renderWorkshop();
                this.renderHistory();
                this.renderDash();
            },
            async fetchDevices() {
                const f = this.state.deviceFilters;
                const building = this.dom.devFilterBuild.value;
                const floor = this.dom.devFilterFloor.value;
                const area = this.dom.devFilterArea.value;
                const q = this.dom['dev-filter-q'].value || '';
                
                console.log("[v0] Cargando dispositivos - Página:", f.page, "Q:", q);
                
                const query = `page=${f.page}&limit=${f.limit}&q=${encodeURIComponent(q)}&type=${this.dom.devFilterType.value}&brand=${this.dom.devFilterBrand.value}&os=${this.dom.devFilterOS.value}&building=${encodeURIComponent(building)}&floor=${encodeURIComponent(floor)}&area=${encodeURIComponent(area)}`;
                const res = await fetch(`/api/devices?${query}`);
                const data = await res.json();
                
                console.log("[v0] Respuesta dispositivos:", data.total, "registros,", "página", data.page);
                
                this.dom['tbody-devices'].innerHTML = (data.data||[]).map(d => {
                    const typeLower = d.type.toLowerCase();
                    let badgeClass = 'dev-other';
                    if (typeLower.includes('pc')||typeLower.includes('desktop')) badgeClass = 'dev-pc';
                    else if (typeLower.includes('laptop')) badgeClass = 'dev-laptop';
                    else if (typeLower.includes('switch')||typeLower.includes('modem')) badgeClass = 'dev-network';
                    else if (typeLower.includes('impresora')) badgeClass = 'dev-printer';
                    return `<tr><td class="font-bold text-primary">${d.code}</td><td><span class="dev-badge ${badgeClass}">${d.type}</span></td><td>${d.brand} ${d.model}</td><td>${d.serial}</td><td>${d.location}</td><td>${d.os}</td></tr>`;
                }).join('');
                
                const totalPages = Math.ceil(data.total / data.limit);
                document.getElementById('dev-pagination-info').textContent = `Pág ${data.page} de ${totalPages} (${data.total})`;
                
                // Actualizar estado de botones
                this.dom.devPrevBtn.disabled = data.page <= 1;
                this.dom.devNextBtn.disabled = data.page >= totalPages;
                
                console.log("[v0] Botones: Anterior disabled=", this.dom.devPrevBtn.disabled, ", Siguiente disabled=", this.dom.devNextBtn.disabled);
            },
            async fetchModalDevices() {
                const b = this.dom.ticketFilterBuild.value;
                const f = this.dom.ticketFilterFloor.value;
                const a = document.getElementById('ticket-filter-area').value;
                const sel = document.getElementById('ticket-device-select');
                
                console.log("[v0] Cargando dispositivos - Edificio:", b, "Piso:", f, "Área:", a);
                
                // Si no hay edificio seleccionado, limpiar todo
                if(!b) {
                    sel.innerHTML = '<option value="">-- Seleccione Edificio Primero --</option>';
                    return;
                }
                
                // Si hay edificio pero no piso, cargar pisos
                if(b && !f) {
                    console.log("[v0] Cargando pisos para edificio:", b);
                    const floorsRes = await fetch(`/api/devices/floors?building=${encodeURIComponent(b)}`);
                    const floors = await floorsRes.json();
                    console.log("[v0] Pisos cargados:", floors);
                    const floorSelect = this.dom.ticketFilterFloor;
                    floorSelect.innerHTML = '<option value="">-- Seleccione Piso --</option>' + (floors||[]).map(fl => `<option value="${fl}">${fl}</option>`).join('');
                    sel.innerHTML = '<option value="">-- Seleccione Piso Primero --</option>';
                    return;
                }
                
                // Si hay piso pero no área, cargar áreas
                if(f && !a) {
                    console.log("[v0] Cargando áreas para piso:", f);
                    const areasRes = await fetch(`/api/devices/areas?building=${encodeURIComponent(b)}&floor=${encodeURIComponent(f)}`);
                    const areas = await areasRes.json();
                    console.log("[v0] Áreas cargadas:", areas);
                    const areaSelect = document.getElementById('ticket-filter-area');
                    areaSelect.innerHTML = '<option value="">-- Seleccione Área --</option>' + (areas||[]).map(ar => `<option value="${ar}">${ar}</option>`).join('');
                    sel.innerHTML = '<option value="">-- Seleccione Área Primero --</option>';
                    return;
                }
                
                // Cargar dispositivos finales
                const res = await fetch(`/api/devices?limit=100&building=${encodeURIComponent(b)}&floor=${encodeURIComponent(f)}&area=${encodeURIComponent(a)}`);
                const data = await res.json();
                console.log("[v0] Dispositivos cargados:", data.data ? data.data.length : 0);
                
                if(!data.data || data.data.length === 0) { 
                    sel.innerHTML = '<option value="">No hay equipos en esta ubicación</option>'; 
                    return; 
                }
                sel.innerHTML = '<option value="">-- Seleccione --</option>' + data.data.map(d => `<option value="${d.id}" data-code="${d.code}">${d.type} - ${d.location} - ${d.brand} - ${d.model} - ${d.serial}</option>`).join('');
            },
            async loadLocationsForSelect() {
                console.log("[v0] Cargando ubicaciones para selects especiales");
                
                // Cargar edificios
                if(this.state.config.buildings && this.state.config.buildings.length > 0) {
                    const buildingSelect = document.getElementById('new-dev-building');
                    const locBuildingSelect = document.getElementById('loc-building');
                    if(buildingSelect) buildingSelect.innerHTML = '<option value="">-- Seleccione --</option>' + this.state.config.buildings.map(b => `<option value="${b}">${b}</option>`).join('');
                    if(locBuildingSelect) locBuildingSelect.innerHTML = '<option value="">-- Seleccione --</option>' + this.state.config.buildings.map(b => `<option value="${b}">${b}</option>`).join('');
                }
                
                // Cargar tipos, marcas, sistemas operativos
                if(this.state.config.types && this.state.config.types.length > 0) {
                    const typeSelect = document.getElementById('new-dev-type');
                    if(typeSelect) typeSelect.innerHTML = '<option value="">-- Seleccione --</option>' + this.state.config.types.map(t => `<option value="${t}">${t}</option>`).join('');
                }
                if(this.state.config.brands && this.state.config.brands.length > 0) {
                    const brandSelect = document.getElementById('new-dev-brand');
                    if(brandSelect) brandSelect.innerHTML = '<option value="">-- Seleccione --</option>' + this.state.config.brands.map(b => `<option value="${b}">${b}</option>`).join('');
                }
                if(this.state.config.os && this.state.config.os.length > 0) {
                    const osSelect = document.getElementById('new-dev-os');
                    if(osSelect) osSelect.innerHTML = '<option value="">-- Seleccione --</option>' + this.state.config.os.map(o => `<option value="${o}">${o}</option>`).join('');
                }
            },
            initDeviceHierarchy() {
                console.log("[v0] Inicializando jerarquía de dispositivo");
                const floorSelect = document.getElementById('new-dev-floor');
                const areaSelect = document.getElementById('new-dev-area');
                
                if(floorSelect) {
                    floorSelect.addEventListener('change', () => {
                        const floor = floorSelect.value;
                        if(!floor) {
                            areaSelect.innerHTML = '<option value="">-- Seleccione --</option>';
                            return;
                        }
                        
                        // Cargar áreas para este piso
                        const areas = this.state.config.areas || [];
                        areaSelect.innerHTML = '<option value="">-- Seleccione --</option>' + areas.map(a => `<option value="${a}">${a}</option>`).join('');
                    });
                }
            },
            initSpecialSelects() {
                console.log("[v0] Inicializando selects especiales");
                
                // Función helper para agregar nuevo valor a un select especial
                const addSpecialValue = (selectId, inputId, fieldName, callback) => {
                    const inputEl = document.getElementById(inputId);
                    const selectEl = document.getElementById(selectId);
                    
                    if(!inputEl || !selectEl) return;
                    
                    const addBtn = document.createElement('button');
                    addBtn.textContent = 'Añadir';
                    addBtn.className = 'btn-primary btn-sm';
                    addBtn.style.marginTop = '4px';
                    addBtn.onclick = (e) => {
                        e.preventDefault();
                        const value = inputEl.value.trim();
                        if(!value) { alert('Por favor ingrese un valor'); return; }
                        
                        // Verificar si ya existe
                        const exists = Array.from(selectEl.options).some(opt => opt.value === value);
                        if(exists) { alert('Este valor ya existe'); return; }
                        
                        // Agregar opción
                        const opt = document.createElement('option');
                        opt.value = value;
                        opt.textContent = value;
                        selectEl.appendChild(opt);
                        selectEl.value = value;
                        
                        inputEl.value = '';
                        inputEl.style.display = 'none';
                        console.log("[v0] Nuevo", fieldName, "agregado:", value);
                        if(callback) callback();
                    };
                    
                    inputEl.parentNode.appendChild(addBtn);
                };
                
                // Inicializar cada select especial
                addSpecialValue('new-dev-type', 'input-new-type', 'tipo');
                addSpecialValue('new-dev-brand', 'input-new-brand', 'marca');
                addSpecialValue('new-dev-os', 'input-new-os', 'S.O.');
                addSpecialValue('new-dev-ram', 'input-new-ram', 'RAM');
                addSpecialValue('new-dev-processor', 'input-new-processor', 'procesador');
                addSpecialValue('new-dev-architecture', 'input-new-architecture', 'arquitectura');
                addSpecialValue('new-dev-storage', 'input-new-storage', 'almacenamiento');
                
                addSpecialValue('loc-building', 'input-loc-building', 'edificio');
                addSpecialValue('loc-floor', 'input-loc-floor', 'piso');
                addSpecialValue('loc-area', 'input-loc-area', 'área');
                addSpecialValue('loc-room', 'input-loc-room', 'habitación');
            },
            async saveLocation(fd) {
                const data = Object.fromEntries(fd);
                console.log("[v0] Guardando ubicación:", data);
                
                // Obtener valores de inputs especiales si están visibles
                const inputBuilding = document.getElementById('input-loc-building');
                const inputFloor = document.getElementById('input-loc-floor');
                const inputArea = document.getElementById('input-loc-area');
                const inputRoom = document.getElementById('input-loc-room');
                
                if(inputBuilding?.style.display !== 'none' && inputBuilding?.value) data.building = inputBuilding.value;
                if(inputFloor?.style.display !== 'none' && inputFloor?.value) data.floor = inputFloor.value;
                if(inputArea?.style.display !== 'none' && inputArea?.value) data.area = inputArea.value;
                if(inputRoom?.style.display !== 'none' && inputRoom?.value) data.room = inputRoom.value;
                
                const res = await fetch('/api/locations', { method:'POST', body: JSON.stringify(data) });
                if(res.ok) {
                    alert("Ubicación creada");
                    document.getElementById('modal-location').classList.add('hidden');
                    this.fetchConfig();
                    this.loadLocationsForSelect();
                } else {
                    alert("Error al crear ubicación");
                }
            },
            async saveDevice(fd) {
                const data = Object.fromEntries(fd);
                console.log("[v0] Guardando dispositivo...");
                
                // Construir ubicación desde selects jerárquicos
                const building = document.getElementById('new-dev-building').value;
                const floor = document.getElementById('new-dev-floor').value || '';
                const area = document.getElementById('new-dev-area').value || '';
                const room = document.getElementById('new-dev-room').value || '';
                
                if(!building) {
                    alert("El edificio es obligatorio");
                    return;
                }
                
                data.location = `${building} - ${floor} - ${area} ${room}`.trim();
                
                // Obtener valores de inputs especiales si están visibles
                const inputType = document.getElementById('input-new-type');
                const inputBrand = document.getElementById('input-new-brand');
                const inputOS = document.getElementById('input-new-os');
                const inputRAM = document.getElementById('input-new-ram');
                const inputProcessor = document.getElementById('input-new-processor');
                const inputArchitecture = document.getElementById('input-new-architecture');
                const inputStorage = document.getElementById('input-new-storage');
                
                if(inputType?.style.display !== 'none' && inputType?.value) data.type = inputType.value;
                if(inputBrand?.style.display !== 'none' && inputBrand?.value) data.brand = inputBrand.value;
                if(inputOS?.style.display !== 'none' && inputOS?.value) data.os = inputOS.value;
                if(inputRAM?.style.display !== 'none' && inputRAM?.value) data.ram = inputRAM.value;
                if(inputProcessor?.style.display !== 'none' && inputProcessor?.value) data.processor = inputProcessor.value;
                if(inputArchitecture?.style.display !== 'none' && inputArchitecture?.value) data.architecture = inputArchitecture.value;
                if(inputStorage?.style.display !== 'none' && inputStorage?.value) data.storage = inputStorage.value;
                
                console.log("[v0] Dispositivo a guardar:", data);
                
                const res = await fetch('/api/devices', { method:'POST', body: JSON.stringify(data) });
                if(res.ok) {
                    alert("Dispositivo creado");
                    document.getElementById('modal-device').classList.add('hidden');
                    this.fetchDevices();
                    this.fetchConfig();
                } else {
                    const err = await res.text();
                    console.log("[v0] Error:", err);
                    alert("Error al crear dispositivo: " + err);
                }
            },
            async saveTicket(fd) {
                const d = Object.fromEntries(fd); 
                d.deviceId = parseInt(d.deviceId);
                
                console.log("[v0] Guardando ticket - Fecha ingreso:", d.fecha);
                
                // Validar fecha
                const today = new Date().toISOString().split('T')[0];
                if(d.fecha > today) {
                    console.log("[v0] Fecha futura rechazada:", d.fecha);
                    alert("La fecha de ingreso no puede ser mayor a hoy");
                    return;
                }
                
                const res = await fetch('/api/tickets', { method:'POST', body: JSON.stringify(d) });
                if(!res.ok) {
                    const err = await res.text();
                    console.log("[v0] Error creando ticket:", err);
                    alert("Error: " + err);
                    return;
                }
                alert("Ticket creado"); 
                document.querySelector('[data-action="close-modals"]').click(); 
                this.fetchTickets();
            },
            async finishTicket(fd) {
                const d = Object.fromEntries(fd); 
                d.id = parseInt(d.id);
                console.log("[v0] Finalizando ticket ID:", d.id, "- Estado:", d.status, "- Fecha salida:", d.date_out);
                
                const res = await fetch('/api/tickets/finish', { method:'POST', body: JSON.stringify(d) });
                if(!res.ok) {
                    console.log("[v0] Error finalizando ticket");
                    alert("Error al finalizar el ticket");
                    return;
                }
                
                console.log("[v0] Ticket finalizado exitosamente");
                document.querySelector('.modal-overlay:not(.hidden)').classList.add('hidden'); 
                this.fetchTickets();
            },
            openFinish(id) {
                const t = this.state.tickets.find(x => x.id === id);
                if(t) { 
                    const f = this.dom['form-finish']; f.reset();
                    f.querySelector('[name=id]').value = id; 
                    f.querySelector('[name=date_out]').value = new Date().toISOString().split('T')[0];
                    this.dom['modal-finish'].classList.remove('hidden'); 
                }
            },
            async fetchPeriod() {
                const res = await fetch('/api/periods/active'); const p = await res.json();
                if(p) {
                    this.state.currentPeriodCode = p.code;
                    document.querySelector('[data-render="current-period"]').textContent = p.code;
                    document.querySelector('[data-render="period-ini"]').textContent = this.fmtDate(p.date_ini);
                    document.querySelector('[data-render="period-end"]').textContent = this.fmtDate(p.date_end);
                    const now = new Date().getTime(), start = new Date(p.date_ini).getTime(), end = new Date(p.date_end).getTime();
                    let pct = ((now-start)/(end-start))*100;
                    if(pct<0) pct=0; if(pct>100) pct=100;
                    document.querySelector('.progress-bar').style.width = `${pct}%`;
                    
                    const allP = await (await fetch('/api/periods')).json();
                    this.dom['tbody-periods'].innerHTML = allP.filter(x => x.code === p.code).map(x => `<tr><td>${x.code}</td><td><input type="date" id="ini-${x.code}" value="${x.date_ini}"></td><td><input type="date" id="end-${x.code}" value="${x.date_end}"></td><td><button class="btn-sm btn-success" onclick="app.updPeriod('${x.code}')">Guardar</button></td></tr>`).join('');
                } else {
                    document.querySelector('[data-render="current-period"]').textContent = "Sin Período";
                    this.dom['tbody-periods'].innerHTML = '<tr><td colspan="4">No hay período activo.</td></tr>';
                }
            },
            async updPeriod(code) {
                const ini = document.getElementById(`ini-${code}`).value, end = document.getElementById(`end-${code}`).value;
                console.log("[v0] Actualizando período", code, "- Inicio:", ini, "- Fin:", end);
                
                // Validar que las fechas sean válidas
                if(!ini || !end) {
                    alert("Las fechas de inicio y fin son obligatorias");
                    return;
                }
                
                const res = await fetch('/api/periods', { method:'PUT', body:JSON.stringify({code, date_ini:ini, date_end:end})});
                if(res.ok) { 
                    console.log("[v0] Período actualizado exitosamente");
                    alert('Período actualizado'); 
                    this.fetchPeriod(); 
                } else { 
                    const t = await res.text(); 
                    console.log("[v0] Error actualizando período:", t);
                    alert('Error: ' + t); 
                }
            },
            async fetchUsers() {
                const res = await fetch('/api/users'); const users = await res.json();
                const admin = users.find(u=>u.role==='admin'), user = users.find(u=>u.role==='user');
                const fa = this.dom['form-settings-admin'], fu = this.dom['form-settings-user'];
                if(admin) { fa.querySelector('[name=fullName]').value = admin.full_name; fa.querySelector('[name=username]').value = admin.username; fa.querySelector('[name=jobTitle]').value = admin.job_title; }
                if(user) { fu.querySelector('[name=fullName]').value = user.full_name; fu.querySelector('[name=username]').value = user.username; fu.querySelector('[name=jobTitle]').value = user.job_title; }
            },
            async updateUser(fd, role) {
                const d = Object.fromEntries(fd); d.targetRole = role;
                const res = await fetch('/api/users', { method:'PUT', body:JSON.stringify(d)});
                if(res.ok) alert('Usuario actualizado'); else alert('Error');
            },
            
            // --- FUNCIÓN DE REPORTE COMPLETA ---
            printReport(mode) {
                const data = mode === 'view' ? this.state.filteredTickets : [...this.state.tickets].sort((a,b) => b.id - a.id);
                if (!data || data.length === 0) { alert("No hay datos para generar el reporte."); return; }

                // Obtener nombres de los inputs de configuración (si están cargados) o usar defaults
                const adminName = document.querySelector('[data-js="form-settings-admin"] [name="fullName"]').value || "OSWALDO GUEDEZ";
                const adminJob = document.querySelector('[data-js="form-settings-admin"] [name="jobTitle"]').value || "JEFE DE ÁREA";
                const coordName = document.querySelector('[data-js="form-settings-user"] [name="fullName"]').value || "FRANCISCO VELAZQUEZ";
                const coordJob = document.querySelector('[data-js="form-settings-user"] [name="jobTitle"]').value || "COORDINADOR TIC";

                const URL_LOGO_IZQUIERDO = './public/logo-fuerzas-armadas.avif'; 
                const URL_LOGO_DERECHO = './public/logo-unefa.avif';

                let reportContent = '';
                const ROWS_PER_PAGE = 12;
                const totalPages = Math.ceil(data.length / ROWS_PER_PAGE);

                for (let i = 0; i < totalPages; i++) {
                    const pageData = data.slice(i * ROWS_PER_PAGE, (i + 1) * ROWS_PER_PAGE);
                    
                    const headerHTML = `
                        <div class="header-container">
                            <div class="logo-box"><img src="${URL_LOGO_IZQUIERDO}" alt="Logo Izq"></div>
                            <div class="header-text">
                                MINISTERIO DEL PODER POPULAR PARA LA DEFENSA<br>
                                UNIVERSIDAD NACIONAL EXPERIMENTAL POLITÉCNICA DE LA FUERZA ARMADA<br>
                                NÚCLEO MIRANDA - SEDE LOS TEQUES<br>
                                COORDINACIÓN DE TECNOLOGÍA Y SOPORTE<br>
                                TECNOLOGÍA, INFORMACIÓN Y COMUNICACIÓN<br>
                                SOPORTE TÉCNICO
                            </div>
                            <div class="logo-box"><img src="${URL_LOGO_DERECHO}" alt="Logo Der"></div>
                        </div>
                        <div class="section-title">REPORTE DE GESTIÓN DE SOPORTE TÉCNICO</div>
                    `;

                    let rowsHTML = '';
                    pageData.forEach((t, idx) => {
                        const num = (i * ROWS_PER_PAGE) + idx + 1;
                        rowsHTML += `
                            <tr>
                                <td class="col-center">${num}</td>
                                <td class="col-center">${this.fmtDate(t.dateIn)}</td>
                                <td class="col-center"><b>${t.code}</b><br>${t.type}</td>
                                <td class="col-center">${t.location}</td>
                                <td class="col-center">${t.dateOut ? this.fmtDate(t.dateOut) : '-'}</td>
                                <td class="col-left" style="font-size:8pt;">${t.solution || t.issue}</td>
                                <td class="col-center" style="font-size:8pt;">${t.status}</td>
                            </tr>
                        `;
                    });

                    let signaturesHTML = '';
                    if (i === totalPages - 1) {
                        signaturesHTML = `
                            <div class="signatures">
                                <div class="sign-box">
                                    <div style="margin-top:5px; margin-bottom:2px; font-weight:normal;">${adminName}</div>
                                    ${adminJob}
                                    <br><span style="font-weight:normal;font-size:8pt;">FIRMA Y SELLO</span>
                                </div>
                                <div class="sign-box">
                                    <div style="margin-top:5px; margin-bottom:2px; font-weight:normal;">${coordName}</div>
                                    ${coordJob}
                                    <br><span style="font-weight:normal;font-size:8pt;">FIRMA Y SELLO</span>
                                </div>
                            </div>
                        `;
                    }

                    reportContent += `
                        <div class="page">
                            ${headerHTML}
                            <table>
                                <thead>
                                    <tr>
                                        <th style="width:5%">N°</th>
                                        <th style="width:10%">FECHA</th>
                                        <th style="width:15%">EQUIPO</th>
                                        <th style="width:15%">UBICACIÓN</th>
                                        <th style="width:10%">SALIDA</th>
                                        <th style="width:35%">DETALLE / SOLUCIÓN</th>
                                        <th style="width:10%">ESTADO</th>
                                    </tr>
                                </thead>
                                <tbody>${rowsHTML}</tbody>
                            </table>
                            ${signaturesHTML}
                            <div class="footer-info">
                                <span>Sistema S.A.R.T.</span>
                                <span>Página ${i + 1} de ${totalPages}</span>
                            </div>
                        </div>
                    `;
                }

                const iframe = document.createElement('iframe');
                iframe.style.position = 'absolute';
                iframe.style.width = '0px';
                iframe.style.height = '0px';
                iframe.style.border = 'none';
                document.body.appendChild(iframe);

                const doc = iframe.contentWindow.document;
                doc.open();
                doc.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Reporte SART</title>
                        <style>
                            @page { size: letter; margin: 0; }
                            body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #ccc; }
                            .page { width: 215.9mm; height: 279.4mm; background: white; margin: 0 auto; padding: 15mm; position: relative; page-break-after: always; overflow: hidden; }
                            .header-container { display: flex; justify-content: space-between; align-items: center; height: 110px; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; overflow: hidden; }
                            .logo-box { width: 90px; height: 90px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
                            .logo-box img { width: 100%; height: 100%; object-fit: contain; }
                            .header-text { flex: 1; text-align: center; font-weight: bold; font-size: 8pt; line-height: 1.2; padding: 0 10px; }
                            .section-title { font-weight: bold; margin-bottom: 10px; font-size: 11pt; text-align: center; text-decoration: underline; }
                            table { width: 100%; border-collapse: collapse; font-size: 9pt; }
                            th, td { border: 1px solid black; padding: 4px; vertical-align: middle; }
                            th { background: #f0f0f0; text-align: center; font-weight: bold; }
                            .col-center { text-align: center; }
                            .col-left { text-align: left; }
                            .signatures { margin-top: 50px; display: flex; justify-content: space-around; }
                            .sign-box { width: 40%; text-align: center; border-top: 1px solid black; padding-top: 5px; font-weight: bold; font-size: 9pt; }
                            .footer-info { position: absolute; bottom: 15mm; left: 15mm; right: 15mm; display: flex; justify-content: space-between; font-size: 8pt; border-top: 1px solid #ccc; padding-top: 5px; }
                        </style>
                    </head>
                    <body>${reportContent}</body>
                    </html>
                `);
                doc.close();

                iframe.contentWindow.focus();
                setTimeout(() => {
                    iframe.contentWindow.print();
                    document.body.removeChild(iframe);
                }, 500);
            },

            renderDash() {
                document.querySelector('[data-js="stat-pending"]').textContent = this.state.tickets.filter(t=>t.status==='Pendiente').length;
                document.querySelector('[data-js="stat-total"]').textContent = this.state.tickets.length;
                document.querySelector('[data-js="stat-repaired"]').textContent = this.state.tickets.filter(t=>t.status==='Reparado').length;
            },
            updateTime() {
                const now = new Date();
                document.querySelector('[data-js="current-date"]').textContent = now.toLocaleDateString();
                document.querySelectorAll('input[type="date"]').forEach(i => { if(!i.value) i.value = now.toISOString().split('T')[0]; });
            },
            initCharCounters() { document.querySelectorAll('textarea[maxlength]').forEach(txt => { const counter = document.createElement('div'); counter.className = 'char-counter'; counter.textContent = `0/${txt.getAttribute('maxlength')}`; txt.parentNode.appendChild(counter); txt.addEventListener('input', () => { counter.textContent = `${txt.value.length}/${txt.getAttribute('maxlength')}`; }); }); },
            validateDates() { const start = this.dom.filterDateStart.value; const end = this.dom.filterDateEnd.value; const today = new Date().toISOString().split('T')[0]; if (start > today || end > today) { alert("Fechas futuras inválidas."); if(start > today) this.dom.filterDateStart.value = ''; if(end > today) this.dom.filterDateEnd.value = ''; return; } if (start && end && start > end) { alert("Fecha incorrecta."); this.dom.filterDateEnd.value = ''; } },
            renderHistory() {
                console.log("[v0] Renderizando historial con filtros...");
                const textF = (this.dom.filterText.value || '').toLowerCase();
                const typeF = this.dom.filterType?.value || '';
                const brandF = this.dom.filterBrand?.value || '';
                const statusF = this.dom.filterStatus?.value || '';
                const buildingF = this.dom.filterBuilding?.value || '';
                const floorF = this.dom.filterFloorH?.value || '';
                const areaF = this.dom.filterAreaH?.value || '';
                const dateStartF = this.dom.filterDateStart?.value || '';
                const dateEndF = this.dom.filterDateEnd?.value || '';
                
                this.state.filteredTickets = this.state.tickets.filter(t => {
                    if(textF && !JSON.stringify(t).toLowerCase().includes(textF)) return false;
                    if(typeF && t.type !== typeF) return false;
                    if(brandF && t.brand !== brandF) return false;
                    if(statusF && t.status !== statusF) return false;
                    if(buildingF && !t.location?.includes(buildingF)) return false;
                    if(floorF && !t.location?.includes(floorF)) return false;
                    if(areaF && !t.location?.includes(areaF)) return false;
                    if(dateStartF && t.dateIn < dateStartF) return false;
                    if(dateEndF && t.dateIn > dateEndF) return false;
                    return true;
                });
                
                console.log("[v0] Historial filtrado:", this.state.filteredTickets.length, "de", this.state.tickets.length);
                this.dom['tbody-history'].innerHTML = this.state.filteredTickets.map(t => `<tr><td><span class="badge ${t.status==='Pendiente'?'pending':t.status==='Reparado'?'repaired':'norepaired'}">${t.status}</span></td><td>${t.code}</td><td>${t.type}</td><td>${t.location}</td><td>${this.fmtDate(t.dateIn)}</td><td>${t.dateOut?this.fmtDate(t.dateOut):'-'}</td><td>${t.solution||t.issue}</td></tr>`).join('');
            },
            renderWorkshop(searchTerm = '') {
                console.log("[v0] Renderizando taller con búsqueda:", searchTerm);
                const pending = this.state.tickets.filter(t => t.status === 'Pendiente');
                const filtered = searchTerm ? pending.filter(t => JSON.stringify(t).toLowerCase().includes(searchTerm.toLowerCase())) : pending;
                
                console.log("[v0] Taller - Mostrando", filtered.length, "de", pending.length, "equipos pendientes");
                this.dom['tbody-workshop'].innerHTML = filtered.map(t => `<tr><td>${t.code}</td><td>${t.type}</td><td>${t.issue}</td><td>${this.fmtDate(t.dateIn)}</td><td><button class="btn-success btn-sm" onclick="app.openFinish(${t.id})">Finalizar</button></td></tr>`).join('');
            },
            fmtDate(s) { if(!s) return '-'; const p = s.split('-'); return `${p[2]}/${p[1]}/${p[0]}`; }
        };
    </script>
</body>
</html>
